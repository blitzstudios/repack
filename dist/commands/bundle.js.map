{"version":3,"file":"bundle.js","names":["_fsExtra","_interopRequireDefault","require","_jsonExt","_webpack","_env","_loadWebpackConfig","_utils","_getWebpackConfigPath","obj","__esModule","default","bundle","_","config","args","webpackConfigPath","getWebpackConfigPath","root","webpackConfig","cliOptions","reactNativePath","command","arguments","verbose","process","argv","includes","env","VERBOSE_ENV_KEY","webpackEnvOptions","getWebpackEnvOptions","loadWebpackConfig","compiler","webpack","Promise","resolve","reject","run","error","stats","console","exit","hasErrors","compilation","errors","forEach","e","json","undefined","log","statOptions","preset","options","statsJson","toJson","outputStream","fs","createWriteStream","stringifyStream","on","pipe","then","close"],"sources":["../../src/commands/bundle.ts"],"sourcesContent":["import { Config } from '@react-native-community/cli-types';\nimport fs from 'fs-extra';\nimport { stringifyStream } from '@discoveryjs/json-ext';\nimport webpack from 'webpack';\nimport { VERBOSE_ENV_KEY } from '../env';\nimport { BundleArguments, CliOptions } from '../types';\nimport { loadWebpackConfig } from '../webpack/loadWebpackConfig';\nimport { getWebpackEnvOptions } from '../webpack/utils';\nimport { getWebpackConfigPath } from './utils/getWebpackConfigPath';\n\n/**\n * Bundle command for React Native CLI.\n * It runs Webpack, builds bundle and saves it alongside any other assets and Source Map\n * to filesystem.\n *\n * @param _ Original, non-parsed arguments that were provided when running this command.\n * @param config React Native CLI configuration object.\n * @param args Parsed command line arguments.\n *\n * @internal\n * @category CLI command\n */\nexport async function bundle(\n  _: string[],\n  config: Config,\n  args: BundleArguments\n) {\n  const webpackConfigPath = getWebpackConfigPath(\n    config.root,\n    args.webpackConfig\n  );\n  const cliOptions = {\n    config: {\n      root: config.root,\n      reactNativePath: config.reactNativePath,\n      webpackConfigPath,\n    },\n    command: 'bundle',\n    arguments: {\n      bundle: args,\n    },\n  } as CliOptions;\n\n  if (args.verbose ?? process.argv.includes('--verbose')) {\n    process.env[VERBOSE_ENV_KEY] = '1';\n  }\n\n  const webpackEnvOptions = getWebpackEnvOptions(cliOptions);\n  const webpackConfig = await loadWebpackConfig(\n    webpackConfigPath,\n    webpackEnvOptions\n  );\n  const compiler = webpack(webpackConfig);\n\n  return new Promise<void>((resolve, reject) => {\n    compiler.run((error, stats) => {\n      if (error) {\n        reject();\n        console.error(error);\n        process.exit(2);\n      } else {\n        if (stats?.hasErrors()) {\n          reject();\n          stats.compilation?.errors?.forEach((e) => {\n            console.error(e);\n          });\n          process.exit(2);\n        }\n\n        if (args.json && stats !== undefined) {\n          console.log(`Writing compiler stats`);\n\n          let statOptions: Parameters<typeof stats.toJson>[0];\n          if (args.stats !== undefined) {\n            statOptions = { preset: args.stats };\n          } else if (typeof compiler.options.stats === 'boolean') {\n            statOptions = compiler.options.stats\n              ? { preset: 'normal' }\n              : { preset: 'none' };\n          } else {\n            statOptions = compiler.options.stats;\n          }\n\n          const statsJson = stats.toJson(statOptions);\n          // Stats can be fairly big at which point their JSON no longer fits into a single string.\n          // Approach was copied from `webpack-cli`: https://github.com/webpack/webpack-cli/blob/c03fb03d0aa73d21f16bd9263fd3109efaf0cd28/packages/webpack-cli/src/webpack-cli.ts#L2471-L2482\n          const outputStream = fs.createWriteStream(args.json);\n\n          stringifyStream(statsJson)\n            .on('error', (error) => {\n              reject();\n              console.error(error);\n              process.exit(2);\n            })\n            .pipe(outputStream)\n            .on('error', (error) => {\n              reject();\n              console.error(error);\n              process.exit(2);\n            })\n            .on('close', () => {\n              console.log(`Wrote compiler stats to ${args.json}`);\n              resolve();\n            });\n        } else {\n          resolve();\n        }\n      }\n    });\n    // eslint-disable-next-line promise/prefer-await-to-then\n  }).then(() => {\n    return new Promise<void>((resolve, reject) => {\n      // make cache work: https://webpack.js.org/api/node/#run\n      compiler.close((error) => {\n        if (error) {\n          reject();\n        } else {\n          resolve();\n        }\n      });\n    });\n  });\n}\n"],"mappings":"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","ignoreList":[]}