{"version":3,"file":"resetPersistentCache.js","names":["_nodeFs","_interopRequireDefault","require","_nodePath","colorette","_interopRequireWildcard","_getRequireWildcardCache","e","WeakMap","r","t","__esModule","default","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","hasOwnProperty","call","i","set","getDefaultCacheDirectory","bundler","rootDir","defaultCacheDir","path","join","getCustomCacheDirectory","candidate","isAbsolute","resolve","getRspackCachePaths","cacheConfigs","cachePaths","Set","cacheConfig","storage","directory","candidateDir","add","getWebpackCachePaths","cacheLocation","dirname","cacheDirectory","resetPersistentCache","warn","msg","console","yellow","cachePath","fs","existsSync","relativeCachePath","relative","startsWith","rmSync","recursive"],"sources":["../../../src/commands/common/resetPersistentCache.ts"],"sourcesContent":["import fs from 'node:fs';\nimport path from 'node:path';\nimport type { Configuration as RspackConfiguration } from '@rspack/core';\nimport * as colorette from 'colorette';\nimport type { Configuration as WebpackConfiguration } from 'webpack';\n\ntype RspackCacheOptions = NonNullable<\n  RspackConfiguration['experiments']\n>['cache'];\ntype WebpackCacheOptions = WebpackConfiguration['cache'];\n\nfunction getDefaultCacheDirectory(\n  bundler: 'rspack' | 'webpack',\n  rootDir: string\n) {\n  const defaultCacheDir = path.join('node_modules', '.cache', bundler);\n  return path.join(rootDir, defaultCacheDir);\n}\n\nfunction getCustomCacheDirectory(candidate: string, rootDir: string): string {\n  if (path.isAbsolute(candidate)) return candidate;\n  return path.resolve(rootDir, candidate);\n}\n\nfunction getRspackCachePaths(\n  rootDir: string,\n  cacheConfigs: RspackCacheOptions[]\n): Set<string> {\n  const cachePaths = new Set<string>();\n\n  for (const cacheConfig of cacheConfigs) {\n    if (\n      typeof cacheConfig === 'object' &&\n      'storage' in cacheConfig &&\n      cacheConfig.storage?.directory\n    ) {\n      const candidateDir = cacheConfig.storage.directory;\n      cachePaths.add(getCustomCacheDirectory(candidateDir, rootDir));\n    } else {\n      cachePaths.add(getDefaultCacheDirectory('rspack', rootDir));\n    }\n  }\n\n  return cachePaths;\n}\n\nfunction getWebpackCachePaths(\n  rootDir: string,\n  cacheConfigs: WebpackCacheOptions[]\n): Set<string> {\n  const cachePaths = new Set<string>();\n\n  for (const cacheConfig of cacheConfigs) {\n    if (\n      typeof cacheConfig === 'object' &&\n      'cacheLocation' in cacheConfig &&\n      cacheConfig.cacheLocation\n    ) {\n      const candidateDir = path.dirname(cacheConfig.cacheLocation);\n      cachePaths.add(getCustomCacheDirectory(candidateDir, rootDir));\n    } else if (\n      typeof cacheConfig === 'object' &&\n      'cacheDirectory' in cacheConfig &&\n      cacheConfig.cacheDirectory\n    ) {\n      const candidateDir = cacheConfig.cacheDirectory;\n      cachePaths.add(getCustomCacheDirectory(candidateDir, rootDir));\n    } else {\n      cachePaths.add(getDefaultCacheDirectory('webpack', rootDir));\n    }\n  }\n\n  return cachePaths;\n}\n\nexport function resetPersistentCache(config: {\n  bundler: 'rspack';\n  rootDir: string;\n  cacheConfigs: RspackCacheOptions[];\n}): void;\n\nexport function resetPersistentCache(config: {\n  bundler: 'webpack';\n  rootDir: string;\n  cacheConfigs: WebpackCacheOptions[];\n}): void;\n\nexport function resetPersistentCache({\n  bundler,\n  rootDir,\n  cacheConfigs,\n}: {\n  bundler: 'rspack' | 'webpack';\n  rootDir: string;\n  cacheConfigs: unknown;\n}) {\n  const cachePaths =\n    bundler === 'rspack'\n      ? getRspackCachePaths(rootDir, cacheConfigs as RspackCacheOptions[])\n      : getWebpackCachePaths(rootDir, cacheConfigs as WebpackCacheOptions[]);\n\n  const warn = (msg: string) => console.warn(colorette.yellow(msg));\n\n  for (const cachePath of cachePaths) {\n    if (!fs.existsSync(cachePath)) continue;\n    const relativeCachePath = path.relative(rootDir, cachePath);\n\n    if (relativeCachePath.startsWith('..')) {\n      warn(\n        `Cache path \"${relativeCachePath}\" is outside of the project directory. ` +\n          'Resetting cache outside of the project directory is not supported. ' +\n          'Please delete the cache directory manually.\\n'\n      );\n      continue;\n    }\n\n    try {\n      fs.rmSync(cachePath, { recursive: true });\n      warn(`Deleted transformation cache at ${relativeCachePath}\\n`);\n    } catch {\n      warn(`Failed to delete cache at ${relativeCachePath}\\n`);\n    }\n  }\n}\n"],"mappings":"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","ignoreList":[]}