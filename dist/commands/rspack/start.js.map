{"version":3,"file":"start.js","names":["_package","_interopRequireDefault","require","_index","_cliError","_makeCompilerConfig","_index2","_logo","_setupEnvironment","_Compiler","e","__esModule","default","start","_","cliConfig","args","detectedPlatforms","Object","keys","platforms","platform","includes","CLIError","configs","makeCompilerConfig","bundler","command","rootDir","root","reactNativePath","setupEnvironment","devServerOptions","devServer","showHttpRequests","verbose","logRequests","reporter","composeReporters","ConsoleReporter","asJson","json","isVerbose","logFile","FileReporter","filename","undefined","filter","Boolean","process","stdout","write","logo","packageJson","version","compiler","Compiler","createServer","stop","options","delegate","ctx","interactive","setupInteractions","onReload","broadcastToMessageClients","method","onOpenDevMenu","onOpenDevTools","fetch","url","catch","log","warn","onAdbReverse","runAdbReverse","port","logger","reversePort","wait","setDevServerContext","getAsset","parsedUrl","parseFileUrl","getSource","getMimeType","inferPlatform","uri","symbolicator","fileUrl","getSourceMap","shouldIncludeFrame","frame","test","file","messages","getHello","getStatus","onMessage","logEntry","makeLogEntryFromFastifyLog","issuer","api","getPlatforms","Promise","resolve","getAssets","entries","assetsCache","map","name","asset","size","getCompilationStats","statsCache"],"sources":["../../../src/commands/rspack/start.ts"],"sourcesContent":["import type { Configuration } from '@rspack/core';\nimport packageJson from '../../../package.json';\nimport {\n  ConsoleReporter,\n  FileReporter,\n  type Reporter,\n  composeReporters,\n  makeLogEntryFromFastifyLog,\n} from '../../logging/index.js';\nimport { CLIError } from '../common/cliError.js';\nimport { makeCompilerConfig } from '../common/config/makeCompilerConfig.js';\nimport {\n  getMimeType,\n  parseFileUrl,\n  setupInteractions,\n} from '../common/index.js';\nimport { runAdbReverse } from '../common/index.js';\nimport logo from '../common/logo.js';\nimport { setupEnvironment } from '../common/setupEnvironment.js';\nimport type { CliConfig, StartArguments } from '../types.js';\nimport { Compiler } from './Compiler.js';\nimport { DevServerOptions } from '@callstack/repack-dev-server';\n\n/**\n * Start command that runs a development server.\n * It runs `@callstack/repack-dev-server` to provide Development Server functionality\n * in development mode.\n *\n * @param _ Original, non-parsed arguments that were provided when running this command.\n * @param cliConfig Configuration object containing platform and project settings.\n * @param args Parsed command line arguments.\n */\nexport async function start(\n  _: string[],\n  cliConfig: CliConfig,\n  args: StartArguments\n) {\n  const detectedPlatforms = Object.keys(cliConfig.platforms);\n\n  if (args.platform && !detectedPlatforms.includes(args.platform)) {\n    throw new CLIError(`Unrecognized platform: ${args.platform}`);\n  }\n\n  const configs = await makeCompilerConfig<Configuration>({\n    args: args,\n    bundler: 'rspack',\n    command: 'start',\n    rootDir: cliConfig.root,\n    platforms: args.platform ? [args.platform] : detectedPlatforms,\n    reactNativePath: cliConfig.reactNativePath,\n  });\n\n  // expose selected args as environment variables\n  setupEnvironment(args);\n\n  const devServerOptions = (configs[0].devServer ?? {}) as DevServerOptions;\n  const showHttpRequests = args.verbose || args.logRequests;\n\n  const reporter = composeReporters(\n    [\n      new ConsoleReporter({ asJson: args.json, isVerbose: args.verbose }),\n      args.logFile ? new FileReporter({ filename: args.logFile }) : undefined,\n    ].filter(Boolean) as Reporter[]\n  );\n\n  process.stdout.write(logo(packageJson.version, 'Rspack'));\n\n  const compiler = new Compiler(configs, reporter, cliConfig.root);\n\n  const { createServer } = await import('@callstack/repack-dev-server');\n  const { start, stop } = await createServer({\n    options: {\n      ...devServerOptions,\n      rootDir: cliConfig.root,\n      logRequests: showHttpRequests,\n    },\n    delegate: (ctx) => {\n      if (args.interactive) {\n        setupInteractions(\n          {\n            onReload() {\n              ctx.broadcastToMessageClients({ method: 'reload' });\n            },\n            onOpenDevMenu() {\n              ctx.broadcastToMessageClients({ method: 'devMenu' });\n            },\n            onOpenDevTools() {\n              fetch(`${ctx.options.url}/open-debugger`, {\n                method: 'POST',\n              }).catch(() => {\n                ctx.log.warn('Failed to open React Native DevTools');\n              });\n            },\n            onAdbReverse() {\n              void runAdbReverse({\n                port: ctx.options.port,\n                logger: ctx.log,\n                verbose: true,\n              });\n            },\n          },\n          { logger: ctx.log }\n        );\n      }\n\n      if (args.reversePort) {\n        void runAdbReverse({\n          logger: ctx.log,\n          port: ctx.options.port,\n          wait: true,\n        });\n      }\n\n      compiler.setDevServerContext(ctx);\n\n      return {\n        compiler: {\n          getAsset: (filename, platform) => {\n            const parsedUrl = parseFileUrl(filename, 'file:///');\n            return compiler.getSource(parsedUrl.filename, platform);\n          },\n          getMimeType: (filename) => getMimeType(filename),\n          inferPlatform: (uri) => {\n            const { platform } = parseFileUrl(uri, 'file:///');\n            return platform;\n          },\n        },\n        symbolicator: {\n          getSource: (fileUrl) => {\n            const { filename, platform } = parseFileUrl(fileUrl);\n            return compiler.getSource(filename, platform);\n          },\n          getSourceMap: (fileUrl) => {\n            const { filename, platform } = parseFileUrl(fileUrl);\n            return compiler.getSourceMap(filename, platform);\n          },\n          shouldIncludeFrame: (frame) => {\n            // If the frame points to internal bootstrap/module system logic, skip the code frame.\n            return !/webpack[/\\\\]runtime[/\\\\].+\\s/.test(frame.file);\n          },\n        },\n        messages: {\n          getHello: () => 'React Native packager is running',\n          getStatus: () => 'packager-status:running',\n        },\n        logger: {\n          onMessage: (log) => {\n            const logEntry = makeLogEntryFromFastifyLog(log);\n            logEntry.issuer = 'DevServer';\n            reporter.process(logEntry);\n          },\n        },\n        api: {\n          getPlatforms: () => Promise.resolve(compiler.platforms),\n          getAssets: (platform) =>\n            Promise.resolve(\n              Object.entries(compiler.assetsCache[platform] ?? {}).map(\n                ([name, asset]) => ({ name, size: asset.size })\n              )\n            ),\n          getCompilationStats: (platform) =>\n            Promise.resolve(compiler.statsCache[platform] ?? null),\n        },\n      };\n    },\n  });\n\n  await start();\n  compiler.start();\n\n  return {\n    stop: async () => {\n      reporter.stop();\n      await stop();\n    },\n  };\n}\n"],"mappings":"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","ignoreList":[]}