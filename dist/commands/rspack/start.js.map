{"version":3,"file":"start.js","names":["colorette","_interopRequireWildcard","require","_package","_interopRequireDefault","_logging","_common","_consts","_Compiler","e","__esModule","default","_getRequireWildcardCache","WeakMap","r","t","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","hasOwnProperty","call","i","set","start","_","cliConfig","args","rspackConfigPath","getRspackConfigFilePath","root","webpackConfig","reversePort","reversePortArg","restArgs","cliOptions","config","platforms","keys","bundlerConfigPath","reactNativePath","command","arguments","platform","includes","Error","process","argv","isSilent","silent","isVerbose","verbose","showHttpRequests","logRequests","reporter","composeReporters","ConsoleReporter","asJson","json","level","logFile","FileReporter","filename","undefined","filter","Boolean","version","packageJson","stdout","write","bold","cyan","compiler","Compiler","serverHost","host","DEFAULT_HOSTNAME","serverPort","port","DEFAULT_PORT","serverURL","https","createServer","stop","options","rootDir","cert","key","experiments","experimentalDebugger","delegate","ctx","interactive","setupInteractions","onReload","broadcastToMessageClients","method","onOpenDevMenu","onOpenDevTools","fetch","log","runAdbReverse","setDevServerContext","getAsset","parsedUrl","parseFileUrl","getSource","getMimeType","inferPlatform","uri","symbolicator","fileUrl","getSourceMap","shouldIncludeFrame","frame","test","file","hmr","getUriPath","onClientConnected","clientId","broadcastToHmrClients","action","body","getHmrBody","messages","getHello","getStatus","logger","onMessage","logEntry","makeLogEntryFromFastifyLog","issuer","api","getPlatforms","Promise","resolve","getAssets","entries","assetsCache","map","name","asset","size","getCompilationStats","statsCache","init"],"sources":["../../../src/commands/rspack/start.ts"],"sourcesContent":["import type { Config } from '@react-native-community/cli-types';\nimport * as colorette from 'colorette';\nimport packageJson from '../../../package.json';\nimport {\n  ConsoleReporter,\n  FileReporter,\n  type Reporter,\n  composeReporters,\n  makeLogEntryFromFastifyLog,\n} from '../../logging';\nimport {\n  getMimeType,\n  getRspackConfigFilePath,\n  parseFileUrl,\n  runAdbReverse,\n  setupInteractions,\n} from '../common';\nimport { DEFAULT_HOSTNAME, DEFAULT_PORT } from '../consts';\nimport type { StartArguments, StartCliOptions } from '../types';\nimport { Compiler } from './Compiler';\n\n/**\n * Start command for React Native Community CLI.\n * It runs `@callstack/repack-dev-server` to provide Development Server functionality to React Native apps\n * in development mode.\n *\n * @param _ Original, non-parsed arguments that were provided when running this command.\n * @param config React Native Community CLI configuration object.\n * @param args Parsed command line arguments.\n *\n * @internal\n * @category CLI command\n */\nexport async function start(\n  _: string[],\n  cliConfig: Config,\n  args: StartArguments\n) {\n  const rspackConfigPath = getRspackConfigFilePath(\n    cliConfig.root,\n    args.webpackConfig\n  );\n  const { reversePort: reversePortArg, ...restArgs } = args;\n  const cliOptions: StartCliOptions = {\n    config: {\n      root: cliConfig.root,\n      platforms: Object.keys(cliConfig.platforms),\n      bundlerConfigPath: rspackConfigPath,\n      reactNativePath: cliConfig.reactNativePath,\n    },\n    command: 'start',\n    arguments: { start: { ...restArgs } },\n  };\n\n  if (args.platform && !cliOptions.config.platforms.includes(args.platform)) {\n    throw new Error('Unrecognized platform: ' + args.platform);\n  }\n\n  const reversePort = reversePortArg ?? process.argv.includes('--reverse-port');\n  const isSilent = args.silent;\n  const isVerbose = isSilent\n    ? false\n    : // TODO fix (jbroma)\n      // biome-ignore format: fix in a separate PR\n      args.verbose ?? process.argv.includes('--verbose');\n\n  const showHttpRequests = isVerbose || args.logRequests;\n  const reporter = composeReporters(\n    [\n      new ConsoleReporter({\n        asJson: args.json,\n        level: isSilent ? 'silent' : isVerbose ? 'verbose' : 'normal',\n      }),\n      args.logFile ? new FileReporter({ filename: args.logFile }) : undefined,\n    ].filter(Boolean) as Reporter[]\n  );\n\n  if (!isSilent) {\n    const version = packageJson.version;\n    process.stdout.write(\n      colorette.bold(colorette.cyan('ðŸ“¦ Re.Pack ' + version + '\\n\\n'))\n    );\n  }\n\n  // @ts-ignore\n  const compiler = new Compiler(cliOptions, reporter);\n\n  const serverHost = args.host || DEFAULT_HOSTNAME;\n  const serverPort = args.port ?? DEFAULT_PORT;\n  const serverURL = `${args.https === true ? 'https' : 'http'}://${serverHost}:${serverPort}`;\n  const { createServer } = await import('@callstack/repack-dev-server');\n  const { start, stop } = await createServer({\n    options: {\n      rootDir: cliOptions.config.root,\n      host: serverHost,\n      port: serverPort,\n      https: args.https\n        ? {\n            cert: args.cert,\n            key: args.key,\n          }\n        : undefined,\n      logRequests: showHttpRequests,\n    },\n    experiments: {\n      experimentalDebugger: args.experimentalDebugger,\n    },\n    delegate: (ctx) => {\n      if (args.interactive) {\n        setupInteractions(\n          {\n            onReload() {\n              ctx.broadcastToMessageClients({ method: 'reload' });\n            },\n            onOpenDevMenu() {\n              ctx.broadcastToMessageClients({ method: 'devMenu' });\n            },\n            onOpenDevTools() {\n              void fetch(`${serverURL}/open-debugger`, {\n                method: 'POST',\n              });\n            },\n          },\n          ctx.log\n        );\n      }\n\n      if (reversePort && args.port) {\n        void runAdbReverse(args.port, ctx.log);\n      }\n\n      compiler.setDevServerContext(ctx);\n\n      return {\n        compiler: {\n          getAsset: (filename, platform) => {\n            const parsedUrl = parseFileUrl(filename, 'file:///');\n            return compiler.getSource(parsedUrl.filename, platform);\n          },\n          getMimeType: (filename) => getMimeType(filename),\n          inferPlatform: (uri) => {\n            const { platform } = parseFileUrl(uri, 'file:///');\n            return platform;\n          },\n        },\n        symbolicator: {\n          getSource: (fileUrl) => {\n            const { filename, platform } = parseFileUrl(fileUrl);\n            return compiler.getSource(filename, platform);\n          },\n          getSourceMap: (fileUrl) => {\n            const { filename, platform } = parseFileUrl(fileUrl);\n            return compiler.getSourceMap(filename, platform);\n          },\n          shouldIncludeFrame: (frame) => {\n            // If the frame points to internal bootstrap/module system logic, skip the code frame.\n            return !/webpack[/\\\\]runtime[/\\\\].+\\s/.test(frame.file);\n          },\n        },\n        hmr: {\n          getUriPath: () => '/__hmr',\n          onClientConnected: (platform, clientId) => {\n            ctx.broadcastToHmrClients(\n              { action: 'sync', body: compiler.getHmrBody(platform) },\n              platform,\n              [clientId]\n            );\n          },\n        },\n        messages: {\n          getHello: () => 'React Native packager is running',\n          getStatus: () => 'packager-status:running',\n        },\n        logger: {\n          onMessage: (log) => {\n            const logEntry = makeLogEntryFromFastifyLog(log);\n            logEntry.issuer = 'DevServer';\n            reporter.process(logEntry);\n          },\n        },\n        api: {\n          getPlatforms: () => Promise.resolve(compiler.platforms),\n          getAssets: (platform) =>\n            Promise.resolve(\n              Object.entries(compiler.assetsCache[platform] ?? {}).map(\n                ([name, asset]) => ({ name, size: asset.size })\n              )\n            ),\n          getCompilationStats: (platform) =>\n            Promise.resolve(compiler.statsCache[platform] ?? null),\n        },\n      };\n    },\n  });\n\n  await compiler.init();\n  await start();\n\n  compiler.start();\n\n  return {\n    stop: async () => {\n      reporter.stop();\n      await stop();\n    },\n  };\n}\n"],"mappings":"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","ignoreList":[]}