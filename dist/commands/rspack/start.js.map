{"version":3,"file":"start.js","names":["_path","_interopRequireDefault","require","_package","_index","_cliError","_makeCompilerConfig","_index2","_logo","_setupEnvironment","_Compiler","e","__esModule","default","start","_","cliConfig","args","sendEvents","sendEventsArg","detectedPlatforms","Object","keys","platforms","platform","includes","CLIError","configs","makeCompilerConfig","bundler","command","rootDir","root","reactNativePath","setupEnvironment","devServerOptions","devServer","showHttpRequests","verbose","logRequests","reporter","composeReporters","ConsoleReporter","asJson","json","isVerbose","logFile","FileReporter","filename","undefined","filter","Boolean","process","stdout","write","logo","packageJson","version","resetCache","resetPersistentCache","cacheConfigs","map","config","experiments","cache","env","RSPACK_PROFILE","applyProfile","RSPACK_TRACE_LAYER","RSPACK_TRACE_OUTPUT","compiler","Compiler","createServer","stop","options","host","delegate","ctx","interactive","setupInteractions","onReload","broadcastToMessageClients","method","onOpenDevMenu","onOpenDevTools","fetch","url","catch","log","warn","onAdbReverse","runAdbReverse","port","logger","reversePort","wait","setDevServerContext","getAsset","parsedUrl","parseFileUrl","getSource","getMimeType","inferPlatform","uri","symbolicator","fileUrl","getSourceMap","shouldIncludeFrame","frame","test","file","messages","getHello","getStatus","onMessage","logEntry","makeLogEntryFromFastifyLog","issuer","api","getPlatforms","Promise","resolve","getAssets","entries","assetsCache","name","asset","size","getCompilationStats","statsCache","sendEventsStop","sendEventsPath","path","join"],"sources":["../../../src/commands/rspack/start.ts"],"sourcesContent":["import path from 'path';\nimport type { Configuration } from '@rspack/core';\nimport packageJson from '../../../package.json';\nimport {\n  ConsoleReporter,\n  FileReporter,\n  type Reporter,\n  composeReporters,\n  makeLogEntryFromFastifyLog,\n} from '../../logging/index.js';\nimport { CLIError } from '../common/cliError.js';\nimport { makeCompilerConfig } from '../common/config/makeCompilerConfig.js';\nimport {\n  getMimeType,\n  parseFileUrl,\n  resetPersistentCache,\n  setupInteractions,\n} from '../common/index.js';\nimport { runAdbReverse } from '../common/index.js';\nimport logo from '../common/logo.js';\nimport { setupEnvironment } from '../common/setupEnvironment.js';\nimport type { CliConfig, StartArguments } from '../types.js';\nimport { Compiler } from './Compiler.js';\nimport { DevServerOptions } from '@callstack/repack-dev-server';\n\n/**\n * Start command that runs a development server.\n * It runs `@callstack/repack-dev-server` to provide Development Server functionality\n * in development mode.\n *\n * @param _ Original, non-parsed arguments that were provided when running this command.\n * @param cliConfig Configuration object containing platform and project settings.\n * @param args Parsed command line arguments.\n */\nexport async function start(\n  _: string[],\n  cliConfig: CliConfig,\n  args: StartArguments\n) {\n  const { sendEvents: sendEventsArg } = args;\n  const detectedPlatforms = Object.keys(cliConfig.platforms);\n\n  if (args.platform && !detectedPlatforms.includes(args.platform)) {\n    throw new CLIError(`Unrecognized platform: ${args.platform}`);\n  }\n\n  const configs = await makeCompilerConfig<Configuration>({\n    args: args,\n    bundler: 'rspack',\n    command: 'start',\n    rootDir: cliConfig.root,\n    platforms: args.platform ? [args.platform] : detectedPlatforms,\n    reactNativePath: cliConfig.reactNativePath,\n  });\n\n  // expose selected args as environment variables\n  setupEnvironment(args);\n\n  const devServerOptions = (configs[0].devServer ?? {}) as DevServerOptions;\n  const showHttpRequests = args.verbose || args.logRequests;\n\n  const reporter = composeReporters(\n    [\n      new ConsoleReporter({ asJson: args.json, isVerbose: args.verbose }),\n      args.logFile ? new FileReporter({ filename: args.logFile }) : undefined,\n    ].filter(Boolean) as Reporter[]\n  );\n\n  process.stdout.write(logo(packageJson.version, 'Rspack'));\n\n  if (args.resetCache) {\n    resetPersistentCache({\n      bundler: 'rspack',\n      rootDir: cliConfig.root,\n      cacheConfigs: configs.map((config) => config.experiments?.cache),\n    });\n  }\n\n  if (process.env.RSPACK_PROFILE) {\n    const { applyProfile } = await import('./profile.js');\n    await applyProfile(\n      process.env.RSPACK_PROFILE,\n      process.env.RSPACK_TRACE_LAYER,\n      process.env.RSPACK_TRACE_OUTPUT\n    );\n  }\n\n  const compiler = new Compiler(configs, reporter, cliConfig.root);\n\n  const { createServer } = await import('@callstack/repack-dev-server');\n  const { start, stop } = await createServer({\n    options: {\n      ...devServerOptions,\n      host: '0.0.0.0',\n      rootDir: cliConfig.root,\n      logRequests: showHttpRequests,\n    },\n    delegate: (ctx) => {\n      if (args.interactive) {\n        setupInteractions(\n          {\n            onReload() {\n              ctx.broadcastToMessageClients({ method: 'reload' });\n            },\n            onOpenDevMenu() {\n              ctx.broadcastToMessageClients({ method: 'devMenu' });\n            },\n            onOpenDevTools() {\n              fetch(`${ctx.options.url}/open-debugger`, {\n                method: 'POST',\n              }).catch(() => {\n                ctx.log.warn('Failed to open React Native DevTools');\n              });\n            },\n            onAdbReverse() {\n              void runAdbReverse({\n                port: ctx.options.port,\n                logger: ctx.log,\n                verbose: true,\n              });\n            },\n          },\n          { logger: ctx.log }\n        );\n      }\n\n      if (args.reversePort) {\n        void runAdbReverse({\n          logger: ctx.log,\n          port: ctx.options.port,\n          wait: true,\n        });\n      }\n\n      compiler.setDevServerContext(ctx);\n\n      return {\n        compiler: {\n          getAsset: (filename, platform) => {\n            const parsedUrl = parseFileUrl(filename, 'file:///');\n            return compiler.getSource(parsedUrl.filename, platform);\n          },\n          getMimeType: (filename) => getMimeType(filename),\n          inferPlatform: (uri) => {\n            const { platform } = parseFileUrl(uri, 'file:///');\n            return platform;\n          },\n        },\n        symbolicator: {\n          getSource: (fileUrl) => {\n            const { filename, platform } = parseFileUrl(fileUrl);\n            return compiler.getSource(filename, platform);\n          },\n          getSourceMap: (fileUrl) => {\n            const { filename, platform } = parseFileUrl(fileUrl);\n            return compiler.getSourceMap(filename, platform);\n          },\n          shouldIncludeFrame: (frame) => {\n            // If the frame points to internal bootstrap/module system logic, skip the code frame.\n            return !/webpack[/\\\\]runtime[/\\\\].+\\s/.test(frame.file);\n          },\n        },\n        messages: {\n          getHello: () => 'React Native packager is running',\n          getStatus: () => 'packager-status:running',\n        },\n        logger: {\n          onMessage: (log) => {\n            const logEntry = makeLogEntryFromFastifyLog(log);\n            logEntry.issuer = 'DevServer';\n            reporter.process(logEntry);\n          },\n        },\n        api: {\n          getPlatforms: () => Promise.resolve(compiler.platforms),\n          getAssets: (platform) =>\n            Promise.resolve(\n              Object.entries(compiler.assetsCache[platform] ?? {}).map(\n                ([name, asset]) => ({ name, size: asset.size })\n              )\n            ),\n          getCompilationStats: (platform) =>\n            Promise.resolve(compiler.statsCache[platform] ?? null),\n        },\n      };\n    },\n  });\n\n  await start();\n  compiler.start();\n\n  let sendEventsStop = () => {};\n  if (sendEventsArg) {\n    const sendEventsPath = path.join(cliConfig.root, sendEventsArg);\n    const { default: sendEvents } = await import(sendEventsPath);\n    sendEventsStop = await sendEvents(cliConfig.root);\n  }\n\n  return {\n    stop: async () => {\n      reporter.stop();\n      sendEventsStop();\n      await stop();\n    },\n  };\n}\n"],"mappings":"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","ignoreList":[]}