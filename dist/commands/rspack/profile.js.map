{"version":3,"file":"profile.js","names":["_nodeFs","_interopRequireDefault","require","_nodePath","_core","e","__esModule","default","overviewTraceFilter","allTraceFilter","defaultRustTraceLayer","resolveLayer","value","applyProfile","filterValue","traceLayer","traceOutput","asyncExitHook","Error","timestamp","Date","now","defaultOutputDir","path","resolve","process","pid","defaultRustTraceChromeOutput","join","defaultRustTraceLoggerOutput","defaultTraceOutput","filter","ensureFileDir","rspack","experiments","globalTrace","register","cleanup","wait","outputFilePath","dir","dirname","fs","promises","mkdir","recursive"],"sources":["../../../src/commands/rspack/profile.ts"],"sourcesContent":["/**\n * Reference: https://github.com/web-infra-dev/rspack/blob/bad70431988d77d8a95320066f72c77b6cc4c120/packages/rspack-cli/src/utils/profile.ts\n */\n\n/**\n * `RSPACK_PROFILE=ALL` // all trace events\n * `RSPACK_PROFILE=OVERVIEW` // overview trace events\n * `RSPACK_PROFILE=warn,tokio::net=info` // trace filter from  https://docs.rs/tracing-subscriber/latest/tracing_subscriber/filter/struct.EnvFilter.html#example-syntax\n */\nimport fs from 'node:fs';\nimport path from 'node:path';\nimport { rspack } from '@rspack/core';\n\nconst overviewTraceFilter = 'info';\nconst allTraceFilter = 'trace';\nconst defaultRustTraceLayer = 'chrome';\n\nfunction resolveLayer(value: string) {\n  if (value === 'OVERVIEW') {\n    return overviewTraceFilter;\n  }\n  if (value === 'ALL') {\n    return allTraceFilter;\n  }\n  return value;\n}\n\nexport async function applyProfile(\n  filterValue: string,\n  traceLayer: string = defaultRustTraceLayer,\n  traceOutput?: string\n) {\n  const { asyncExitHook } = await import('exit-hook');\n\n  if (traceLayer !== 'chrome' && traceLayer !== 'logger') {\n    throw new Error(`unsupported trace layer: ${traceLayer}`);\n  }\n\n  if (!traceOutput) {\n    const timestamp = Date.now();\n    const defaultOutputDir = path.resolve(\n      `.rspack-profile-${timestamp}-${process.pid}`\n    );\n    const defaultRustTraceChromeOutput = path.join(\n      defaultOutputDir,\n      'trace.json'\n    );\n    const defaultRustTraceLoggerOutput = 'stdout';\n\n    const defaultTraceOutput =\n      traceLayer === 'chrome'\n        ? defaultRustTraceChromeOutput\n        : defaultRustTraceLoggerOutput;\n\n    // biome-ignore lint/style/noParameterAssign: setting default value makes sense\n    traceOutput = defaultTraceOutput;\n  }\n\n  const filter = resolveLayer(filterValue);\n\n  await ensureFileDir(traceOutput);\n  await rspack.experiments.globalTrace.register(\n    filter,\n    traceLayer,\n    traceOutput\n  );\n  asyncExitHook(rspack.experiments.globalTrace.cleanup, {\n    wait: 500,\n  });\n}\n\nasync function ensureFileDir(outputFilePath: string) {\n  const dir = path.dirname(outputFilePath);\n  await fs.promises.mkdir(dir, { recursive: true });\n}\n"],"mappings":";;;;;;AASA,IAAAA,OAAA,GAAAC,sBAAA,CAAAC,OAAA;AACA,IAAAC,SAAA,GAAAF,sBAAA,CAAAC,OAAA;AACA,IAAAE,KAAA,GAAAF,OAAA;AAAsC,SAAAD,uBAAAI,CAAA,WAAAA,CAAA,IAAAA,CAAA,CAAAC,UAAA,GAAAD,CAAA,KAAAE,OAAA,EAAAF,CAAA;AAXtC;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAKA,MAAMG,mBAAmB,GAAG,MAAM;AAClC,MAAMC,cAAc,GAAG,OAAO;AAC9B,MAAMC,qBAAqB,GAAG,QAAQ;AAEtC,SAASC,YAAYA,CAACC,KAAa,EAAE;EACnC,IAAIA,KAAK,KAAK,UAAU,EAAE;IACxB,OAAOJ,mBAAmB;EAC5B;EACA,IAAII,KAAK,KAAK,KAAK,EAAE;IACnB,OAAOH,cAAc;EACvB;EACA,OAAOG,KAAK;AACd;AAEO,eAAeC,YAAYA,CAChCC,WAAmB,EACnBC,UAAkB,GAAGL,qBAAqB,EAC1CM,WAAoB,EACpB;EACA,MAAM;IAAEC;EAAc,CAAC,GAAG,MAAM,MAAM,CAAC,WAAW,CAAC;EAEnD,IAAIF,UAAU,KAAK,QAAQ,IAAIA,UAAU,KAAK,QAAQ,EAAE;IACtD,MAAM,IAAIG,KAAK,CAAC,4BAA4BH,UAAU,EAAE,CAAC;EAC3D;EAEA,IAAI,CAACC,WAAW,EAAE;IAChB,MAAMG,SAAS,GAAGC,IAAI,CAACC,GAAG,CAAC,CAAC;IAC5B,MAAMC,gBAAgB,GAAGC,iBAAI,CAACC,OAAO,CACnC,mBAAmBL,SAAS,IAAIM,OAAO,CAACC,GAAG,EAC7C,CAAC;IACD,MAAMC,4BAA4B,GAAGJ,iBAAI,CAACK,IAAI,CAC5CN,gBAAgB,EAChB,YACF,CAAC;IACD,MAAMO,4BAA4B,GAAG,QAAQ;IAE7C,MAAMC,kBAAkB,GACtBf,UAAU,KAAK,QAAQ,GACnBY,4BAA4B,GAC5BE,4BAA4B;;IAElC;IACAb,WAAW,GAAGc,kBAAkB;EAClC;EAEA,MAAMC,MAAM,GAAGpB,YAAY,CAACG,WAAW,CAAC;EAExC,MAAMkB,aAAa,CAAChB,WAAW,CAAC;EAChC,MAAMiB,YAAM,CAACC,WAAW,CAACC,WAAW,CAACC,QAAQ,CAC3CL,MAAM,EACNhB,UAAU,EACVC,WACF,CAAC;EACDC,aAAa,CAACgB,YAAM,CAACC,WAAW,CAACC,WAAW,CAACE,OAAO,EAAE;IACpDC,IAAI,EAAE;EACR,CAAC,CAAC;AACJ;AAEA,eAAeN,aAAaA,CAACO,cAAsB,EAAE;EACnD,MAAMC,GAAG,GAAGjB,iBAAI,CAACkB,OAAO,CAACF,cAAc,CAAC;EACxC,MAAMG,eAAE,CAACC,QAAQ,CAACC,KAAK,CAACJ,GAAG,EAAE;IAAEK,SAAS,EAAE;EAAK,CAAC,CAAC;AACnD","ignoreList":[]}