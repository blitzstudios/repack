{"version":3,"file":"bundle.js","names":["_core","require","_cliError","_makeCompilerConfig","_index","_setupEnvironment","bundle","_","cliConfig","args","config","makeCompilerConfig","bundler","command","rootDir","root","platforms","platform","reactNativePath","setupEnvironment","entryFile","entry","CLIError","resetCache","resetPersistentCache","cacheConfigs","experiments","cache","errorHandler","error","stats","message","hasErrors","compilation","errors","forEach","e","console","process","exit","json","undefined","statsOptions","normalizeStatsOptions","compiler","options","statsJson","toJson","writeStats","filepath","context","String","rspack","Promise","resolve","watch","hooks","watchClose","tap","watchOptions","run","close","closeErr"],"sources":["../../../src/commands/rspack/bundle.ts"],"sourcesContent":["import { type Configuration, rspack } from '@rspack/core';\nimport type { Stats } from '@rspack/core';\nimport { CLIError } from '../common/cliError.js';\nimport { makeCompilerConfig } from '../common/config/makeCompilerConfig.js';\nimport {\n  normalizeStatsOptions,\n  resetPersistentCache,\n  writeStats,\n} from '../common/index.js';\nimport { setupEnvironment } from '../common/setupEnvironment.js';\nimport type { BundleArguments, CliConfig } from '../types.js';\n\n/**\n * Bundle command that builds and saves the bundle\n * alongside any other assets to filesystem using Webpack.\n *\n * @param _ Original, non-parsed arguments that were provided when running this command.\n * @param cliConfig Configuration object containing platform and project settings.\n * @param args Parsed command line arguments.\n */\nexport async function bundle(\n  _: string[],\n  cliConfig: CliConfig,\n  args: BundleArguments\n) {\n  const [config] = await makeCompilerConfig<Configuration>({\n    args: args,\n    bundler: 'rspack',\n    command: 'bundle',\n    rootDir: cliConfig.root,\n    platforms: [args.platform],\n    reactNativePath: cliConfig.reactNativePath,\n  });\n\n  // expose selected args as environment variables\n  setupEnvironment(args);\n\n  if (!args.entryFile && !config.entry) {\n    throw new CLIError(\"Option '--entry-file <path>' argument is missing\");\n  }\n\n  if (args.resetCache) {\n    resetPersistentCache({\n      bundler: 'rspack',\n      rootDir: cliConfig.root,\n      cacheConfigs: [config.experiments?.cache],\n    });\n  }\n\n  const errorHandler = async (error: Error | null, stats?: Stats) => {\n    if (error) {\n      throw new CLIError(error.message);\n    }\n\n    if (stats?.hasErrors()) {\n      stats.compilation?.errors?.forEach((e) => {\n        console.error(e);\n      });\n      process.exit(2);\n    }\n\n    if (args.json && stats !== undefined) {\n      const statsOptions = normalizeStatsOptions(\n        compiler.options.stats,\n        args.stats\n      );\n\n      const statsJson = stats.toJson(statsOptions);\n\n      try {\n        await writeStats(statsJson, {\n          filepath: args.json,\n          rootDir: compiler.context,\n        });\n      } catch (e) {\n        throw new CLIError(String(e));\n      }\n    }\n  };\n\n  const compiler = rspack(config);\n\n  return new Promise<void>((resolve) => {\n    if (args.watch) {\n      compiler.hooks.watchClose.tap('bundle', resolve);\n      compiler.watch(config.watchOptions ?? {}, errorHandler);\n    } else {\n      compiler.run((error, stats) => {\n        // make cache work: https://webpack.js.org/api/node/#run\n        compiler.close(async (closeErr) => {\n          if (closeErr) console.error(closeErr);\n          await errorHandler(error, stats);\n          resolve();\n        });\n      });\n    }\n  });\n}\n"],"mappings":"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","ignoreList":[]}