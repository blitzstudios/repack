{"version":3,"file":"bundle.js","names":["_core","require","_env","_common","bundle","_","cliConfig","args","rspackConfigPath","getRspackConfigFilePath","root","webpackConfig","cliOptions","config","platforms","Object","keys","bundlerConfigPath","reactNativePath","command","arguments","entryFile","Error","verbose","process","argv","includes","env","VERBOSE_ENV_KEY","envOptions","getEnvOptions","loadConfig","errorHandler","error","stats","console","exit","hasErrors","compilation","errors","forEach","e","json","undefined","statsOptions","normalizeStatsOptions","compiler","options","statsJson","toJson","writeStats","filepath","rootDir","context","String","rspack","Promise","resolve","watch","hooks","watchClose","tap","watchOptions","run","close","closeErr"],"sources":["../../../src/commands/rspack/bundle.ts"],"sourcesContent":["import type { Config } from '@react-native-community/cli-types';\nimport { type Configuration, rspack } from '@rspack/core';\nimport type { Stats } from '@rspack/core';\nimport { VERBOSE_ENV_KEY } from '../../env';\nimport {\n  getEnvOptions,\n  getRspackConfigFilePath,\n  loadConfig,\n  normalizeStatsOptions,\n  writeStats,\n} from '../common';\nimport type { BundleArguments, BundleCliOptions } from '../types';\n\n/**\n * Bundle command for React Native Community CLI.\n * It runs Rspack, builds bundle and saves it alongside any other assets and Source Map\n * to filesystem.\n *\n * @param _ Original, non-parsed arguments that were provided when running this command.\n * @param config React Native Community CLI configuration object.\n * @param args Parsed command line arguments.\n *\n * @internal\n * @category CLI command\n */\nexport async function bundle(\n  _: string[],\n  cliConfig: Config,\n  args: BundleArguments\n) {\n  const rspackConfigPath = getRspackConfigFilePath(\n    cliConfig.root,\n    args.webpackConfig\n  );\n\n  const cliOptions: BundleCliOptions = {\n    config: {\n      root: cliConfig.root,\n      platforms: Object.keys(cliConfig.platforms),\n      bundlerConfigPath: rspackConfigPath,\n      reactNativePath: cliConfig.reactNativePath,\n    },\n    command: 'bundle',\n    arguments: { bundle: args },\n  };\n\n  if (!args.entryFile) {\n    throw new Error(\"Option '--entry-file <path>' argument is missing\");\n  }\n\n  if (args.verbose ?? process.argv.includes('--verbose')) {\n    process.env[VERBOSE_ENV_KEY] = '1';\n  }\n\n  const envOptions = getEnvOptions(cliOptions);\n  const config = await loadConfig<Configuration>(rspackConfigPath, envOptions);\n\n  const errorHandler = async (error: Error | null, stats?: Stats) => {\n    if (error) {\n      console.error(error);\n      process.exit(2);\n    }\n\n    if (stats?.hasErrors()) {\n      stats.compilation?.errors?.forEach((e) => {\n        console.error(e);\n      });\n      process.exit(2);\n    }\n\n    if (args.json && stats !== undefined) {\n      const statsOptions = normalizeStatsOptions(\n        compiler.options.stats,\n        args.stats\n      );\n\n      const statsJson = stats.toJson(statsOptions);\n\n      try {\n        await writeStats(statsJson, {\n          filepath: args.json,\n          rootDir: compiler.context,\n        });\n      } catch (e) {\n        console.error(String(e));\n        process.exit(2);\n      }\n    }\n  };\n\n  const compiler = rspack(config);\n\n  return new Promise<void>((resolve) => {\n    if (args.watch) {\n      compiler.hooks.watchClose.tap('bundle', resolve);\n      compiler.watch(config.watchOptions ?? {}, errorHandler);\n    } else {\n      compiler.run((error, stats) => {\n        // make cache work: https://webpack.js.org/api/node/#run\n        compiler.close(async (closeErr) => {\n          if (closeErr) console.error(closeErr);\n          await errorHandler(error, stats);\n          resolve();\n        });\n      });\n    }\n  });\n}\n"],"mappings":"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","ignoreList":[]}