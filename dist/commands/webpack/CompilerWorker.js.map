{"version":3,"file":"CompilerWorker.js","names":["_nodePath","_interopRequireDefault","require","_nodeWorker_threads","_memfs","_webpack","_makeCompilerConfig","_index","e","__esModule","default","postMessage","message","parentPort","main","opts","config","makeCompilerConfig","args","bundler","command","rootDir","platforms","platform","reactNativePath","plugins","concat","webpack","ProgressPlugin","entries","dependencies","modules","handler","percentage","text","completed","total","exec","event","Number","parseInt","label","compiler","fileSystem","memfs","createFsFromVolume","Volume","outputFileSystem","hooks","watchRun","tap","invalid","done","stats","compilerStats","toJson","all","assets","children","outputPath","timings","hash","errors","warnings","outputDirectory","compilerAssets","filter","asset","type","reduce","acc","name","info","size","assetPath","path","join","data","readFileSync","adaptFilenameToPlatform","related","sourceMap","sourceMapName","Array","isArray","sourceMapPath","sourceMapData","sourceMapAsset","hotModuleReplacement","length","watch","watchOptions","error","workerData","catch","process","exit"],"sources":["../../../src/commands/webpack/CompilerWorker.ts"],"sourcesContent":["import path from 'node:path';\nimport { parentPort, workerData } from 'node:worker_threads';\nimport memfs from 'memfs';\nimport webpack, { type Configuration } from 'webpack';\nimport { makeCompilerConfig } from '../common/config/makeCompilerConfig.js';\nimport { adaptFilenameToPlatform } from '../common/index.js';\nimport type {\n  CompilerAsset,\n  WebpackWorkerOptions,\n  WorkerMessages,\n} from './types.js';\n\nfunction postMessage(message: WorkerMessages.WorkerMessage): void {\n  parentPort?.postMessage(message);\n}\n\nasync function main(opts: WebpackWorkerOptions) {\n  const [config] = await makeCompilerConfig<Configuration>({\n    args: opts.args,\n    bundler: 'webpack',\n    command: 'start',\n    rootDir: opts.rootDir,\n    platforms: [opts.platform],\n    reactNativePath: opts.reactNativePath,\n  });\n\n  config.plugins = (config.plugins ?? []).concat(\n    new webpack.ProgressPlugin({\n      entries: false,\n      dependencies: false,\n      modules: true,\n      handler: (percentage, message, text) => {\n        const [, completed, total] = /(\\d+)\\/(\\d+) modules/.exec(text) ?? [];\n        postMessage({\n          event: 'progress',\n          completed: Number.parseInt(completed, 10),\n          total: Number.parseInt(total, 10),\n          percentage: percentage,\n          label: message,\n          message: text,\n        });\n      },\n    })\n  );\n\n  const compiler = webpack(config);\n\n  const fileSystem = memfs.createFsFromVolume(new memfs.Volume());\n\n  // @ts-expect-error memfs is compatible enough\n  compiler.outputFileSystem = fileSystem;\n\n  compiler.hooks.watchRun.tap('webpackWorker', () => {\n    postMessage({ event: 'watchRun' });\n  });\n\n  compiler.hooks.invalid.tap('webpackWorker', () => {\n    postMessage({ event: 'invalid' });\n  });\n\n  compiler.hooks.done.tap('webpackWorker', (stats) => {\n    const compilerStats = stats.toJson({\n      all: false,\n      assets: true,\n      children: true,\n      outputPath: true,\n      timings: true,\n      hash: true,\n      errors: true,\n      warnings: true,\n    });\n\n    const assets = compilerStats.assets!;\n    const outputDirectory = compilerStats.outputPath!;\n\n    const compilerAssets = assets\n      .filter((asset) => asset.type === 'asset')\n      .reduce(\n        (acc, { name, info, size }) => {\n          const assetPath = path.join(outputDirectory, name);\n          const data = fileSystem.readFileSync(assetPath) as Buffer;\n          const asset = { data, info, size };\n\n          acc[adaptFilenameToPlatform(name)] = asset;\n\n          if (info.related?.sourceMap) {\n            const sourceMapName = Array.isArray(info.related.sourceMap)\n              ? info.related.sourceMap[0]\n              : info.related.sourceMap;\n            const sourceMapPath = path.join(outputDirectory, sourceMapName);\n            const sourceMapData = fileSystem.readFileSync(\n              sourceMapPath\n            ) as Buffer;\n            const sourceMapAsset = {\n              data: sourceMapData,\n              info: {\n                hotModuleReplacement: info.hotModuleReplacement,\n                size: sourceMapData.length,\n              },\n              size: sourceMapData.length,\n            };\n\n            acc[adaptFilenameToPlatform(sourceMapName)] = sourceMapAsset;\n          }\n\n          return acc;\n        },\n        {} as Record<string, CompilerAsset>\n      );\n\n    postMessage({\n      event: 'done',\n      assets: compilerAssets,\n      stats: compilerStats,\n    });\n  });\n\n  compiler.watch(config.watchOptions ?? {}, (error) => {\n    if (error) {\n      postMessage({ event: 'error', error });\n    }\n  });\n}\n\nmain(workerData).catch((error) => {\n  postMessage({ event: 'error', error });\n  process.exit(1);\n});\n"],"mappings":";;AAAA,IAAAA,SAAA,GAAAC,sBAAA,CAAAC,OAAA;AACA,IAAAC,mBAAA,GAAAD,OAAA;AACA,IAAAE,MAAA,GAAAH,sBAAA,CAAAC,OAAA;AACA,IAAAG,QAAA,GAAAJ,sBAAA,CAAAC,OAAA;AACA,IAAAI,mBAAA,GAAAJ,OAAA;AACA,IAAAK,MAAA,GAAAL,OAAA;AAA6D,SAAAD,uBAAAO,CAAA,WAAAA,CAAA,IAAAA,CAAA,CAAAC,UAAA,GAAAD,CAAA,KAAAE,OAAA,EAAAF,CAAA;AAO7D,SAASG,WAAWA,CAACC,OAAqC,EAAQ;EAChEC,8BAAU,EAAEF,WAAW,CAACC,OAAO,CAAC;AAClC;AAEA,eAAeE,IAAIA,CAACC,IAA0B,EAAE;EAC9C,MAAM,CAACC,MAAM,CAAC,GAAG,MAAM,IAAAC,sCAAkB,EAAgB;IACvDC,IAAI,EAAEH,IAAI,CAACG,IAAI;IACfC,OAAO,EAAE,SAAS;IAClBC,OAAO,EAAE,OAAO;IAChBC,OAAO,EAAEN,IAAI,CAACM,OAAO;IACrBC,SAAS,EAAE,CAACP,IAAI,CAACQ,QAAQ,CAAC;IAC1BC,eAAe,EAAET,IAAI,CAACS;EACxB,CAAC,CAAC;EAEFR,MAAM,CAACS,OAAO,GAAG,CAACT,MAAM,CAACS,OAAO,IAAI,EAAE,EAAEC,MAAM,CAC5C,IAAIC,gBAAO,CAACC,cAAc,CAAC;IACzBC,OAAO,EAAE,KAAK;IACdC,YAAY,EAAE,KAAK;IACnBC,OAAO,EAAE,IAAI;IACbC,OAAO,EAAEA,CAACC,UAAU,EAAErB,OAAO,EAAEsB,IAAI,KAAK;MACtC,MAAM,GAAGC,SAAS,EAAEC,KAAK,CAAC,GAAG,sBAAsB,CAACC,IAAI,CAACH,IAAI,CAAC,IAAI,EAAE;MACpEvB,WAAW,CAAC;QACV2B,KAAK,EAAE,UAAU;QACjBH,SAAS,EAAEI,MAAM,CAACC,QAAQ,CAACL,SAAS,EAAE,EAAE,CAAC;QACzCC,KAAK,EAAEG,MAAM,CAACC,QAAQ,CAACJ,KAAK,EAAE,EAAE,CAAC;QACjCH,UAAU,EAAEA,UAAU;QACtBQ,KAAK,EAAE7B,OAAO;QACdA,OAAO,EAAEsB;MACX,CAAC,CAAC;IACJ;EACF,CAAC,CACH,CAAC;EAED,MAAMQ,QAAQ,GAAG,IAAAf,gBAAO,EAACX,MAAM,CAAC;EAEhC,MAAM2B,UAAU,GAAGC,cAAK,CAACC,kBAAkB,CAAC,IAAID,cAAK,CAACE,MAAM,CAAC,CAAC,CAAC;;EAE/D;EACAJ,QAAQ,CAACK,gBAAgB,GAAGJ,UAAU;EAEtCD,QAAQ,CAACM,KAAK,CAACC,QAAQ,CAACC,GAAG,CAAC,eAAe,EAAE,MAAM;IACjDvC,WAAW,CAAC;MAAE2B,KAAK,EAAE;IAAW,CAAC,CAAC;EACpC,CAAC,CAAC;EAEFI,QAAQ,CAACM,KAAK,CAACG,OAAO,CAACD,GAAG,CAAC,eAAe,EAAE,MAAM;IAChDvC,WAAW,CAAC;MAAE2B,KAAK,EAAE;IAAU,CAAC,CAAC;EACnC,CAAC,CAAC;EAEFI,QAAQ,CAACM,KAAK,CAACI,IAAI,CAACF,GAAG,CAAC,eAAe,EAAGG,KAAK,IAAK;IAClD,MAAMC,aAAa,GAAGD,KAAK,CAACE,MAAM,CAAC;MACjCC,GAAG,EAAE,KAAK;MACVC,MAAM,EAAE,IAAI;MACZC,QAAQ,EAAE,IAAI;MACdC,UAAU,EAAE,IAAI;MAChBC,OAAO,EAAE,IAAI;MACbC,IAAI,EAAE,IAAI;MACVC,MAAM,EAAE,IAAI;MACZC,QAAQ,EAAE;IACZ,CAAC,CAAC;IAEF,MAAMN,MAAM,GAAGH,aAAa,CAACG,MAAO;IACpC,MAAMO,eAAe,GAAGV,aAAa,CAACK,UAAW;IAEjD,MAAMM,cAAc,GAAGR,MAAM,CAC1BS,MAAM,CAAEC,KAAK,IAAKA,KAAK,CAACC,IAAI,KAAK,OAAO,CAAC,CACzCC,MAAM,CACL,CAACC,GAAG,EAAE;MAAEC,IAAI;MAAEC,IAAI;MAAEC;IAAK,CAAC,KAAK;MAC7B,MAAMC,SAAS,GAAGC,iBAAI,CAACC,IAAI,CAACZ,eAAe,EAAEO,IAAI,CAAC;MAClD,MAAMM,IAAI,GAAGlC,UAAU,CAACmC,YAAY,CAACJ,SAAS,CAAW;MACzD,MAAMP,KAAK,GAAG;QAAEU,IAAI;QAAEL,IAAI;QAAEC;MAAK,CAAC;MAElCH,GAAG,CAAC,IAAAS,8BAAuB,EAACR,IAAI,CAAC,CAAC,GAAGJ,KAAK;MAE1C,IAAIK,IAAI,CAACQ,OAAO,EAAEC,SAAS,EAAE;QAC3B,MAAMC,aAAa,GAAGC,KAAK,CAACC,OAAO,CAACZ,IAAI,CAACQ,OAAO,CAACC,SAAS,CAAC,GACvDT,IAAI,CAACQ,OAAO,CAACC,SAAS,CAAC,CAAC,CAAC,GACzBT,IAAI,CAACQ,OAAO,CAACC,SAAS;QAC1B,MAAMI,aAAa,GAAGV,iBAAI,CAACC,IAAI,CAACZ,eAAe,EAAEkB,aAAa,CAAC;QAC/D,MAAMI,aAAa,GAAG3C,UAAU,CAACmC,YAAY,CAC3CO,aACF,CAAW;QACX,MAAME,cAAc,GAAG;UACrBV,IAAI,EAAES,aAAa;UACnBd,IAAI,EAAE;YACJgB,oBAAoB,EAAEhB,IAAI,CAACgB,oBAAoB;YAC/Cf,IAAI,EAAEa,aAAa,CAACG;UACtB,CAAC;UACDhB,IAAI,EAAEa,aAAa,CAACG;QACtB,CAAC;QAEDnB,GAAG,CAAC,IAAAS,8BAAuB,EAACG,aAAa,CAAC,CAAC,GAAGK,cAAc;MAC9D;MAEA,OAAOjB,GAAG;IACZ,CAAC,EACD,CAAC,CACH,CAAC;IAEH3D,WAAW,CAAC;MACV2B,KAAK,EAAE,MAAM;MACbmB,MAAM,EAAEQ,cAAc;MACtBZ,KAAK,EAAEC;IACT,CAAC,CAAC;EACJ,CAAC,CAAC;EAEFZ,QAAQ,CAACgD,KAAK,CAAC1E,MAAM,CAAC2E,YAAY,IAAI,CAAC,CAAC,EAAGC,KAAK,IAAK;IACnD,IAAIA,KAAK,EAAE;MACTjF,WAAW,CAAC;QAAE2B,KAAK,EAAE,OAAO;QAAEsD;MAAM,CAAC,CAAC;IACxC;EACF,CAAC,CAAC;AACJ;AAEA9E,IAAI,CAAC+E,8BAAU,CAAC,CAACC,KAAK,CAAEF,KAAK,IAAK;EAChCjF,WAAW,CAAC;IAAE2B,KAAK,EAAE,OAAO;IAAEsD;EAAM,CAAC,CAAC;EACtCG,OAAO,CAACC,IAAI,CAAC,CAAC,CAAC;AACjB,CAAC,CAAC","ignoreList":[]}