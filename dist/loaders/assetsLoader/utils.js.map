{"version":3,"file":"utils.js","names":["_nodePath","_interopRequireDefault","require","_imageSize","e","__esModule","default","getScaleNumber","scaleKey","Number","parseFloat","replace","getDefaultAsset","assets","defaultAsset","find","asset","Error","getAssetDimensions","resourceData","resourceScale","info","imageSize","width","height","collectScales","resourceAbsoluteDirname","resourceFilename","resourceExtension","scalableAssetExtensions","scalableAssetResolutions","readDirAsync","includes","path","join","candidates","map","scale","push","contents","entries","Set","collectedScales","candidate","candidateFilename","has","filepath"],"sources":["../../../src/loaders/assetsLoader/utils.ts"],"sourcesContent":["import path from 'node:path';\nimport imageSize from 'image-size';\nimport type { Asset, AssetDimensions, CollectedScales } from './types';\n\nexport function getScaleNumber(scaleKey: string) {\n  return Number.parseFloat(scaleKey.replace(/[^\\d.]/g, ''));\n}\n\n/** Default asset is the one with scale that was originally requested in the loader */\nexport function getDefaultAsset(assets: Asset[]) {\n  const defaultAsset = assets.find((asset) => asset.default === true);\n  if (!defaultAsset) {\n    throw new Error('Malformed assets array - no default asset found');\n  }\n  return defaultAsset;\n}\n\nexport function getAssetDimensions({\n  resourceData,\n  resourceScale,\n}: {\n  resourceData: Buffer;\n  resourceScale: number;\n}): AssetDimensions | null {\n  try {\n    const info = imageSize(resourceData);\n    if (!info.width || !info.height) {\n      return null;\n    }\n    return {\n      width: info.width / resourceScale,\n      height: info.height / resourceScale,\n    };\n  } catch {\n    return null;\n  }\n}\n\nexport async function collectScales(\n  resourceAbsoluteDirname: string,\n  resourceFilename: string,\n  resourceExtension: string,\n  scalableAssetExtensions: string[],\n  scalableAssetResolutions: string[],\n  readDirAsync: (path: string) => Promise<string[]>\n): Promise<CollectedScales> {\n  if (!scalableAssetExtensions.includes(resourceExtension)) {\n    return {\n      '@1x': path.join(\n        resourceAbsoluteDirname,\n        resourceFilename + '.' + resourceExtension\n      ),\n    };\n  }\n\n  // explicit scales\n  const candidates = scalableAssetResolutions.map((scaleKey) => {\n    const scale = '@' + scaleKey + 'x';\n    return [scale, resourceFilename + scale + '.' + resourceExtension];\n  });\n  // implicit 1x scale\n  candidates.push(['@1x', resourceFilename + '.' + resourceExtension]);\n\n  const contents = await readDirAsync(resourceAbsoluteDirname);\n  const entries = new Set(contents);\n\n  const collectedScales: Record<string, string> = {};\n  for (const candidate of candidates) {\n    const [scaleKey, candidateFilename] = candidate;\n    if (entries.has(candidateFilename)) {\n      const filepath = path.join(resourceAbsoluteDirname, candidateFilename);\n      collectedScales[scaleKey] = filepath;\n    }\n  }\n\n  return collectedScales;\n}\n"],"mappings":";;;;;;;;;AAAA,IAAAA,SAAA,GAAAC,sBAAA,CAAAC,OAAA;AACA,IAAAC,UAAA,GAAAF,sBAAA,CAAAC,OAAA;AAAmC,SAAAD,uBAAAG,CAAA,WAAAA,CAAA,IAAAA,CAAA,CAAAC,UAAA,GAAAD,CAAA,KAAAE,OAAA,EAAAF,CAAA;AAG5B,SAASG,cAAcA,CAACC,QAAgB,EAAE;EAC/C,OAAOC,MAAM,CAACC,UAAU,CAACF,QAAQ,CAACG,OAAO,CAAC,SAAS,EAAE,EAAE,CAAC,CAAC;AAC3D;;AAEA;AACO,SAASC,eAAeA,CAACC,MAAe,EAAE;EAC/C,MAAMC,YAAY,GAAGD,MAAM,CAACE,IAAI,CAAEC,KAAK,IAAKA,KAAK,CAACV,OAAO,KAAK,IAAI,CAAC;EACnE,IAAI,CAACQ,YAAY,EAAE;IACjB,MAAM,IAAIG,KAAK,CAAC,iDAAiD,CAAC;EACpE;EACA,OAAOH,YAAY;AACrB;AAEO,SAASI,kBAAkBA,CAAC;EACjCC,YAAY;EACZC;AAIF,CAAC,EAA0B;EACzB,IAAI;IACF,MAAMC,IAAI,GAAG,IAAAC,kBAAS,EAACH,YAAY,CAAC;IACpC,IAAI,CAACE,IAAI,CAACE,KAAK,IAAI,CAACF,IAAI,CAACG,MAAM,EAAE;MAC/B,OAAO,IAAI;IACb;IACA,OAAO;MACLD,KAAK,EAAEF,IAAI,CAACE,KAAK,GAAGH,aAAa;MACjCI,MAAM,EAAEH,IAAI,CAACG,MAAM,GAAGJ;IACxB,CAAC;EACH,CAAC,CAAC,MAAM;IACN,OAAO,IAAI;EACb;AACF;AAEO,eAAeK,aAAaA,CACjCC,uBAA+B,EAC/BC,gBAAwB,EACxBC,iBAAyB,EACzBC,uBAAiC,EACjCC,wBAAkC,EAClCC,YAAiD,EACvB;EAC1B,IAAI,CAACF,uBAAuB,CAACG,QAAQ,CAACJ,iBAAiB,CAAC,EAAE;IACxD,OAAO;MACL,KAAK,EAAEK,iBAAI,CAACC,IAAI,CACdR,uBAAuB,EACvBC,gBAAgB,GAAG,GAAG,GAAGC,iBAC3B;IACF,CAAC;EACH;;EAEA;EACA,MAAMO,UAAU,GAAGL,wBAAwB,CAACM,GAAG,CAAE5B,QAAQ,IAAK;IAC5D,MAAM6B,KAAK,GAAG,GAAG,GAAG7B,QAAQ,GAAG,GAAG;IAClC,OAAO,CAAC6B,KAAK,EAAEV,gBAAgB,GAAGU,KAAK,GAAG,GAAG,GAAGT,iBAAiB,CAAC;EACpE,CAAC,CAAC;EACF;EACAO,UAAU,CAACG,IAAI,CAAC,CAAC,KAAK,EAAEX,gBAAgB,GAAG,GAAG,GAAGC,iBAAiB,CAAC,CAAC;EAEpE,MAAMW,QAAQ,GAAG,MAAMR,YAAY,CAACL,uBAAuB,CAAC;EAC5D,MAAMc,OAAO,GAAG,IAAIC,GAAG,CAACF,QAAQ,CAAC;EAEjC,MAAMG,eAAuC,GAAG,CAAC,CAAC;EAClD,KAAK,MAAMC,SAAS,IAAIR,UAAU,EAAE;IAClC,MAAM,CAAC3B,QAAQ,EAAEoC,iBAAiB,CAAC,GAAGD,SAAS;IAC/C,IAAIH,OAAO,CAACK,GAAG,CAACD,iBAAiB,CAAC,EAAE;MAClC,MAAME,QAAQ,GAAGb,iBAAI,CAACC,IAAI,CAACR,uBAAuB,EAAEkB,iBAAiB,CAAC;MACtEF,eAAe,CAAClC,QAAQ,CAAC,GAAGsC,QAAQ;IACtC;EACF;EAEA,OAAOJ,eAAe;AACxB","ignoreList":[]}