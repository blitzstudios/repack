{"version":3,"file":"utils.js","names":["_nodePath","_interopRequireDefault","require","_imageSize","e","__esModule","default","getScaleNumber","scaleKey","Number","parseFloat","replace","getAssetSize","assets","dimensions","getAssetDimensions","resourceData","resourceScale","info","imageSize","width","height","collectScales","resourceAbsoluteDirname","resourceFilename","resourceExtension","scalableAssetExtensions","scalableAssetResolutions","platform","readDirAsync","candidates","includes","concat","flatMap","scale","contents","entries","Set","collectedScales","candidate","candidateFilename","has","filepath","path","join"],"sources":["../../../src/loaders/assetsLoader/utils.ts"],"sourcesContent":["import path from 'node:path';\nimport { imageSize } from 'image-size';\nimport type { Asset, AssetDimensions, CollectedScales } from './types.js';\n\nexport function getScaleNumber(scaleKey: string) {\n  return Number.parseFloat(scaleKey.replace(/[^\\d.]/g, ''));\n}\n\nexport function getAssetSize(assets: Asset[]) {\n  // Use first asset for reference as size, just like in metro:\n  // https://github.com/facebook/metro/blob/main/packages/metro/src/Assets.js#L223\n  return assets[0].dimensions;\n}\n\nexport function getAssetDimensions({\n  resourceData,\n  resourceScale,\n}: {\n  resourceData: Buffer;\n  resourceScale: number;\n}): AssetDimensions | null {\n  try {\n    const info = imageSize(resourceData);\n    if (!info.width || !info.height) {\n      return null;\n    }\n    return {\n      width: info.width / resourceScale,\n      height: info.height / resourceScale,\n    };\n  } catch {\n    return null;\n  }\n}\n\nexport async function collectScales(\n  resourceAbsoluteDirname: string,\n  resourceFilename: string,\n  resourceExtension: string,\n  scalableAssetExtensions: string[],\n  scalableAssetResolutions: string[],\n  platform: string,\n  readDirAsync: (path: string) => Promise<string[]>\n): Promise<CollectedScales> {\n  // implicit 1x scale\n  let candidates = [\n    ['@1x', resourceFilename + '.' + resourceExtension],\n    ['@1x', resourceFilename + '.' + platform + '.' + resourceExtension],\n  ];\n\n  // explicit scales\n  if (scalableAssetExtensions.includes(resourceExtension)) {\n    candidates = candidates.concat(\n      scalableAssetResolutions.flatMap((scaleKey) => {\n        const scale = '@' + scaleKey + 'x';\n        return [\n          [scale, resourceFilename + scale + '.' + resourceExtension],\n          [\n            scale,\n            resourceFilename + scale + '.' + platform + '.' + resourceExtension,\n          ],\n        ];\n      })\n    );\n  }\n\n  const contents = await readDirAsync(resourceAbsoluteDirname);\n  const entries = new Set(contents);\n\n  // assets with platform extensions are more specific and take precedence\n  const collectedScales: Record<string, string> = {};\n  for (const candidate of candidates) {\n    const [scaleKey, candidateFilename] = candidate;\n    if (entries.has(candidateFilename)) {\n      const filepath = path.join(resourceAbsoluteDirname, candidateFilename);\n      collectedScales[scaleKey] = filepath;\n    }\n  }\n\n  return collectedScales;\n}\n"],"mappings":";;;;;;;;;AAAA,IAAAA,SAAA,GAAAC,sBAAA,CAAAC,OAAA;AACA,IAAAC,UAAA,GAAAD,OAAA;AAAuC,SAAAD,uBAAAG,CAAA,WAAAA,CAAA,IAAAA,CAAA,CAAAC,UAAA,GAAAD,CAAA,KAAAE,OAAA,EAAAF,CAAA;AAGhC,SAASG,cAAcA,CAACC,QAAgB,EAAE;EAC/C,OAAOC,MAAM,CAACC,UAAU,CAACF,QAAQ,CAACG,OAAO,CAAC,SAAS,EAAE,EAAE,CAAC,CAAC;AAC3D;AAEO,SAASC,YAAYA,CAACC,MAAe,EAAE;EAC5C;EACA;EACA,OAAOA,MAAM,CAAC,CAAC,CAAC,CAACC,UAAU;AAC7B;AAEO,SAASC,kBAAkBA,CAAC;EACjCC,YAAY;EACZC;AAIF,CAAC,EAA0B;EACzB,IAAI;IACF,MAAMC,IAAI,GAAG,IAAAC,oBAAS,EAACH,YAAY,CAAC;IACpC,IAAI,CAACE,IAAI,CAACE,KAAK,IAAI,CAACF,IAAI,CAACG,MAAM,EAAE;MAC/B,OAAO,IAAI;IACb;IACA,OAAO;MACLD,KAAK,EAAEF,IAAI,CAACE,KAAK,GAAGH,aAAa;MACjCI,MAAM,EAAEH,IAAI,CAACG,MAAM,GAAGJ;IACxB,CAAC;EACH,CAAC,CAAC,MAAM;IACN,OAAO,IAAI;EACb;AACF;AAEO,eAAeK,aAAaA,CACjCC,uBAA+B,EAC/BC,gBAAwB,EACxBC,iBAAyB,EACzBC,uBAAiC,EACjCC,wBAAkC,EAClCC,QAAgB,EAChBC,YAAiD,EACvB;EAC1B;EACA,IAAIC,UAAU,GAAG,CACf,CAAC,KAAK,EAAEN,gBAAgB,GAAG,GAAG,GAAGC,iBAAiB,CAAC,EACnD,CAAC,KAAK,EAAED,gBAAgB,GAAG,GAAG,GAAGI,QAAQ,GAAG,GAAG,GAAGH,iBAAiB,CAAC,CACrE;;EAED;EACA,IAAIC,uBAAuB,CAACK,QAAQ,CAACN,iBAAiB,CAAC,EAAE;IACvDK,UAAU,GAAGA,UAAU,CAACE,MAAM,CAC5BL,wBAAwB,CAACM,OAAO,CAAEzB,QAAQ,IAAK;MAC7C,MAAM0B,KAAK,GAAG,GAAG,GAAG1B,QAAQ,GAAG,GAAG;MAClC,OAAO,CACL,CAAC0B,KAAK,EAAEV,gBAAgB,GAAGU,KAAK,GAAG,GAAG,GAAGT,iBAAiB,CAAC,EAC3D,CACES,KAAK,EACLV,gBAAgB,GAAGU,KAAK,GAAG,GAAG,GAAGN,QAAQ,GAAG,GAAG,GAAGH,iBAAiB,CACpE,CACF;IACH,CAAC,CACH,CAAC;EACH;EAEA,MAAMU,QAAQ,GAAG,MAAMN,YAAY,CAACN,uBAAuB,CAAC;EAC5D,MAAMa,OAAO,GAAG,IAAIC,GAAG,CAACF,QAAQ,CAAC;;EAEjC;EACA,MAAMG,eAAuC,GAAG,CAAC,CAAC;EAClD,KAAK,MAAMC,SAAS,IAAIT,UAAU,EAAE;IAClC,MAAM,CAACtB,QAAQ,EAAEgC,iBAAiB,CAAC,GAAGD,SAAS;IAC/C,IAAIH,OAAO,CAACK,GAAG,CAACD,iBAAiB,CAAC,EAAE;MAClC,MAAME,QAAQ,GAAGC,iBAAI,CAACC,IAAI,CAACrB,uBAAuB,EAAEiB,iBAAiB,CAAC;MACtEF,eAAe,CAAC9B,QAAQ,CAAC,GAAGkC,QAAQ;IACtC;EACF;EAEA,OAAOJ,eAAe;AACxB","ignoreList":[]}