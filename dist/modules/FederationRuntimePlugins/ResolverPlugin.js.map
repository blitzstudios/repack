{"version":3,"file":"ResolverPlugin.js","names":["createScriptLocator","entryUrl","config","locator","url","getPublicPath","split","slice","join","getAssetPath","assetPath","startsWith","rebaseRemoteUrl","from","to","publicPath","RepackResolverPlugin","name","afterResolve","args","remoteInfo","ScriptManager","require","version","entry","shared","addResolver","scriptId","caller","referenceUrl","Error","key"],"sources":["../../../src/modules/FederationRuntimePlugins/ResolverPlugin.ts"],"sourcesContent":["import type { FederationRuntimePlugin } from '@module-federation/enhanced/runtime';\nimport type * as RepackClient from '../ScriptManager/index.js';\n\nexport type RepackResolverPluginConfiguration =\n  | Omit<RepackClient.ScriptLocator, 'url'>\n  | ((url: string) => Promise<RepackClient.ScriptLocator>);\n\nconst createScriptLocator = async (\n  entryUrl: string,\n  config?: RepackResolverPluginConfiguration\n) => {\n  if (typeof config === 'function') {\n    const locator = await config(entryUrl);\n    return locator;\n  }\n  if (typeof config === 'object') {\n    return { url: entryUrl, ...config };\n  }\n  return { url: entryUrl };\n};\n\nconst getPublicPath = (url: string) => {\n  return url.split('/').slice(0, -1).join('/');\n};\n\nconst getAssetPath = (url: string) => {\n  const assetPath = url.split(getPublicPath(url))[1];\n  // normalize by removing leading slash\n  return assetPath.startsWith('/') ? assetPath.slice(1) : assetPath;\n};\n\nconst rebaseRemoteUrl = (from: string, to: string) => {\n  const assetPath = getAssetPath(from);\n  const publicPath = getPublicPath(to);\n  return [publicPath, assetPath].join('/');\n};\n\nconst RepackResolverPlugin: (\n  config?: RepackResolverPluginConfiguration\n) => FederationRuntimePlugin = (config) => ({\n  name: 'repack-resolver-plugin',\n  afterResolve(args) {\n    const { remoteInfo } = args;\n    const { ScriptManager } =\n      require('../ScriptManager/index.js') as typeof RepackClient;\n\n    // when manifest is used, the valid entry URL comes from the version field\n    // otherwise, the entry URL comes from the entry field which has the correct publicPath for the remote set\n    const entryUrl = remoteInfo.version ?? remoteInfo.entry;\n\n    ScriptManager.shared.addResolver(\n      async (scriptId, caller, referenceUrl) => {\n        if (scriptId === remoteInfo.name || caller === remoteInfo.name) {\n          // referenceUrl should always be present and this should never happen\n          if (!referenceUrl) {\n            throw new Error('[RepackResolverPlugin] Reference URL is missing');\n          }\n\n          const url = rebaseRemoteUrl(referenceUrl, entryUrl);\n          const locator = await createScriptLocator(url, config);\n          return locator;\n        }\n      },\n      { key: remoteInfo.name }\n    );\n\n    return args;\n  },\n});\n\nexport default RepackResolverPlugin;\n"],"mappings":"AAOA,MAAMA,mBAAmB,GAAG,MAAAA,CAC1BC,QAAgB,EAChBC,MAA0C,KACvC;EACH,IAAI,OAAOA,MAAM,KAAK,UAAU,EAAE;IAChC,MAAMC,OAAO,GAAG,MAAMD,MAAM,CAACD,QAAQ,CAAC;IACtC,OAAOE,OAAO;EAChB;EACA,IAAI,OAAOD,MAAM,KAAK,QAAQ,EAAE;IAC9B,OAAO;MAAEE,GAAG,EAAEH,QAAQ;MAAE,GAAGC;IAAO,CAAC;EACrC;EACA,OAAO;IAAEE,GAAG,EAAEH;EAAS,CAAC;AAC1B,CAAC;AAED,MAAMI,aAAa,GAAID,GAAW,IAAK;EACrC,OAAOA,GAAG,CAACE,KAAK,CAAC,GAAG,CAAC,CAACC,KAAK,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,CAACC,IAAI,CAAC,GAAG,CAAC;AAC9C,CAAC;AAED,MAAMC,YAAY,GAAIL,GAAW,IAAK;EACpC,MAAMM,SAAS,GAAGN,GAAG,CAACE,KAAK,CAACD,aAAa,CAACD,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC;EAClD;EACA,OAAOM,SAAS,CAACC,UAAU,CAAC,GAAG,CAAC,GAAGD,SAAS,CAACH,KAAK,CAAC,CAAC,CAAC,GAAGG,SAAS;AACnE,CAAC;AAED,MAAME,eAAe,GAAGA,CAACC,IAAY,EAAEC,EAAU,KAAK;EACpD,MAAMJ,SAAS,GAAGD,YAAY,CAACI,IAAI,CAAC;EACpC,MAAME,UAAU,GAAGV,aAAa,CAACS,EAAE,CAAC;EACpC,OAAO,CAACC,UAAU,EAAEL,SAAS,CAAC,CAACF,IAAI,CAAC,GAAG,CAAC;AAC1C,CAAC;AAED,MAAMQ,oBAEsB,GAAId,MAAM,KAAM;EAC1Ce,IAAI,EAAE,wBAAwB;EAC9BC,YAAYA,CAACC,IAAI,EAAE;IACjB,MAAM;MAAEC;IAAW,CAAC,GAAGD,IAAI;IAC3B,MAAM;MAAEE;IAAc,CAAC,GACrBC,OAAO,CAAC,2BAA2B,CAAwB;;IAE7D;IACA;IACA,MAAMrB,QAAQ,GAAGmB,UAAU,CAACG,OAAO,IAAIH,UAAU,CAACI,KAAK;IAEvDH,aAAa,CAACI,MAAM,CAACC,WAAW,CAC9B,OAAOC,QAAQ,EAAEC,MAAM,EAAEC,YAAY,KAAK;MACxC,IAAIF,QAAQ,KAAKP,UAAU,CAACH,IAAI,IAAIW,MAAM,KAAKR,UAAU,CAACH,IAAI,EAAE;QAC9D;QACA,IAAI,CAACY,YAAY,EAAE;UACjB,MAAM,IAAIC,KAAK,CAAC,iDAAiD,CAAC;QACpE;QAEA,MAAM1B,GAAG,GAAGQ,eAAe,CAACiB,YAAY,EAAE5B,QAAQ,CAAC;QACnD,MAAME,OAAO,GAAG,MAAMH,mBAAmB,CAACI,GAAG,EAAEF,MAAM,CAAC;QACtD,OAAOC,OAAO;MAChB;IACF,CAAC,EACD;MAAE4B,GAAG,EAAEX,UAAU,CAACH;IAAK,CACzB,CAAC;IAED,OAAOE,IAAI;EACb;AACF,CAAC,CAAC;AAEF,eAAeH,oBAAoB","ignoreList":[]}