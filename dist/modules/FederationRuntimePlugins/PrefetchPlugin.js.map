{"version":3,"file":"PrefetchPlugin.js","names":["getAssetName","asset","split","getAssetUrl","prefetchAsset","client","require","ScriptManager","getWebpackContext","caller","name","remoteName","undefined","shared","prefetchScript","url","RepackPrefetchPlugin","generatePreloadAssets","args","preloadConfig","preloadOptions","nameOrAlias","remoteSnapshot","depsRemote","console","warn","handleAssets","assets","map","exposedModule","modules","exposes","includes","moduleName","resourceCategory","push","js","async","sync","filter","unshift","globalName","remoteEntry","Promise","all","resolve","cssAssets","jsAssetsWithoutEntry","entryAssets"],"sources":["../../../src/modules/FederationRuntimePlugins/PrefetchPlugin.ts"],"sourcesContent":["import type { FederationRuntimePlugin } from '@module-federation/enhanced/runtime';\nimport type * as RepackClient from '../ScriptManager/index.js';\n\ninterface PrefetchAsset {\n  name: string;\n  remoteName: string;\n  url: string;\n}\n\nfunction getAssetName(asset: string): string {\n  // remove the extension from the asset name\n  return asset.split('.')[0];\n}\n\nfunction getAssetUrl(asset: string) {\n  // create placeholder reference url for the asset\n  return 'prefetch:///' + asset;\n}\n\nfunction prefetchAsset(asset: PrefetchAsset) {\n  const client = require('../ScriptManager/index.js') as typeof RepackClient;\n  const { ScriptManager, getWebpackContext } = client;\n\n  // caller should be undefined when fetching/loading the remote entry container\n  const caller = asset.name === asset.remoteName ? undefined : asset.remoteName;\n\n  return ScriptManager.shared.prefetchScript(\n    asset.name,\n    caller,\n    getWebpackContext(),\n    asset.url\n  );\n}\n\nconst RepackPrefetchPlugin: () => FederationRuntimePlugin = () => ({\n  name: 'repack-prefetch-plugin',\n  generatePreloadAssets: async (args) => {\n    const preloadConfig = args.preloadOptions.preloadConfig;\n    const remoteName = preloadConfig.nameOrAlias;\n    const remoteSnapshot = args.remoteSnapshot;\n\n    if (preloadConfig.depsRemote !== false) {\n      console.warn(\n        '[RepackPrefetchPlugin] ' +\n          'The depsRemote configuration option is not implemented yet. ' +\n          'This setting will be ignored and will have no effect. ' +\n          'You can hide this warning by setting depsRemote explicitly to false.'\n      );\n    }\n\n    function handleAssets(assets: string[]): PrefetchAsset[] {\n      return assets.map((asset) => ({\n        name: getAssetName(asset),\n        remoteName,\n        url: getAssetUrl(asset),\n      }));\n    }\n\n    let assets: PrefetchAsset[] = [];\n\n    if ('modules' in remoteSnapshot) {\n      for (const exposedModule of remoteSnapshot.modules) {\n        if (preloadConfig.exposes) {\n          if (!preloadConfig.exposes.includes(exposedModule.moduleName)) {\n            continue;\n          }\n        }\n\n        if (preloadConfig.resourceCategory === 'all') {\n          assets.push(...handleAssets(exposedModule.assets.js.async));\n          assets.push(...handleAssets(exposedModule.assets.js.sync));\n        } else if (preloadConfig.resourceCategory === 'sync') {\n          assets.push(...handleAssets(exposedModule.assets.js.sync));\n        }\n      }\n\n      if (preloadConfig.filter) {\n        assets = assets.filter((asset) => preloadConfig.filter!(asset.name));\n      }\n\n      assets.unshift({\n        name: remoteSnapshot.globalName,\n        remoteName: remoteSnapshot.globalName,\n        url: getAssetUrl(remoteSnapshot.remoteEntry),\n      });\n    }\n\n    await Promise.all(assets.map(prefetchAsset));\n\n    // noop for compatibility\n    return Promise.resolve({\n      cssAssets: [],\n      jsAssetsWithoutEntry: [],\n      entryAssets: [],\n    });\n  },\n});\n\nexport default RepackPrefetchPlugin;\n"],"mappings":"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","ignoreList":[]}