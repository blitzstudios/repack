{"version":3,"file":"WebpackHMRClient.js","names":["TcpSocket","getDevServerLocation","HMRClient","lastHash","constructor","app","url","hostname","__PUBLIC_PORT__","__PLATFORM__","socket","WebSocket","console","debug","onopen","onclose","onerror","event","onmessage","processMessage","JSON","parse","data","toString","error","warn","upToDate","hash","__webpack_hash__","sendTcpSocket","message","tempConnection","createConnection","port","host","__LISTENER_IP__","reuseAddress","json","stringify","_webpack","write","destroy","on","e","log","action","showLoadingView","name","body","time","errors","length","fileUrl","forEach","moduleName","n","lastIndexOf","substring","warnings","warning","applyUpdate","update","module","hot","Error","hideLoadingView","status","checkUpdates","updatedModules","check","reload","renewedModules","apply","ignoreDeclined","ignoreUnaccepted","ignoreErrored","onDeclined","chain","unacceptedModules","filter","moduleId","indexOf","dismissErrors","__DEV__","DevSettings","require","Platform","OS","NativeRedBox","default","dismiss","NativeExceptionsManager","dismissRedbox","LogBoxData","clear","text","type","LoadingView","__REACT_NATIVE_MINOR_VERSION__","showMessage","hide"],"sources":["../../src/modules/WebpackHMRClient.ts"],"sourcesContent":["import TcpSocket from 'react-native-tcp-socket';\nimport type { HMRMessage, HMRMessageBody } from '../types';\nimport { getDevServerLocation } from './getDevServerLocation';\n\ninterface LoadingViewModule {\n  hide(): void;\n  showMessage(text: string, type: string): void;\n}\n\nclass HMRClient {\n  url: string;\n  socket: WebSocket;\n  listener: TcpSocket.Socket | undefined;\n  lastHash = '';\n\n  constructor(\n    private app: {\n      reload: () => void;\n      dismissErrors: () => void;\n      showLoadingView: (text: string, type: 'load' | 'refresh') => void;\n      hideLoadingView: () => void;\n    }\n  ) {\n    this.url = `ws://${\n      getDevServerLocation().hostname\n    }:${__PUBLIC_PORT__}/__hmr?platform=${__PLATFORM__}`;\n    this.socket = new WebSocket(this.url);\n\n    console.debug('[HMRClient] Connecting...', {\n      url: this.url,\n    });\n\n    this.socket.onopen = () => {\n      console.debug('[HMRClient] Connected');\n    };\n\n    this.socket.onclose = () => {\n      console.debug('[HMRClient] Disconnected');\n    };\n\n    this.socket.onerror = (event) => {\n      console.debug('[HMRClient] Error', event);\n    };\n\n    this.socket.onmessage = (event) => {\n      try {\n        this.processMessage(JSON.parse(event.data.toString()));\n      } catch (error) {\n        console.warn('[HMRClient] Invalid HMR message', { event, error });\n      }\n    };\n  }\n\n  upToDate(hash?: string) {\n    if (hash) {\n      this.lastHash = hash;\n    }\n    return this.lastHash === __webpack_hash__;\n  }\n\n  sendTcpSocket(message: string) {\n    let tempConnection: TcpSocket.Socket | null = null;\n\n    try {\n      tempConnection = TcpSocket.createConnection(\n        {\n          port: 9093,\n          host: __LISTENER_IP__,\n          reuseAddress: true,\n        },\n        () => {\n          const json = JSON.stringify({ _webpack: message });\n          tempConnection?.write(json);\n          tempConnection?.destroy();\n        }\n      );\n      tempConnection.on('error', () => {\n        tempConnection?.destroy();\n      });\n    } catch (e) {\n      console.log('[HMRClient] Send TCPSocket failed: ', e);\n      tempConnection?.destroy();\n    }\n  }\n\n  processMessage(message: HMRMessage) {\n    switch (message.action) {\n      case 'building':\n        this.sendTcpSocket('building');\n        this.app.showLoadingView('Rebuilding...', 'refresh');\n        console.debug('[HMRClient] Bundle rebuilding', {\n          name: message.body?.name,\n        });\n        break;\n      case 'built':\n        this.sendTcpSocket('built');\n        console.debug('[HMRClient] Bundle rebuilt', {\n          name: message.body?.name,\n          time: message.body?.time,\n        });\n      // Fall through\n      case 'sync':\n        if (!message.body) {\n          console.warn('[HMRClient] HMR message body is empty');\n          return;\n        }\n\n        if (message.body.errors?.length) {\n          let fileUrl = '';\n          message.body.errors.forEach((error) => {\n            console.error('Cannot apply update due to error:', error);\n            fileUrl = error?.moduleName || '';\n          });\n          let n = fileUrl.lastIndexOf('/');\n          let moduleName = fileUrl.substring(n + 1);\n          this.app.showLoadingView(`Failed (${moduleName})`, 'refresh');\n          return;\n        }\n\n        if (message.body.warnings?.length) {\n          message.body.warnings.forEach((warning) => {\n            console.warn('[HMRClient] Bundle contains warnings:', warning);\n          });\n        }\n\n        this.applyUpdate(message.body);\n    }\n  }\n\n  applyUpdate(update: HMRMessageBody) {\n    if (!module.hot) {\n      throw new Error('[HMRClient] Hot Module Replacement is disabled.');\n    }\n\n    const upToDate = this.upToDate(update.hash);\n\n    if (upToDate) {\n      this.app.hideLoadingView();\n    } else if (module.hot.status() === 'idle') {\n      console.debug('[HMRClient] Checking for updates on the server...');\n      void this.checkUpdates(update);\n    }\n  }\n\n  async checkUpdates(update: HMRMessageBody) {\n    try {\n      this.app.showLoadingView('Refreshing...', 'refresh');\n      const updatedModules = await module.hot?.check(false);\n      if (!updatedModules) {\n        console.warn('[HMRClient] Cannot find update - full reload needed');\n        this.app.reload();\n        return;\n      }\n\n      const renewedModules = await module.hot?.apply({\n        ignoreDeclined: true,\n        ignoreUnaccepted: false,\n        ignoreErrored: false,\n        onDeclined: (data) => {\n          // This module declined update, no need to do anything\n          console.warn('[HMRClient] Ignored an update due to declined module', {\n            chain: data.chain,\n          });\n        },\n      });\n\n      if (!this.upToDate()) {\n        void this.checkUpdates(update);\n        return;\n      }\n\n      // No modules updated - leave everything as it is (including errors)\n      if (!renewedModules || renewedModules.length === 0) {\n        console.debug('[HMRClient] No renewed modules - app is up to date');\n        return;\n      }\n\n      // Double check to make sure all updated modules were accepted (renewed)\n      const unacceptedModules = updatedModules.filter((moduleId) => {\n        return renewedModules.indexOf(moduleId) < 0;\n      });\n\n      if (unacceptedModules.length) {\n        console.warn(\n          '[HMRClient] Not every module was accepted - full reload needed',\n          { unacceptedModules }\n        );\n        this.app.reload();\n      } else {\n        console.debug('[HMRClient] Renewed modules - app is up to date', {\n          renewedModules,\n        });\n        this.app.dismissErrors();\n      }\n    } catch (error) {\n      if (module.hot?.status() === 'fail' || module.hot?.status() === 'abort') {\n        console.warn(\n          '[HMRClient] Cannot check for update - full reload needed'\n        );\n        console.warn('[HMRClient]', error);\n        this.app.reload();\n      } else {\n        console.warn('[HMRClient] Update check failed', { error });\n      }\n    } finally {\n      this.app.hideLoadingView();\n    }\n  }\n}\n\nif (__DEV__ && module.hot) {\n  const reload = () => {\n    const DevSettings = require('react-native/Libraries/Utilities/DevSettings');\n    DevSettings.reload();\n  };\n\n  const dismissErrors = () => {\n    const Platform = require('react-native/Libraries/Utilities/Platform');\n    if (Platform.OS === 'ios') {\n      const NativeRedBox =\n        require('react-native/Libraries/NativeModules/specs/NativeRedBox').default;\n      NativeRedBox?.dismiss?.();\n    } else {\n      const NativeExceptionsManager =\n        require('react-native/Libraries/Core/NativeExceptionsManager').default;\n      NativeExceptionsManager?.dismissRedbox();\n    }\n    const LogBoxData = require('react-native/Libraries/LogBox/Data/LogBoxData');\n    LogBoxData.clear();\n  };\n\n  const showLoadingView = (text: string, type: 'load' | 'refresh') => {\n    let LoadingView: LoadingViewModule;\n    if (__REACT_NATIVE_MINOR_VERSION__ >= 75) {\n      LoadingView = require('react-native/Libraries/Utilities/DevLoadingView');\n    } else {\n      LoadingView = require('react-native/Libraries/Utilities/LoadingView');\n    }\n\n    // @ts-ignore\n    LoadingView.showMessage(text, type);\n  };\n\n  const hideLoadingView = () => {\n    let LoadingView: LoadingViewModule;\n    if (__REACT_NATIVE_MINOR_VERSION__ >= 75) {\n      LoadingView = require('react-native/Libraries/Utilities/DevLoadingView');\n    } else {\n      LoadingView = require('react-native/Libraries/Utilities/LoadingView');\n    }\n\n    // @ts-ignore\n    LoadingView.hide();\n  };\n\n  new HMRClient({\n    reload,\n    dismissErrors,\n    showLoadingView,\n    hideLoadingView,\n  });\n}\n"],"mappings":"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","ignoreList":[]}