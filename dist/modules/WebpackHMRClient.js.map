{"version":3,"file":"WebpackHMRClient.js","names":["TcpSocket","getDevServerLocation","HMRClient","lastHash","constructor","app","url","hostname","__PUBLIC_PORT__","__PLATFORM__","socket","WebSocket","console","log","onopen","onclose","onerror","event","onmessage","processMessage","JSON","parse","data","toString","error","warn","upToDate","hash","__webpack_hash__","sendTcpSocket","message","tempConnection","createConnection","port","host","__LISTENER_IP__","reuseAddress","json","stringify","_webpack","write","destroy","on","e","action","LoadingView","showMessage","name","body","time","errors","length","fileUrl","forEach","moduleName","n","lastIndexOf","substring","warnings","warning","applyUpdate","update","module","hot","Error","hide","status","checkUpdates","updatedModules","check","reload","renewedModules","apply","ignoreDeclined","ignoreUnaccepted","ignoreErrored","onDeclined","chain","unacceptedModules","filter","moduleId","indexOf","dismissErrors","__DEV__","DevSettings","Platform","require","OS","NativeRedBox","default","dismiss","NativeExceptionsManager","dismissRedbox","LogBoxData","clear"],"sources":["../../src/modules/WebpackHMRClient.ts"],"sourcesContent":["/* eslint-env browser */\n/* globals __webpack_hash__, __DEV__, __PLATFORM__, __PUBLIC_PORT__, __LISTENER_IP__ */\n\nimport TcpSocket from 'react-native-tcp-socket';\nimport type { HMRMessage, HMRMessageBody } from '../types';\nimport { getDevServerLocation } from './getDevServerLocation';\n\nclass HMRClient {\n  url: string;\n  socket: WebSocket;\n  listener: TcpSocket.Socket | undefined;\n  lastHash = '';\n\n  constructor(\n    private app: {\n      reload: () => void;\n      dismissErrors: () => void;\n      LoadingView: {\n        showMessage(text: string, type: 'load' | 'refresh'): void;\n        hide(): void;\n      };\n    }\n  ) {\n    this.url = `ws://${\n      getDevServerLocation().hostname\n    }:${__PUBLIC_PORT__}/__hmr?platform=${__PLATFORM__}`;\n    this.socket = new WebSocket(this.url);\n\n    console.log('[HMRClient] Connecting...', {\n      url: this.url,\n    });\n\n    this.socket.onopen = () => {\n      console.log('[HMRClient] Connected');\n    };\n\n    this.socket.onclose = () => {\n      console.log('[HMRClient] Disconnected');\n    };\n\n    this.socket.onerror = (event) => {\n      console.log('[HMRClient] Error', event);\n    };\n\n    this.socket.onmessage = (event) => {\n      try {\n        this.processMessage(JSON.parse(event.data.toString()));\n      } catch (error) {\n        console.warn('[HMRClient] Invalid HMR message', { event, error });\n      }\n    };\n  }\n\n  upToDate(hash?: string) {\n    if (hash) {\n      this.lastHash = hash;\n    }\n    return this.lastHash === __webpack_hash__;\n  }\n\n  sendTcpSocket(message: string) {\n    let tempConnection: TcpSocket.Socket | null = null;\n\n    try {\n      tempConnection = TcpSocket.createConnection(\n        {\n          port: 9093,\n          host: __LISTENER_IP__,\n          reuseAddress: true,\n        },\n        () => {\n          const json = JSON.stringify({ _webpack: message });\n          tempConnection?.write(json);\n          tempConnection?.destroy();\n        }\n      );\n      tempConnection.on('error', () => {\n        tempConnection?.destroy();\n      });\n    } catch (e) {\n      console.log('[HMRClient] Send TCPSocket failed: ', e);\n      tempConnection?.destroy();\n    }\n  }\n\n  processMessage(message: HMRMessage) {\n    switch (message.action) {\n      case 'building':\n        this.sendTcpSocket('building');\n\n        this.app.LoadingView.showMessage('Rebuilding...', 'refresh');\n        console.log('[HMRClient] Bundle rebuilding', {\n          name: message.body?.name,\n        });\n        break;\n      case 'built':\n        this.sendTcpSocket('built');\n\n        console.log('[HMRClient] Bundle rebuilt', {\n          name: message.body?.name,\n          time: message.body?.time,\n        });\n      // Fall through\n      case 'sync':\n        if (!message.body) {\n          console.warn('[HMRClient] HMR message body is empty');\n          return;\n        }\n\n        if (message.body.errors?.length) {\n          let fileUrl = '';\n          message.body.errors.forEach((error) => {\n            console.error('Cannot apply update due to error:', error);\n            fileUrl = error?.moduleName || '';\n          });\n          let n = fileUrl.lastIndexOf('/');\n          let moduleName = fileUrl.substring(n + 1);\n          this.app.LoadingView.showMessage(`Failed (${moduleName})`, 'refresh');\n          return;\n        }\n\n        if (message.body.warnings?.length) {\n          message.body.warnings.forEach((warning) => {\n            console.warn('[HMRClient] Bundle contains warnings:', warning);\n          });\n        }\n\n        this.applyUpdate(message.body);\n    }\n  }\n\n  applyUpdate(update: HMRMessageBody) {\n    if (!module.hot) {\n      throw new Error('[HMRClient] Hot Module Replacement is disabled.');\n    }\n\n    const upToDate = this.upToDate(update.hash);\n\n    if (upToDate) {\n      this.app.LoadingView.hide();\n    } else if (module.hot.status() === 'idle') {\n      console.log('[HMRClient] Checking for updates on the server...');\n      this.checkUpdates(update);\n    }\n  }\n\n  async checkUpdates(update: HMRMessageBody) {\n    try {\n      this.app.LoadingView.showMessage('Refreshing...', 'refresh');\n      const updatedModules = await module.hot?.check(false);\n      if (!updatedModules) {\n        console.warn('[HMRClient] Cannot find update - full reload needed');\n        this.app.reload();\n        return;\n      }\n\n      const renewedModules = await module.hot?.apply({\n        ignoreDeclined: true,\n        ignoreUnaccepted: false,\n        ignoreErrored: false,\n        onDeclined: (data) => {\n          // This module declined update, no need to do anything\n          console.warn('[HMRClient] Ignored an update due to declined module', {\n            chain: data.chain,\n          });\n        },\n      });\n\n      if (!this.upToDate()) {\n        this.checkUpdates(update);\n      }\n\n      // Double check to make sure all updated modules were accepted (renewed)\n      const unacceptedModules = updatedModules.filter((moduleId) => {\n        return renewedModules && renewedModules.indexOf(moduleId) < 0;\n      });\n\n      if (unacceptedModules.length) {\n        console.warn(\n          '[HMRClient] Not every module was accepted - full reload needed',\n          { unacceptedModules }\n        );\n        this.app.reload();\n      } else {\n        console.log('[HMRClient] Renewed modules - app is up to date', {\n          renewedModules,\n        });\n        this.app.dismissErrors();\n      }\n    } catch (error) {\n      if (module.hot?.status() === 'fail' || module.hot?.status() === 'abort') {\n        console.warn(\n          '[HMRClient] Cannot check for update - full reload needed'\n        );\n        console.warn('[HMRClient]', error);\n        this.app.reload();\n      } else {\n        console.warn('[HMRClient] Update check failed', { error });\n      }\n    } finally {\n      this.app.LoadingView.hide();\n    }\n  }\n}\n\nif (__DEV__ && module.hot) {\n  const { DevSettings, Platform } = require('react-native');\n  const LoadingView = require('react-native/Libraries/Utilities/LoadingView');\n\n  const reload = () => DevSettings.reload();\n  const dismissErrors = () => {\n    if (Platform.OS === 'ios') {\n      const NativeRedBox =\n        require('react-native/Libraries/NativeModules/specs/NativeRedBox').default;\n      NativeRedBox?.dismiss?.();\n    } else {\n      const NativeExceptionsManager =\n        require('react-native/Libraries/Core/NativeExceptionsManager').default;\n      NativeExceptionsManager?.dismissRedbox();\n    }\n\n    const LogBoxData = require('react-native/Libraries/LogBox/Data/LogBoxData');\n    LogBoxData.clear();\n  };\n\n  new HMRClient({ reload, dismissErrors, LoadingView });\n}\n"],"mappings":"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"}