{"version":3,"file":"WebpackHMRClient.js","names":["TcpSocket","getDevServerLocation","HMRClient","lastCompilationHash","constructor","app","url","host","socket","WebSocket","console","debug","onopen","hideLoadingView","onclose","onerror","event","onmessage","processMessage","JSON","parse","data","toString","error","warn","sendTcpSocket","message","tempConnection","createConnection","port","__LISTENER_IP__","reuseAddress","json","stringify","_webpack","write","destroy","on","e","log","body","name","__PLATFORM__","action","handleCompilationInProgress","handleHashUpdate","hash","handleBundleUpdate","showLoadingView","tryApplyUpdates","isUpdateAvailable","__webpack_hash__","module","hot","reload","status","handleApplyUpdates","err","updatedModules","forcedReload","check","onAccepted","dismissErrors","onDeclined","onErrored","onUnaccepted","onDisposed","then","outdatedModules","__DEV__","DevSettings","require","LogBox","NativeRedBox","default","dismiss","NativeExceptionsManager","dismissRedbox","clearAllLogs","text","type","LoadingView","__REACT_NATIVE_MINOR_VERSION__","showMessage","hide"],"sources":["../../src/modules/WebpackHMRClient.ts"],"sourcesContent":["import TcpSocket from 'react-native-tcp-socket';\nimport type { HMRMessage } from '../types.js';\nimport { getDevServerLocation } from './getDevServerLocation.js';\n\ninterface RNLoadingView {\n  hide(): void;\n  showMessage(text: string, type: string): void;\n}\n\ninterface RNDevSettings {\n  reload(): void;\n}\n\ninterface RNLogBox {\n  clearAllLogs(): void;\n}\n\nclass HMRClient {\n  url: string;\n  socket: WebSocket;\n  listener: TcpSocket.Socket | undefined;\n  // state\n  lastCompilationHash: string | null = null;\n\n  constructor(\n    private app: {\n      reload: () => void;\n      dismissErrors: () => void;\n      showLoadingView: (text: string, type: 'load' | 'refresh') => void;\n      hideLoadingView: () => void;\n    }\n  ) {\n    this.url = `ws://${getDevServerLocation().host}/__hmr`;\n    this.socket = new WebSocket(this.url);\n\n    console.debug('[HMRClient] Connecting...', {\n      url: this.url,\n    });\n\n    this.socket.onopen = () => {\n      console.debug('[HMRClient] Connected');\n      // hide the `Downloading 100%` message\n      this.app.hideLoadingView();\n    };\n\n    this.socket.onclose = () => {\n      console.debug('[HMRClient] Disconnected');\n    };\n\n    this.socket.onerror = (event) => {\n      console.debug('[HMRClient] Error', event);\n    };\n\n    this.socket.onmessage = (event) => {\n      try {\n        this.processMessage(JSON.parse(event.data.toString()));\n      } catch (error) {\n        console.warn('[HMRClient] Invalid HMR message', { event, error });\n      }\n    };\n  }\n\n  sendTcpSocket(message: string) {\n    let tempConnection: TcpSocket.Socket | null = null;\n\n    try {\n      tempConnection = TcpSocket.createConnection(\n        {\n          port: 9093,\n          host: __LISTENER_IP__,\n          reuseAddress: true,\n        },\n        () => {\n          const json = JSON.stringify({ _webpack: message });\n          tempConnection?.write(json);\n          tempConnection?.destroy();\n        }\n      );\n      tempConnection.on('error', () => {\n        tempConnection?.destroy();\n      });\n    } catch (e) {\n      console.log('[HMRClient] Send TCPSocket failed: ', e);\n      tempConnection?.destroy();\n    }\n  }\n\n  processMessage(message: HMRMessage) {\n    // Only process messages for the target platform\n    if (message.body.name !== __PLATFORM__) {\n      return;\n    }\n\n    switch (message.action) {\n      case 'compiling':\n        this.sendTcpSocket('building');\n        this.handleCompilationInProgress();\n        break;\n      case 'hash':\n        this.handleHashUpdate(message.body.hash);\n        break;\n      case 'ok':\n        this.sendTcpSocket('built');\n        this.handleBundleUpdate();\n        break;\n    }\n  }\n\n  handleCompilationInProgress() {\n    console.debug('[HMRClient] Processing progress update');\n    this.app.showLoadingView('Compiling...', 'refresh');\n  }\n\n  handleHashUpdate(hash?: string) {\n    console.debug('[HMRClient] Processing hash update');\n    this.lastCompilationHash = hash ?? null;\n  }\n\n  handleBundleUpdate() {\n    console.debug('[HMRClient] Processing bundle update');\n    this.tryApplyUpdates();\n    this.app.hideLoadingView();\n  }\n\n  isUpdateAvailable() {\n    return this.lastCompilationHash !== __webpack_hash__;\n  }\n\n  // Attempt to update code on the fly, fall back to a hard reload.\n  tryApplyUpdates() {\n    // detect is there a newer version of this code available\n    if (!this.isUpdateAvailable()) {\n      return;\n    }\n\n    if (!module.hot) {\n      // HMR is not enabled\n      this.app.reload();\n      return;\n    }\n\n    if (module.hot.status() !== 'idle') {\n      // HMR is disallowed in other states than 'idle'\n      return;\n    }\n\n    const handleApplyUpdates = (\n      err: unknown,\n      updatedModules: (string | number)[] | null\n    ) => {\n      const forcedReload = err || !updatedModules;\n      if (forcedReload) {\n        console.warn('[HMRClient] Forced reload');\n        if (err) {\n          console.debug('[HMRClient] Forced reload caused by: ', err);\n        }\n        this.app.reload();\n        return;\n      }\n\n      if (this.isUpdateAvailable()) {\n        // While we were updating, there was a new update! Do it again.\n        this.tryApplyUpdates();\n      }\n    };\n\n    console.debug('[HMRClient] Checking for updates on the server...');\n    module.hot\n      .check({\n        onAccepted: this.app.dismissErrors,\n        onDeclined: this.app.dismissErrors,\n        onErrored: this.app.dismissErrors,\n        onUnaccepted: this.app.dismissErrors,\n        onDisposed: this.app.dismissErrors,\n      })\n      .then(\n        (outdatedModules) => handleApplyUpdates(null, outdatedModules),\n        (err) => handleApplyUpdates(err, null)\n      );\n  }\n}\n\nif (__DEV__ && module.hot) {\n  const reload = () => {\n    const DevSettings: RNDevSettings = require('react-native').DevSettings;\n    DevSettings.reload();\n  };\n\n  const dismissErrors = () => {\n    const LogBox: RNLogBox = require('react-native').LogBox;\n\n    if (__PLATFORM__ === 'ios') {\n      const NativeRedBox =\n        require('react-native/Libraries/NativeModules/specs/NativeRedBox').default;\n      NativeRedBox?.dismiss?.();\n    } else {\n      const NativeExceptionsManager =\n        require('react-native/Libraries/Core/NativeExceptionsManager').default;\n      NativeExceptionsManager?.dismissRedbox();\n    }\n\n    LogBox.clearAllLogs();\n  };\n\n  const showLoadingView = (text: string, type: 'load' | 'refresh') => {\n    let LoadingView: RNLoadingView;\n    if (__REACT_NATIVE_MINOR_VERSION__ >= 79) {\n      LoadingView =\n        require('react-native/Libraries/Utilities/DevLoadingView').default;\n    } else if (__REACT_NATIVE_MINOR_VERSION__ >= 75) {\n      LoadingView = require('react-native/Libraries/Utilities/DevLoadingView');\n    } else {\n      LoadingView = require('react-native/Libraries/Utilities/LoadingView');\n    }\n\n    LoadingView.showMessage(text, type);\n  };\n\n  const hideLoadingView = () => {\n    let LoadingView: RNLoadingView;\n    if (__REACT_NATIVE_MINOR_VERSION__ >= 79) {\n      LoadingView =\n        require('react-native/Libraries/Utilities/DevLoadingView').default;\n    } else if (__REACT_NATIVE_MINOR_VERSION__ >= 75) {\n      LoadingView = require('react-native/Libraries/Utilities/DevLoadingView');\n    } else {\n      LoadingView = require('react-native/Libraries/Utilities/LoadingView');\n    }\n\n    LoadingView.hide();\n  };\n\n  new HMRClient({\n    reload,\n    dismissErrors,\n    showLoadingView,\n    hideLoadingView,\n  });\n}\n"],"mappings":"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","ignoreList":[]}