{"version":3,"file":"DevServerClient.js","names":["prettyFormat","getDevServerLocation","DevServerClient","buffer","constructor","initSocket","address","host","socket","WebSocket","onClose","event","console","warn","message","undefined","onclose","onerror","onopen","flushBuffer","__DEV__","send","level","data","JSON","stringify","type","map","item","escapeString","highlight","maxDepth","min","plugins","ReactElement","log","readyState","OPEN","push","client","setup","enable","disable","registerBundle","unstable_notifyFuseboxConsoleEnabled"],"sources":["../../src/modules/DevServerClient.ts"],"sourcesContent":["import prettyFormat from 'pretty-format';\nimport { getDevServerLocation } from './getDevServerLocation.js';\n\n/**\n * With Webpack we don't use built-in metro-specific HMR client,\n * so the module `react-native/Libraries/Utilities/HMRClient.js` should be replaced with this one.\n *\n * Most of the code is noop apart from the `log` function which handles sending logs from client\n * application to the dev server.\n *\n * The console gets \"polyfilled\" here:\n * https://github.com/facebook/react-native/blob/v0.63.4/Libraries/Core/setUpDeveloperTools.js#L51-L69\n */\n\nclass DevServerClient {\n  socket?: WebSocket;\n  buffer: Array<{ level: string; data: any[] }> = [];\n\n  constructor() {\n    const initSocket = () => {\n      const address = `ws://${getDevServerLocation().host}/__client`;\n      this.socket = new WebSocket(address);\n\n      const onClose = (event: Event) => {\n        console.warn(\n          'Disconnected from the Dev Server:',\n          (event as unknown as { message: string | null }).message\n        );\n        this.socket = undefined;\n      };\n\n      this.socket.onclose = onClose;\n      this.socket.onerror = onClose;\n      this.socket.onopen = () => {\n        this.flushBuffer();\n      };\n    };\n\n    if (__DEV__) {\n      initSocket();\n    }\n  }\n\n  send(level: string, data: any[]) {\n    try {\n      this.socket?.send(\n        JSON.stringify({\n          type: 'client-log',\n          level,\n          data: data.map((item: any) =>\n            typeof item === 'string'\n              ? item\n              : prettyFormat(item, {\n                  escapeString: true,\n                  highlight: true,\n                  maxDepth: 3,\n                  min: true,\n                  plugins: [prettyFormat.plugins.ReactElement],\n                })\n          ),\n        })\n      );\n    } catch {\n      // Ignore error\n    }\n  }\n\n  flushBuffer() {\n    for (const { level, data } of this.buffer) {\n      this.send(level, data);\n    }\n\n    this.buffer = [];\n  }\n\n  log(level: string, data: any[]) {\n    if (this.socket && this.socket.readyState === WebSocket.OPEN) {\n      this.flushBuffer();\n      this.send(level, data);\n    } else {\n      this.buffer.push({ level, data });\n    }\n  }\n}\n\nconst client = new DevServerClient();\n\n// React Native < 0.79\nexport function setup() {}\nexport function enable() {}\nexport function disable() {}\nexport function registerBundle() {}\nexport function log(level: string, data: any[]) {\n  client.log(level, data);\n}\nexport function unstable_notifyFuseboxConsoleEnabled() {}\n\n// React Native >= 0.79\nexport default {\n  setup,\n  enable,\n  disable,\n  registerBundle,\n  log,\n  unstable_notifyFuseboxConsoleEnabled,\n};\n"],"mappings":"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","ignoreList":[]}