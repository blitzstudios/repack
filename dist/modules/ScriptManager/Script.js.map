{"version":3,"file":"Script.js","names":["shallowEqual","Script","DEFAULT_TIMEOUT","getDevServerURL","scriptId","webpackContext","p","u","getFileSystemURL","getRemoteURL","url","options","excludeExtension","from","key","locator","fetch","headers","Headers","forEach","value","toLowerCase","body","FormData","bodyObject","console","warn","JSON","stringify","URLSearchParams","undefined","Error","caller","method","absolute","timeout","query","toString","Object","keys","length","cache","verifyScriptSignature","constructor","shouldUpdateCache","cachedData","checkIfCacheDataOutdated","shouldRefetch","diffs","some","diff","getCacheData","toObject"],"sources":["../../../src/modules/ScriptManager/Script.ts"],"sourcesContent":["import shallowEqual from 'shallowequal';\nimport type {\n  NormalizedScriptLocator,\n  ScriptLocator,\n  WebpackContext,\n} from './types';\n\n/**\n * Representation of a Script to load and execute, used by {@link ScriptManager}.\n *\n * When adding resolvers to `ScriptManager` in `ScriptManager.shared.addResolver(...)`, you can use\n * `Script.getDevServerURL(...)`, `Script.getFileSystemURL(...)` or `Script.getRemoteURL(...)`\n * to create a `url` for the script.\n *\n * Other methods are designed for internal use only.\n */\nexport class Script {\n  static DEFAULT_TIMEOUT = 30000; // 30s\n\n  /**\n   * Get URL of a script hosted on development server.\n   *\n   * @param scriptId Id of the script.\n   */\n  static getDevServerURL(scriptId: string) {\n    return (webpackContext: WebpackContext) =>\n      `${webpackContext.p}${webpackContext.u(scriptId)}`;\n  }\n\n  /**\n   * Get URL of a script stored on filesystem on the target mobile device.\n   *\n   * @param scriptId Id of the script.\n   */\n  static getFileSystemURL(scriptId: string) {\n    return (webpackContext: WebpackContext) =>\n      webpackContext.u(`file:///${scriptId}`);\n  }\n\n  /**\n   * Get URL of a script hosted on a remote server.\n   *\n   * By default `.chunk.bundle` extension will be added to the URL.\n   * If your script has different extension, you should pass `{ excludeExtension: true }` as 2nd argument.\n   *\n   * @param url A URL to remote location where the script is stored.\n   * @param options Additional options.\n   */\n  static getRemoteURL(\n    url: string,\n    options: { excludeExtension?: boolean } = {}\n  ) {\n    if (options.excludeExtension) {\n      return url;\n    }\n\n    return (webpackContext: WebpackContext) => webpackContext.u(url);\n  }\n\n  /**\n   * Create new instance of `Script` from non-normalized script locator data.\n   *\n   * @param locator Non-normalized locator data.\n   * @param fetch Initial flag for whether script should be fetched or not.\n   *\n   * @internal\n   */\n  static from(\n    key: { scriptId: string; caller?: string },\n    locator: ScriptLocator,\n    fetch: boolean\n  ) {\n    const headers: Record<string, string> = {};\n    new Headers(locator.headers).forEach((value: string, key: string) => {\n      headers[key.toLowerCase()] = value;\n    });\n\n    let body: NormalizedScriptLocator['body'];\n    if (locator.body instanceof FormData) {\n      const bodyObject: Record<string, string> = {};\n      locator.body.forEach((value, key) => {\n        if (typeof value === 'string') {\n          bodyObject[key] = value;\n        } else {\n          console.warn('Script does not support File as FormData key in body');\n        }\n      });\n      body = JSON.stringify(bodyObject);\n    } else if (locator.body instanceof URLSearchParams) {\n      const bodyObject: Record<string, string> = {};\n      locator.body.forEach((value, key) => {\n        bodyObject[key] = value;\n      });\n      body = JSON.stringify(bodyObject);\n    } else {\n      body = locator.body ?? undefined;\n    }\n\n    if (typeof locator.url === 'function') {\n      throw new Error('Property url as a function is not support');\n    }\n\n    return new Script(\n      key.scriptId,\n      key.caller,\n      {\n        method: locator.method ?? 'GET',\n        url: locator.url,\n        absolute: locator.absolute ?? false,\n        timeout: locator.timeout ?? Script.DEFAULT_TIMEOUT,\n        query: new URLSearchParams(locator.query).toString() || undefined,\n        body,\n        headers: Object.keys(headers).length ? headers : undefined,\n        fetch: locator.cache === false ? true : fetch,\n        verifyScriptSignature: locator.verifyScriptSignature ?? 'off',\n      },\n      locator.cache\n    );\n  }\n\n  /**\n   * Constructs new representation of a script.\n   *\n   * @param locator Normalized locator data.\n   * @param cache Flag whether use cache or not, `true` by default.\n   *\n   * @internal\n   */\n  constructor(\n    public readonly scriptId: string,\n    public readonly caller: string | undefined,\n    public readonly locator: NormalizedScriptLocator,\n    public readonly cache: boolean = true\n  ) {}\n\n  /**\n   * Check if the script was already cached and cache should be updated with new data.\n   *\n   * @param cachedData Cached data for the same script.\n   *\n   * @internal\n   */\n  shouldUpdateCache(\n    cachedData: Pick<\n      NormalizedScriptLocator,\n      'method' | 'url' | 'query' | 'headers' | 'body'\n    >\n  ) {\n    if (!this.cache || !cachedData) {\n      return false;\n    }\n\n    return this.checkIfCacheDataOutdated(cachedData);\n  }\n\n  /**\n   * Check if the script should be fetched again or reused,\n   * based on previous cached data.\n   *\n   * @param cachedData Cached data for the same script.\n   *\n   * @internal\n   */\n  shouldRefetch(\n    cachedData: Pick<\n      NormalizedScriptLocator,\n      'method' | 'url' | 'query' | 'headers' | 'body'\n    >\n  ) {\n    if (!this.cache) {\n      return true;\n    }\n\n    return this.checkIfCacheDataOutdated(cachedData);\n  }\n\n  /**\n   * Check if previous cached data is the same as the new one.\n   *\n   * @param cachedData Cached data for the same script.\n   *\n   * @internal\n   */\n  checkIfCacheDataOutdated(\n    cachedData: Pick<\n      NormalizedScriptLocator,\n      'method' | 'url' | 'query' | 'headers' | 'body'\n    >\n  ) {\n    const diffs = [\n      cachedData.method !== this.locator.method,\n      cachedData.url !== this.locator.url,\n      cachedData.query !== this.locator.query,\n      !shallowEqual(cachedData.headers, this.locator.headers),\n      cachedData.body !== this.locator.body,\n    ];\n\n    return diffs.some((diff) => diff);\n  }\n\n  /**\n   * Get object to store in cache.\n   *\n   * @internal\n   */\n  getCacheData() {\n    return {\n      method: this.locator.method,\n      url: this.locator.url,\n      query: this.locator.query,\n      headers: this.locator.headers,\n      body: this.locator.body,\n    };\n  }\n\n  toObject() {\n    return {\n      scriptId: this.scriptId,\n      caller: this.caller,\n      locator: this.locator,\n      cache: this.cache,\n    };\n  }\n}\n"],"mappings":"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","ignoreList":[]}