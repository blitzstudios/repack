{"version":3,"file":"RepackTargetPlugin.js","names":["_nodePath","_interopRequireDefault","require","_GuardedRequireRuntimeModule","_InitRuntimeModule","_LoadScriptRuntimeModule","e","__esModule","default","RepackTargetPlugin","replaceRuntimeModule","module","content","getGeneratedCode","source","undefined","Buffer","from","Error","apply","compiler","globalObject","options","target","output","chunkLoading","chunkFormat","webpack","BannerPlugin","raw","entryOnly","banner","Template","asString","NormalModuleReplacementPlugin","resource","request","resolve","context","path","dirname","createData","hooks","compilation","tap","additionalTreeRuntimeRequirements","chunk","addRuntimeModule","makeGuardedRequireRuntimeModule","makeInitRuntimeModule","thisCompilation","runtimeModule","name","loadScriptRuntimeModule","makeLoadScriptRuntimeModule","chunkId","id","hmrEnabled","devServer","hot","generate","exports"],"sources":["../../../src/plugins/RepackTargetPlugin/RepackTargetPlugin.ts"],"sourcesContent":["import path from 'node:path';\nimport type { Compilation, Compiler, RspackPluginInstance } from '@rspack/core';\nimport type { RuntimeModule as WebpackRuntimeModule } from 'webpack';\nimport { makeGuardedRequireRuntimeModule } from './GuardedRequireRuntimeModule.js';\nimport { makeInitRuntimeModule } from './InitRuntimeModule.js';\nimport { makeLoadScriptRuntimeModule } from './LoadScriptRuntimeModule.js';\n\ntype RspackRuntimeModule = Parameters<\n  Compilation['hooks']['runtimeModule']['call']\n>[0];\n\n/**\n * Plugin for tweaking the JavaScript runtime code to account for React Native environment.\n *\n * Globally available APIs differ with React Native and other target's like Web, so there are some\n * tweaks necessary to make the final bundle runnable inside React Native's JavaScript VM.\n *\n * @category Webpack Plugin\n */\nexport class RepackTargetPlugin implements RspackPluginInstance {\n  replaceRuntimeModule(\n    module: RspackRuntimeModule | WebpackRuntimeModule,\n    content: string\n  ) {\n    // webpack\n    if ('getGeneratedCode' in module) {\n      module.getGeneratedCode = () => content;\n      return;\n    }\n\n    // rspack\n    if (module.source !== undefined) {\n      module.source.source = Buffer.from(content, 'utf-8');\n    } else {\n      // should never happen\n      throw new Error('Module source is not available');\n    }\n  }\n  /**\n   * Apply the plugin.\n   *\n   * @param compiler Webpack compiler instance.\n   */\n  apply(compiler: Compiler) {\n    const globalObject = 'self';\n    compiler.options.target = false;\n    compiler.options.output.chunkLoading = 'jsonp';\n    compiler.options.output.chunkFormat = 'array-push';\n    compiler.options.output.globalObject = globalObject;\n\n    // Normalize global object.\n    new compiler.webpack.BannerPlugin({\n      raw: true,\n      entryOnly: true,\n      banner: compiler.webpack.Template.asString([\n        `/******/ var ${globalObject} = ${globalObject} || this || new Function(\"return this\")() || ({}); // repackGlobal'`,\n        '/******/',\n      ]),\n    }).apply(compiler);\n\n    // Replace React Native's HMRClient.js with custom Webpack-powered DevServerClient.\n    new compiler.webpack.NormalModuleReplacementPlugin(\n      /react-native.*?([/\\\\]+)Libraries([/\\\\]+)Utilities([/\\\\]+)HMRClient\\.js$/,\n      (resource) => {\n        const request = require.resolve('../../modules/DevServerClient.js');\n        const context = path.dirname(request);\n        resource.request = request;\n        resource.context = context;\n        // @ts-expect-error incomplete rspack types\n        resource.createData.resource = request;\n        // @ts-expect-error incomplete rspack types\n        resource.createData.context = context;\n      }\n    ).apply(compiler);\n\n    // ReactNativePrivateInitializeCore.js is an unnecessary module exisiting in order to make metro happy\n    // it reexports InitializeCore which is included as one of the initial modules running before main entrypoint\n    // making this module noop makes inlining entry modules possible which might improve startup time\n    new compiler.webpack.NormalModuleReplacementPlugin(\n      /react-native.*?([/\\\\]+)Libraries[/\\\\]ReactPrivate[/\\\\]ReactNativePrivateInitializeCore\\.js$/,\n      require.resolve('../../modules/EmptyModule.js')\n    ).apply(compiler);\n\n    // ReactNativeTypes.js is flow type only module\n    new compiler.webpack.NormalModuleReplacementPlugin(\n      /react-native.*?([/\\\\]+)Libraries[/\\\\]Renderer[/\\\\]shims[/\\\\]ReactNativeTypes\\.js$/,\n      require.resolve('../../modules/EmptyModule.js')\n    ).apply(compiler);\n\n    compiler.hooks.compilation.tap('RepackTargetPlugin', (compilation) => {\n      compilation.hooks.additionalTreeRuntimeRequirements.tap(\n        'RepackTargetPlugin',\n        (chunk) => {\n          compilation.addRuntimeModule(\n            chunk,\n            makeGuardedRequireRuntimeModule(compiler, { globalObject })\n          );\n\n          compilation.addRuntimeModule(\n            chunk,\n            makeInitRuntimeModule(compiler, { globalObject })\n          );\n        }\n      );\n    });\n\n    compiler.hooks.thisCompilation.tap('RepackTargetPlugin', (compilation) => {\n      compilation.hooks.runtimeModule.tap(\n        'RepackTargetPlugin',\n        (module, chunk) => {\n          if (module.name === 'load_script' || module.name === 'load script') {\n            const loadScriptRuntimeModule = makeLoadScriptRuntimeModule(\n              compiler,\n              {\n                chunkId: chunk.id ?? undefined,\n                hmrEnabled: !!compiler.options.devServer?.hot,\n              }\n            );\n\n            // inject runtime module\n            this.replaceRuntimeModule(\n              module,\n              loadScriptRuntimeModule.generate()\n            );\n          }\n\n          // Remove CSS runtime modules\n          if (\n            module.name === 'css_loading' ||\n            module.name === 'get css chunk filename'\n          ) {\n            this.replaceRuntimeModule(module, '// noop');\n          }\n        }\n      );\n    });\n  }\n}\n"],"mappings":"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","ignoreList":[]}