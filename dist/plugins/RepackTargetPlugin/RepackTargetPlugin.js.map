{"version":3,"file":"RepackTargetPlugin.js","names":["_nodePath","_interopRequireDefault","require","e","__esModule","default","RepackTargetPlugin","constructor","config","replaceRuntimeModule","module","content","getGeneratedCode","source","undefined","Buffer","from","Error","apply","compiler","Template","webpack","globalObject","options","target","output","chunkLoading","chunkFormat","BannerPlugin","raw","entryOnly","banner","asString","NormalModuleReplacementPlugin","resource","request","resolve","context","path","dirname","createData","hooks","thisCompilation","tap","compilation","runtimeModule","chunk","name","loadScriptGlobal","RuntimeGlobals","loadScript","loadScriptRuntimeModule","getFunctionContent","replaceAll","id","toString","initRuntimeModule","hmr","repackRuntimeModule","exports"],"sources":["../../../src/plugins/RepackTargetPlugin/RepackTargetPlugin.ts"],"sourcesContent":["import path from 'node:path';\nimport type { Compilation, Compiler, RspackPluginInstance } from '@rspack/core';\nimport type { RuntimeModule as WebpackRuntimeModule } from 'webpack';\n\ntype RspackRuntimeModule = Parameters<\n  Compilation['hooks']['runtimeModule']['call']\n>[0];\n\n/**\n * {@link RepackTargetPlugin} configuration options.\n */\nexport interface RepackTargetPluginConfig {\n  hmr?: boolean;\n}\n\n/**\n * Plugin for tweaking the JavaScript runtime code to account for React Native environment.\n *\n * Globally available APIs differ with React Native and other target's like Web, so there are some\n * tweaks necessary to make the final bundle runnable inside React Native's JavaScript VM.\n *\n * @category Webpack Plugin\n */\nexport class RepackTargetPlugin implements RspackPluginInstance {\n  /**\n   * Constructs new `RepackTargetPlugin`.\n   *\n   * @param config Plugin configuration options.\n   */\n  constructor(private config?: RepackTargetPluginConfig) {}\n\n  replaceRuntimeModule(\n    module: RspackRuntimeModule | WebpackRuntimeModule,\n    content: string\n  ) {\n    // webpack\n    if ('getGeneratedCode' in module) {\n      module.getGeneratedCode = () => content;\n      return;\n    }\n\n    // rspack\n    if (module.source !== undefined) {\n      module.source.source = Buffer.from(content, 'utf-8');\n    } else {\n      // should never happen\n      throw new Error('Module source is not available');\n    }\n  }\n  /**\n   * Apply the plugin.\n   *\n   * @param compiler Webpack compiler instance.\n   */\n  apply(compiler: Compiler) {\n    const Template = compiler.webpack.Template;\n\n    const globalObject = 'self';\n    compiler.options.target = false;\n    compiler.options.output.chunkLoading = 'jsonp';\n    compiler.options.output.chunkFormat = 'array-push';\n    compiler.options.output.globalObject = globalObject;\n\n    // Normalize global object.\n    new compiler.webpack.BannerPlugin({\n      raw: true,\n      entryOnly: true,\n      banner: Template.asString([\n        `/******/ var ${globalObject} = ${globalObject} || this || new Function(\"return this\")() || ({}); // repackGlobal'`,\n        '/******/',\n      ]),\n    }).apply(compiler);\n\n    // Replace React Native's HMRClient.js with custom Webpack-powered DevServerClient.\n    new compiler.webpack.NormalModuleReplacementPlugin(\n      /react-native.*?([/\\\\]+)Libraries([/\\\\]+)Utilities([/\\\\]+)HMRClient\\.js$/,\n      (resource) => {\n        const request = require.resolve('../../modules/DevServerClient');\n        const context = path.dirname(request);\n        resource.request = request;\n        resource.context = context;\n        // @ts-ignore\n        resource.createData.resource = request;\n        // @ts-ignore\n        resource.createData.context = context;\n      }\n    ).apply(compiler);\n\n    // ReactNativeTypes.js is flow type only module\n    new compiler.webpack.NormalModuleReplacementPlugin(\n      /react-native.*?([/\\\\]+)Libraries[/\\\\]Renderer[/\\\\]shims[/\\\\]ReactNativeTypes\\.js$/,\n      require.resolve('../../modules/EmptyModule')\n    ).apply(compiler);\n\n    compiler.hooks.thisCompilation.tap('RepackTargetPlugin', (compilation) => {\n      compilation.hooks.runtimeModule.tap(\n        'RepackTargetPlugin',\n        (module, chunk) => {\n          /**\n           * We inject RePack's runtime modules only when load_script module is present.\n           * This module is injected when:\n           * 1. HMR is enabled\n           * 2. Dynamic import is used anywhere in the project\n           */\n          if (module.name === 'load_script' || module.name === 'load script') {\n            const loadScriptGlobal = compiler.webpack.RuntimeGlobals.loadScript;\n            const loadScriptRuntimeModule = Template.asString([\n              Template.getFunctionContent(\n                require('./implementation/loadScript')\n              )\n                .replaceAll('$loadScript$', loadScriptGlobal)\n                .replaceAll('$caller$', `'${chunk.id?.toString()}'`),\n            ]);\n\n            const initRuntimeModule = Template.asString([\n              '// Repack runtime initialization logic',\n              Template.getFunctionContent(require('./implementation/init'))\n                .replaceAll('$globalObject$', globalObject)\n                .replaceAll('$hmrEnabled$', `${this.config?.hmr ?? false}`),\n            ]);\n\n            // combine both runtime modules\n            const repackRuntimeModule = `${loadScriptRuntimeModule}\\n${initRuntimeModule}`;\n\n            // inject runtime module\n            this.replaceRuntimeModule(module, repackRuntimeModule.toString());\n          }\n\n          // Remove CSS runtime modules\n          if (\n            module.name === 'css_loading' ||\n            module.name === 'get css chunk filename'\n          ) {\n            this.replaceRuntimeModule(module, '// noop');\n          }\n        }\n      );\n    });\n  }\n}\n"],"mappings":"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","ignoreList":[]}