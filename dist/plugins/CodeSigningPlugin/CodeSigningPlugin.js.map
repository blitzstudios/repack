{"version":3,"file":"CodeSigningPlugin.js","names":["_nodeCrypto","_interopRequireDefault","require","_nodeFs","_nodePath","_nodeUtil","_jsonwebtoken","_config","e","__esModule","default","CodeSigningPlugin","constructor","config","validateConfig","excludeChunks","chunkFilenames","Set","shouldSignFile","file","mainOutputFilename","excludedChunks","has","some","chunk","RegExp","test","apply","compiler","pluginName","name","logger","getInfrastructureLogger","enabled","options","output","filename","Error","TOKEN_BUFFER_SIZE","BEGIN_CS_MARK","privateKeyPath","path","isAbsolute","resolve","context","privateKey","fs","readFileSync","Array","isArray","hooks","emit","tap","compilation","chunks","forEach","files","add","assetEmitted","tapPromise","stage","outputPath","content","mainBundleName","outputOptions","debug","hash","crypto","createHash","update","digest","token","jwt","sign","algorithm","signedBundle","Buffer","concat","from","length","writeFileAsync","util","promisify","outputFileSystem","writeFile","join","exports"],"sources":["../../../src/plugins/CodeSigningPlugin/CodeSigningPlugin.ts"],"sourcesContent":["import crypto from 'node:crypto';\nimport fs from 'node:fs';\nimport path from 'node:path';\nimport util from 'node:util';\nimport type { Compiler, RspackPluginInstance } from '@rspack/core';\nimport jwt from 'jsonwebtoken';\nimport { type CodeSigningPluginConfig, validateConfig } from './config';\n\nexport class CodeSigningPlugin implements RspackPluginInstance {\n  private chunkFilenames: Set<string>;\n\n  /**\n   * Constructs new `RepackPlugin`.\n   *\n   * @param config Plugin configuration options.\n   */\n  constructor(private config: CodeSigningPluginConfig) {\n    validateConfig(config);\n    this.config.excludeChunks = this.config.excludeChunks ?? [];\n    this.chunkFilenames = new Set();\n  }\n\n  private shouldSignFile(\n    file: string,\n    mainOutputFilename: string,\n    excludedChunks: string[] | RegExp[]\n  ): boolean {\n    /** Exclude non-chunks & main chunk as it's always local */\n    if (!this.chunkFilenames.has(file) || file === mainOutputFilename) {\n      return false;\n    }\n\n    return !excludedChunks.some((chunk) => {\n      if (chunk instanceof RegExp) {\n        return chunk.test(file);\n      }\n      return chunk === file;\n    });\n  }\n\n  /**\n   * Apply the plugin.\n   *\n   * @param compiler Webpack compiler instance.\n   */\n  apply(compiler: Compiler) {\n    const pluginName = CodeSigningPlugin.name;\n    const logger = compiler.getInfrastructureLogger(pluginName);\n\n    if (this.config.enabled === false) {\n      return;\n    }\n\n    if (typeof compiler.options.output.filename === 'function') {\n      throw new Error(\n        'CodeSigningPlugin does not support dynamic output filename. Please use static filename instead.'\n      );\n    }\n    /**\n     * Reserve 1280 bytes for the token even if it's smaller\n     * to leave some space for future additions to the JWT without breaking compatibility\n     */\n    const TOKEN_BUFFER_SIZE = 1280;\n    /**\n     * Used to denote beginning of the code-signing section of the bundle\n     * alias for \"Repack Code-Signing Signature Begin\"\n     */\n    const BEGIN_CS_MARK = '/* RCSSB */';\n\n    const privateKeyPath = path.isAbsolute(this.config.privateKeyPath)\n      ? this.config.privateKeyPath\n      : path.resolve(compiler.context, this.config.privateKeyPath);\n    const privateKey = fs.readFileSync(privateKeyPath);\n\n    const excludedChunks = Array.isArray(this.config.excludeChunks)\n      ? this.config.excludeChunks\n      : [this.config.excludeChunks as RegExp];\n\n    compiler.hooks.emit.tap(pluginName, (compilation) => {\n      compilation.chunks.forEach((chunk) => {\n        chunk.files.forEach((file) => this.chunkFilenames.add(file));\n      });\n    });\n\n    compiler.hooks.assetEmitted.tapPromise(\n      { name: pluginName, stage: 20 },\n      async (file, { outputPath, content, compilation }) => {\n        const mainBundleName = compilation.outputOptions.filename as string;\n        if (!this.shouldSignFile(file, mainBundleName, excludedChunks)) {\n          return;\n        }\n        logger.debug(`Signing ${file}`);\n        /** generate bundle hash */\n        const hash = crypto.createHash('sha256').update(content).digest('hex');\n        /** generate token */\n        const token = jwt.sign({ hash }, privateKey, { algorithm: 'RS256' });\n        /** combine the bundle and the token */\n        const signedBundle = Buffer.concat(\n          [content, Buffer.from(BEGIN_CS_MARK), Buffer.from(token)],\n          content.length + TOKEN_BUFFER_SIZE\n        );\n\n        const writeFileAsync = util.promisify(\n          compiler.outputFileSystem!.writeFile\n        );\n        await writeFileAsync(path.join(outputPath, file), signedBundle);\n        logger.debug(`Signed ${file}`);\n      }\n    );\n  }\n}\n"],"mappings":"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","ignoreList":[]}