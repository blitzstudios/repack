{"version":3,"file":"LoggerPlugin.js","names":["_env","require","_logging","LoggerPlugin","SUPPORTED_TYPES","constructor","config","output","undefined","console","isTruthyEnv","env","reporters","push","ConsoleReporter","isWorker","process","WORKER_ENV_KEY","isVerbose","VERBOSE_ENV_KEY","file","FileReporter","filename","reporter","composeReporters","createEntry","issuer","type","args","timestamp","includes","Date","now","message","processEntry","entry","listener","apply","compiler","options","stats","hooks","infrastructureLog","tap","thisCompilation","compilation","log","intercept","call","time","done","devServerEnabled","errors","warnings","toJson","all","timings","entires","length","map","error","moduleName","warning","filter","Boolean","statsEntry","toString","preset","colors","flush","stop","on","errorEntry","exports"],"sources":["../../src/plugins/LoggerPlugin.ts"],"sourcesContent":["import type { Compiler, RspackPluginInstance } from '@rspack/core';\nimport { VERBOSE_ENV_KEY, WORKER_ENV_KEY } from '../env';\nimport {\n  ConsoleReporter,\n  FileReporter,\n  type LogEntry,\n  type LogType,\n  type Reporter,\n  composeReporters,\n} from '../logging';\n\nexport type GenericFilter = Array<string | RegExp>;\n\n/**\n * {@link LoggerPlugin} configuration options.\n */\nexport interface LoggerPluginConfig {\n  /** Target application platform. */\n  platform: string;\n  /** Whether development server is running/enabled. */\n  devServerEnabled?: boolean;\n  /** Logging output config. */\n  output?: {\n    /** Whether to log to console. */\n    console?: boolean;\n    /** Absolute path to file to log messages to. */\n    file?: string;\n    /** Listener for new messages. */\n    listener?: (logEntry: LogEntry) => void;\n  };\n}\n\n/**\n * Logger plugin that handles all logging coming from the Webpack ecosystem,\n * including debug logs from other plugins and resolvers.\n *\n * @category Webpack Plugin\n */\nexport class LoggerPlugin implements RspackPluginInstance {\n  private static SUPPORTED_TYPES: string[] = [\n    'debug',\n    'info',\n    'warn',\n    'error',\n    'success',\n  ];\n\n  /** {@link Reporter} instance used to actually writing logs to terminal/file. */\n  readonly reporter: Reporter;\n\n  /**\n   * Constructs new `LoggerPlugin`.\n   *\n   * @param config Plugin configuration options.\n   */\n  constructor(private config: LoggerPluginConfig) {\n    if (this.config.output === undefined) {\n      this.config.output = { console: true };\n    }\n\n    const isTruthyEnv = (env: string | undefined) => {\n      return !!env && env !== 'false' && env !== '0';\n    };\n\n    const reporters = [];\n    if (this.config.output.console) {\n      reporters.push(\n        new ConsoleReporter({\n          isWorker: isTruthyEnv(process.env[WORKER_ENV_KEY]),\n          isVerbose: isTruthyEnv(process.env[VERBOSE_ENV_KEY]),\n        })\n      );\n    }\n    if (this.config.output.file) {\n      reporters.push(new FileReporter({ filename: this.config.output.file }));\n    }\n    this.reporter = composeReporters(reporters);\n  }\n\n  /**\n   * Create log entry from Webpack log message from {@link WebpackLogger}.\n   *\n   * @param issuer Issuer of the message.\n   * @param type Type of the message.\n   * @param args The body of the message.\n   * @param timestamp Timestamp when the message was recorder.\n   * @returns Log entry object or undefined when if message is invalid.\n   */\n  createEntry(\n    issuer: string,\n    type: string,\n    args: any[],\n    timestamp?: number\n  ): LogEntry | undefined {\n    if (LoggerPlugin.SUPPORTED_TYPES.includes(type)) {\n      return {\n        timestamp: timestamp ?? Date.now(),\n        issuer: issuer.includes('reactNativeAssetsLoader')\n          ? 'reactNativeAssetsLoader'\n          : issuer,\n        type: type as LogType,\n        message: args,\n      };\n    }\n\n    return undefined;\n  }\n\n  /**\n   * Process log entry and pass it to {@link reporter} instance.\n   *\n   * @param entry Log entry to process\n   */\n  processEntry(entry: LogEntry) {\n    if (\n      !this.config.output?.console &&\n      !this.config.output?.file &&\n      !this.config.output?.listener\n    ) {\n      return;\n    }\n\n    this.reporter.process(entry);\n\n    if (this.config.output.listener) {\n      this.config.output.listener(entry);\n    }\n  }\n\n  /**\n   * Apply the plugin.\n   *\n   * @param compiler Webpack compiler instance.\n   */\n  apply(compiler: Compiler) {\n    // Make sure webpack-cli doesn't print stats by default.\n    if (compiler.options.stats === undefined) {\n      compiler.options.stats = 'none';\n    }\n\n    compiler.hooks.infrastructureLog.tap(\n      'LoggerPlugin',\n      (issuer, type, args) => {\n        const entry = this.createEntry(issuer, type, args);\n        if (entry) {\n          this.processEntry(entry);\n        }\n        return true;\n      }\n    );\n\n    compiler.hooks.thisCompilation.tap('LoggerPlugin', (compilation) => {\n      compilation.hooks.log.intercept({\n        call: (issuer, { time, type, args }) => {\n          const entry = this.createEntry(issuer, type, args, time);\n          if (entry) {\n            this.processEntry(entry);\n          }\n        },\n      });\n    });\n\n    compiler.hooks.done.tap('LoggerPlugin', (stats) => {\n      if (this.config.devServerEnabled) {\n        const { time, errors, warnings } = stats.toJson({\n          all: false,\n          timings: true,\n          errors: true,\n          warnings: true,\n        });\n\n        let entires: Array<LogEntry | undefined> = [];\n        if (errors?.length) {\n          entires = [\n            this.createEntry('LoggerPlugin', 'error', [\n              'Failed to build bundle due to errors',\n            ]),\n            ...errors.map((error) =>\n              this.createEntry('LoggerPlugin', 'error', [\n                `Error in \"${error.moduleName}\":\\n${error.message}`,\n              ])\n            ),\n          ];\n        } else {\n          entires = [\n            this.createEntry('LoggerPlugin', 'info', [\n              warnings?.length ? 'Bundle built with warnings' : 'Bundle built',\n              { time },\n            ]),\n            ...(warnings?.map((warning) =>\n              this.createEntry('LoggerPlugin', 'warn', [\n                `Warning in \"${warning.moduleName}\":\\n${warning.message}`,\n              ])\n            ) ?? []),\n          ];\n        }\n\n        for (const entry of entires.filter(Boolean) as LogEntry[]) {\n          this.processEntry(entry);\n        }\n      } else {\n        const statsEntry = this.createEntry('LoggerPlugin', 'info', [\n          stats.toString({ preset: 'normal', colors: true }),\n        ]);\n        if (statsEntry) {\n          this.processEntry(statsEntry);\n        }\n      }\n\n      this.reporter.flush();\n      this.reporter.stop();\n    });\n\n    process.on('uncaughtException', (error) => {\n      const errorEntry = this.createEntry('LoggerPlugin', 'error', [error]);\n      if (errorEntry) {\n        this.processEntry(errorEntry);\n      }\n      this.reporter.flush();\n      this.reporter.stop();\n    });\n\n    process.on('exit', () => {\n      this.reporter.flush();\n      this.reporter.stop();\n    });\n  }\n}\n"],"mappings":"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","ignoreList":[]}