{"version":3,"file":"DevelopmentPlugin.js","names":["_pluginReactRefresh","_interopRequireDefault","require","e","__esModule","default","DevelopmentPlugin","constructor","config","apply","compiler","devServer","reactNativePackageJson","majorVersion","minorVersion","patchVersion","version","split","webpack","DefinePlugin","__PLATFORM__","JSON","stringify","platform","__PUBLIC_PORT__","Number","port","__LISTENER_IP__","listenerIP","__REACT_NATIVE_MAJOR_VERSION__","__REACT_NATIVE_MINOR_VERSION__","__REACT_NATIVE_PATCH_VERSION__","options","output","filename","pathData","chunk","name","chunkFilename","hmr","HotModuleReplacementPlugin","resolveLoader","fallback","resolve","ReactRefreshPlugin","overlay","EntryPlugin","context","undefined","SourceMapDevToolPlugin","test","append","module","columns","noSources","exports"],"sources":["../../src/plugins/DevelopmentPlugin.ts"],"sourcesContent":["import type { Compiler, RspackPluginInstance } from '@rspack/core';\nimport ReactRefreshPlugin from '@rspack/plugin-react-refresh';\nimport type { DevServerOptions } from '../types';\n\ntype PackageJSON = { version: string };\n/**\n * {@link DevelopmentPlugin} configuration options.\n */\nexport interface DevelopmentPluginConfig {\n  platform: string;\n  devServer?: DevServerOptions;\n  listenerIP?: string;\n}\n\n/**\n * Class for running development server that handles serving the built bundle, all assets as well as\n * providing Hot Module Replacement functionality.\n *\n * @category Webpack Plugin\n */\nexport class DevelopmentPlugin implements RspackPluginInstance {\n  /**\n   * Constructs new `DevelopmentPlugin`.\n   *\n   * @param config Plugin configuration options.\n   */\n  constructor(private config?: DevelopmentPluginConfig) {}\n\n  /**\n   * Apply the plugin.\n   *\n   * @param compiler Webpack compiler instance.\n   */\n  apply(compiler: Compiler) {\n    if (!this.config?.devServer) {\n      return;\n    }\n\n    const reactNativePackageJson: PackageJSON = require('react-native/package.json');\n    const [majorVersion, minorVersion, patchVersion] =\n      reactNativePackageJson.version.split('-')[0].split('.');\n\n    new compiler.webpack.DefinePlugin({\n      __PLATFORM__: JSON.stringify(this.config.platform),\n      __PUBLIC_PORT__: Number(this.config.devServer.port),\n      __LISTENER_IP__: JSON.stringify(this.config.listenerIP),\n      __REACT_NATIVE_MAJOR_VERSION__: Number(majorVersion),\n      __REACT_NATIVE_MINOR_VERSION__: Number(minorVersion),\n      __REACT_NATIVE_PATCH_VERSION__: Number(patchVersion),\n    }).apply(compiler);\n\n    // Enforce output filenames in development mode\n    compiler.options.output.filename = (pathData) =>\n      pathData.chunk?.name === 'main' ? 'index.bundle' : '[name].bundle';\n    compiler.options.output.chunkFilename = '[name].chunk.bundle';\n\n    if (this.config?.devServer.hmr) {\n      // setup HMR\n      new compiler.webpack.HotModuleReplacementPlugin().apply(compiler);\n\n      // add react-refresh-loader fallback for compatibility with Webpack\n      compiler.options.resolveLoader = {\n        ...compiler.options.resolveLoader,\n        fallback: {\n          ...compiler.options.resolveLoader?.fallback,\n          'builtin:react-refresh-loader': require.resolve(\n            '../loaders/reactRefreshCompatLoader'\n          ),\n        },\n      };\n\n      new ReactRefreshPlugin({ overlay: false }).apply(compiler);\n\n      new compiler.webpack.EntryPlugin(\n        compiler.context,\n        require.resolve('../modules/configurePublicPath'),\n        { name: undefined }\n      ).apply(compiler);\n\n      new compiler.webpack.EntryPlugin(\n        compiler.context,\n        require.resolve('../modules/WebpackHMRClient'),\n        { name: undefined }\n      ).apply(compiler);\n\n      // setup HMR source maps\n      new compiler.webpack.SourceMapDevToolPlugin({\n        test: /\\.hot-update\\.js$/,\n        filename: '[file].map',\n        append: `//# sourceMappingURL=[url]?platform=${this.config.platform}`,\n        module: true,\n        columns: true,\n        noSources: false,\n      }).apply(compiler);\n    }\n  }\n}\n"],"mappings":"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","ignoreList":[]}