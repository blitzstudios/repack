{"version":3,"file":"DevelopmentPlugin.js","names":["_nodePath","_interopRequireDefault","require","_pluginReactRefresh","_isRspackCompiler","_moveElementBefore","e","__esModule","default","reactRefreshEntryPath","reactRefreshPath","refreshUtilsPath","ReactRefreshPlugin","deprecated_runtimePaths","DevelopmentPlugin","constructor","config","getEntryNormalizedEntryChunks","entryNormalized","Error","Object","keys","map","name","runtime","getModuleFederationEntryChunks","plugins","entrypoints","plugin","startsWith","exposes","_options","filter","Boolean","getProtocolType","devServer","server","type","apply","compiler","options","reactNativePackageJson","majorVersion","minorVersion","patchVersion","version","split","host","port","protocol","platform","webpack","DefinePlugin","__PLATFORM__","JSON","stringify","__PUBLIC_PROTOCOL__","__PUBLIC_HOST__","__PUBLIC_PORT__","Number","__LISTENER_IP__","listenerIP","__REACT_NATIVE_MAJOR_VERSION__","__REACT_NATIVE_MINOR_VERSION__","__REACT_NATIVE_PATCH_VERSION__","hot","HotModuleReplacementPlugin","ProvidePlugin","$ReactRefreshRuntime$","__react_refresh_error_overlay__","__react_refresh_socket__","__react_refresh_library__","Template","toIdentifier","output","uniqueName","library","__react_refresh_utils__","refreshPath","path","dirname","resolve","alias","module","rules","unshift","include","exclude","use","devEntries","hooks","entryOption","tap","_","forEach","entryName","devEntry","EntryPlugin","context","isRspackCompiler","make","stage","compilation","entry","entries","values","moveElementBefore","dependencies","elementToMove","beforeElement","getElement","dependency","request","exports"],"sources":["../../src/plugins/DevelopmentPlugin.ts"],"sourcesContent":["import path from 'node:path';\nimport type { DevServerOptions } from '@callstack/repack-dev-server';\nimport type {\n  Compiler,\n  EntryNormalized,\n  Plugins,\n  RspackPluginInstance,\n} from '@rspack/core';\nimport ReactRefreshPlugin from '@rspack/plugin-react-refresh';\nimport { isRspackCompiler } from './utils/isRspackCompiler.js';\nimport { moveElementBefore } from './utils/moveElementBefore.js';\n\nconst [reactRefreshEntryPath, reactRefreshPath, refreshUtilsPath] =\n  ReactRefreshPlugin.deprecated_runtimePaths;\n\ntype PackageJSON = { version: string };\n/**\n * {@link DevelopmentPlugin} configuration options.\n */\nexport interface DevelopmentPluginConfig {\n  listenerIP?: string;\n  /**\n   * Target application platform.\n   */\n  platform?: string;\n}\n\n/**\n * Class for running development server that handles serving the built bundle, all assets as well as\n * providing Hot Module Replacement functionality.\n *\n * @category Webpack Plugin\n */\nexport class DevelopmentPlugin implements RspackPluginInstance {\n  /**\n   * Constructs new `DevelopmentPlugin`.\n   *\n   * @param config Plugin configuration options.\n   */\n  constructor(private config: DevelopmentPluginConfig) {}\n\n  private getEntryNormalizedEntryChunks(entryNormalized: EntryNormalized) {\n    if (typeof entryNormalized === 'function') {\n      throw new Error(\n        '[RepackDevelopmentPlugin] Dynamic entry (function) is not supported.'\n      );\n    }\n\n    return Object.keys(entryNormalized).map(\n      (name) => entryNormalized[name].runtime || name\n    );\n  }\n\n  private getModuleFederationEntryChunks(plugins: Plugins) {\n    const entrypoints = plugins.map((plugin) => {\n      if (typeof plugin !== 'object' || !plugin) {\n        return;\n      }\n\n      if (!plugin.constructor?.name.startsWith('ModuleFederationPlugin')) {\n        return;\n      }\n\n      // repack MF plugins expose config property\n      if ('config' in plugin && !!plugin.config.exposes) {\n        return plugin.config.name;\n      }\n\n      // official MF plugins expose _options property\n      if ('_options' in plugin && !!plugin.config.exposes) {\n        return plugin._options.name;\n      }\n\n      return;\n    });\n\n    return entrypoints.filter(Boolean);\n  }\n\n  private getProtocolType(devServer: DevServerOptions) {\n    if (typeof devServer.server === 'string') {\n      return devServer.server;\n    }\n\n    if (typeof devServer.server?.type === 'string') {\n      return devServer.server.type;\n    }\n\n    return 'http';\n  }\n\n  /**\n   * Apply the plugin.\n   *\n   * @param compiler Webpack compiler instance.\n   */\n  apply(compiler: Compiler) {\n    if (!compiler.options.devServer) {\n      return;\n    }\n\n    const reactNativePackageJson: PackageJSON = require('react-native/package.json');\n    const [majorVersion, minorVersion, patchVersion] =\n      reactNativePackageJson.version.split('-')[0].split('.');\n\n    const host = compiler.options.devServer.host;\n    const port = compiler.options.devServer.port;\n    const protocol = this.getProtocolType(\n      compiler.options.devServer as DevServerOptions\n    );\n    const platform = this.config.platform ?? (compiler.options.name as string);\n\n    new compiler.webpack.DefinePlugin({\n      __PLATFORM__: JSON.stringify(platform),\n      __PUBLIC_PROTOCOL__: JSON.stringify(protocol),\n      __PUBLIC_HOST__: JSON.stringify(host),\n      __PUBLIC_PORT__: Number(port),\n      __LISTENER_IP__: JSON.stringify(this.config.listenerIP),\n      __REACT_NATIVE_MAJOR_VERSION__: Number(majorVersion),\n      __REACT_NATIVE_MINOR_VERSION__: Number(minorVersion),\n      __REACT_NATIVE_PATCH_VERSION__: Number(patchVersion),\n    }).apply(compiler);\n\n    if (compiler.options.devServer.hot) {\n      // setup HMR\n      new compiler.webpack.HotModuleReplacementPlugin().apply(compiler);\n\n      // setup React Refresh manually instead of using the official plugin\n      // to avoid issues with placement of reactRefreshEntry\n      new compiler.webpack.ProvidePlugin({\n        $ReactRefreshRuntime$: reactRefreshPath,\n      }).apply(compiler);\n\n      new compiler.webpack.DefinePlugin({\n        __react_refresh_error_overlay__: false,\n        __react_refresh_socket__: false,\n        __react_refresh_library__: JSON.stringify(\n          compiler.webpack.Template.toIdentifier(\n            compiler.options.output.uniqueName ||\n              compiler.options.output.library\n          )\n        ),\n      }).apply(compiler);\n\n      new compiler.webpack.ProvidePlugin({\n        __react_refresh_utils__: refreshUtilsPath,\n      }).apply(compiler);\n\n      const refreshPath = path.dirname(require.resolve('react-refresh'));\n      compiler.options.resolve.alias = {\n        'react-refresh': refreshPath,\n        ...compiler.options.resolve.alias,\n      };\n\n      compiler.options.module.rules.unshift({\n        include: /\\.([cm]js|[jt]sx?|flow)$/i,\n        exclude: /node_modules/i,\n        use: '@callstack/repack/react-refresh-loader',\n      });\n\n      const devEntries = [\n        reactRefreshEntryPath,\n        require.resolve('../modules/configurePublicPath.js'),\n        require.resolve('../modules/WebpackHMRClient.js'),\n      ];\n\n      compiler.hooks.entryOption.tap(\n        { name: 'RepackDevelopmentPlugin' },\n        (_, entryNormalized) => {\n          // combine entries for all declared and MF entrypoints\n          const entrypoints = [\n            ...this.getEntryNormalizedEntryChunks(entryNormalized),\n            ...this.getModuleFederationEntryChunks(compiler.options.plugins),\n          ];\n\n          // add development entries to all combined entrypoints\n          entrypoints.forEach((entryName) => {\n            for (const devEntry of devEntries) {\n              new compiler.webpack.EntryPlugin(compiler.context, devEntry, {\n                name: entryName,\n              }).apply(compiler);\n            }\n          });\n        }\n      );\n\n      if (!isRspackCompiler(compiler)) {\n        // In Webpack, Module Federation Container entry gets injected during the compilation's make phase,\n        // similar to how dynamic entries work. This means the federation entry is added after our development entries.\n        // We need to reorder dependencies to ensure federation entry is placed before development entries.\n        compiler.hooks.make.tap(\n          { name: 'RepackDevelopmentPlugin', stage: 1000 },\n          (compilation) => {\n            for (const entry of compilation.entries.values()) {\n              moveElementBefore(entry.dependencies, {\n                elementToMove: /\\.federation\\/entry/,\n                beforeElement: devEntries[0],\n                getElement: (dependency) => dependency.request ?? '',\n              });\n            }\n          }\n        );\n      }\n    }\n  }\n}\n"],"mappings":";;;;;;AAAA,IAAAA,SAAA,GAAAC,sBAAA,CAAAC,OAAA;AAQA,IAAAC,mBAAA,GAAAF,sBAAA,CAAAC,OAAA;AACA,IAAAE,iBAAA,GAAAF,OAAA;AACA,IAAAG,kBAAA,GAAAH,OAAA;AAAiE,SAAAD,uBAAAK,CAAA,WAAAA,CAAA,IAAAA,CAAA,CAAAC,UAAA,GAAAD,CAAA,KAAAE,OAAA,EAAAF,CAAA;AAEjE,MAAM,CAACG,qBAAqB,EAAEC,gBAAgB,EAAEC,gBAAgB,CAAC,GAC/DC,2BAAkB,CAACC,uBAAuB;;AAG5C;AACA;AACA;;AASA;AACA;AACA;AACA;AACA;AACA;AACO,MAAMC,iBAAiB,CAAiC;EAC7D;AACF;AACA;AACA;AACA;EACEC,WAAWA,CAASC,MAA+B,EAAE;IAAA,KAAjCA,MAA+B,GAA/BA,MAA+B;EAAG;EAE9CC,6BAA6BA,CAACC,eAAgC,EAAE;IACtE,IAAI,OAAOA,eAAe,KAAK,UAAU,EAAE;MACzC,MAAM,IAAIC,KAAK,CACb,sEACF,CAAC;IACH;IAEA,OAAOC,MAAM,CAACC,IAAI,CAACH,eAAe,CAAC,CAACI,GAAG,CACpCC,IAAI,IAAKL,eAAe,CAACK,IAAI,CAAC,CAACC,OAAO,IAAID,IAC7C,CAAC;EACH;EAEQE,8BAA8BA,CAACC,OAAgB,EAAE;IACvD,MAAMC,WAAW,GAAGD,OAAO,CAACJ,GAAG,CAAEM,MAAM,IAAK;MAC1C,IAAI,OAAOA,MAAM,KAAK,QAAQ,IAAI,CAACA,MAAM,EAAE;QACzC;MACF;MAEA,IAAI,CAACA,MAAM,CAACb,WAAW,EAAEQ,IAAI,CAACM,UAAU,CAAC,wBAAwB,CAAC,EAAE;QAClE;MACF;;MAEA;MACA,IAAI,QAAQ,IAAID,MAAM,IAAI,CAAC,CAACA,MAAM,CAACZ,MAAM,CAACc,OAAO,EAAE;QACjD,OAAOF,MAAM,CAACZ,MAAM,CAACO,IAAI;MAC3B;;MAEA;MACA,IAAI,UAAU,IAAIK,MAAM,IAAI,CAAC,CAACA,MAAM,CAACZ,MAAM,CAACc,OAAO,EAAE;QACnD,OAAOF,MAAM,CAACG,QAAQ,CAACR,IAAI;MAC7B;MAEA;IACF,CAAC,CAAC;IAEF,OAAOI,WAAW,CAACK,MAAM,CAACC,OAAO,CAAC;EACpC;EAEQC,eAAeA,CAACC,SAA2B,EAAE;IACnD,IAAI,OAAOA,SAAS,CAACC,MAAM,KAAK,QAAQ,EAAE;MACxC,OAAOD,SAAS,CAACC,MAAM;IACzB;IAEA,IAAI,OAAOD,SAAS,CAACC,MAAM,EAAEC,IAAI,KAAK,QAAQ,EAAE;MAC9C,OAAOF,SAAS,CAACC,MAAM,CAACC,IAAI;IAC9B;IAEA,OAAO,MAAM;EACf;;EAEA;AACF;AACA;AACA;AACA;EACEC,KAAKA,CAACC,QAAkB,EAAE;IACxB,IAAI,CAACA,QAAQ,CAACC,OAAO,CAACL,SAAS,EAAE;MAC/B;IACF;IAEA,MAAMM,sBAAmC,GAAGvC,OAAO,CAAC,2BAA2B,CAAC;IAChF,MAAM,CAACwC,YAAY,EAAEC,YAAY,EAAEC,YAAY,CAAC,GAC9CH,sBAAsB,CAACI,OAAO,CAACC,KAAK,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAACA,KAAK,CAAC,GAAG,CAAC;IAEzD,MAAMC,IAAI,GAAGR,QAAQ,CAACC,OAAO,CAACL,SAAS,CAACY,IAAI;IAC5C,MAAMC,IAAI,GAAGT,QAAQ,CAACC,OAAO,CAACL,SAAS,CAACa,IAAI;IAC5C,MAAMC,QAAQ,GAAG,IAAI,CAACf,eAAe,CACnCK,QAAQ,CAACC,OAAO,CAACL,SACnB,CAAC;IACD,MAAMe,QAAQ,GAAG,IAAI,CAAClC,MAAM,CAACkC,QAAQ,IAAKX,QAAQ,CAACC,OAAO,CAACjB,IAAe;IAE1E,IAAIgB,QAAQ,CAACY,OAAO,CAACC,YAAY,CAAC;MAChCC,YAAY,EAAEC,IAAI,CAACC,SAAS,CAACL,QAAQ,CAAC;MACtCM,mBAAmB,EAAEF,IAAI,CAACC,SAAS,CAACN,QAAQ,CAAC;MAC7CQ,eAAe,EAAEH,IAAI,CAACC,SAAS,CAACR,IAAI,CAAC;MACrCW,eAAe,EAAEC,MAAM,CAACX,IAAI,CAAC;MAC7BY,eAAe,EAAEN,IAAI,CAACC,SAAS,CAAC,IAAI,CAACvC,MAAM,CAAC6C,UAAU,CAAC;MACvDC,8BAA8B,EAAEH,MAAM,CAACjB,YAAY,CAAC;MACpDqB,8BAA8B,EAAEJ,MAAM,CAAChB,YAAY,CAAC;MACpDqB,8BAA8B,EAAEL,MAAM,CAACf,YAAY;IACrD,CAAC,CAAC,CAACN,KAAK,CAACC,QAAQ,CAAC;IAElB,IAAIA,QAAQ,CAACC,OAAO,CAACL,SAAS,CAAC8B,GAAG,EAAE;MAClC;MACA,IAAI1B,QAAQ,CAACY,OAAO,CAACe,0BAA0B,CAAC,CAAC,CAAC5B,KAAK,CAACC,QAAQ,CAAC;;MAEjE;MACA;MACA,IAAIA,QAAQ,CAACY,OAAO,CAACgB,aAAa,CAAC;QACjCC,qBAAqB,EAAE1D;MACzB,CAAC,CAAC,CAAC4B,KAAK,CAACC,QAAQ,CAAC;MAElB,IAAIA,QAAQ,CAACY,OAAO,CAACC,YAAY,CAAC;QAChCiB,+BAA+B,EAAE,KAAK;QACtCC,wBAAwB,EAAE,KAAK;QAC/BC,yBAAyB,EAAEjB,IAAI,CAACC,SAAS,CACvChB,QAAQ,CAACY,OAAO,CAACqB,QAAQ,CAACC,YAAY,CACpClC,QAAQ,CAACC,OAAO,CAACkC,MAAM,CAACC,UAAU,IAChCpC,QAAQ,CAACC,OAAO,CAACkC,MAAM,CAACE,OAC5B,CACF;MACF,CAAC,CAAC,CAACtC,KAAK,CAACC,QAAQ,CAAC;MAElB,IAAIA,QAAQ,CAACY,OAAO,CAACgB,aAAa,CAAC;QACjCU,uBAAuB,EAAElE;MAC3B,CAAC,CAAC,CAAC2B,KAAK,CAACC,QAAQ,CAAC;MAElB,MAAMuC,WAAW,GAAGC,iBAAI,CAACC,OAAO,CAAC9E,OAAO,CAAC+E,OAAO,CAAC,eAAe,CAAC,CAAC;MAClE1C,QAAQ,CAACC,OAAO,CAACyC,OAAO,CAACC,KAAK,GAAG;QAC/B,eAAe,EAAEJ,WAAW;QAC5B,GAAGvC,QAAQ,CAACC,OAAO,CAACyC,OAAO,CAACC;MAC9B,CAAC;MAED3C,QAAQ,CAACC,OAAO,CAAC2C,MAAM,CAACC,KAAK,CAACC,OAAO,CAAC;QACpCC,OAAO,EAAE,2BAA2B;QACpCC,OAAO,EAAE,eAAe;QACxBC,GAAG,EAAE;MACP,CAAC,CAAC;MAEF,MAAMC,UAAU,GAAG,CACjBhF,qBAAqB,EACrBP,OAAO,CAAC+E,OAAO,CAAC,mCAAmC,CAAC,EACpD/E,OAAO,CAAC+E,OAAO,CAAC,gCAAgC,CAAC,CAClD;MAED1C,QAAQ,CAACmD,KAAK,CAACC,WAAW,CAACC,GAAG,CAC5B;QAAErE,IAAI,EAAE;MAA0B,CAAC,EACnC,CAACsE,CAAC,EAAE3E,eAAe,KAAK;QACtB;QACA,MAAMS,WAAW,GAAG,CAClB,GAAG,IAAI,CAACV,6BAA6B,CAACC,eAAe,CAAC,EACtD,GAAG,IAAI,CAACO,8BAA8B,CAACc,QAAQ,CAACC,OAAO,CAACd,OAAO,CAAC,CACjE;;QAED;QACAC,WAAW,CAACmE,OAAO,CAAEC,SAAS,IAAK;UACjC,KAAK,MAAMC,QAAQ,IAAIP,UAAU,EAAE;YACjC,IAAIlD,QAAQ,CAACY,OAAO,CAAC8C,WAAW,CAAC1D,QAAQ,CAAC2D,OAAO,EAAEF,QAAQ,EAAE;cAC3DzE,IAAI,EAAEwE;YACR,CAAC,CAAC,CAACzD,KAAK,CAACC,QAAQ,CAAC;UACpB;QACF,CAAC,CAAC;MACJ,CACF,CAAC;MAED,IAAI,CAAC,IAAA4D,kCAAgB,EAAC5D,QAAQ,CAAC,EAAE;QAC/B;QACA;QACA;QACAA,QAAQ,CAACmD,KAAK,CAACU,IAAI,CAACR,GAAG,CACrB;UAAErE,IAAI,EAAE,yBAAyB;UAAE8E,KAAK,EAAE;QAAK,CAAC,EAC/CC,WAAW,IAAK;UACf,KAAK,MAAMC,KAAK,IAAID,WAAW,CAACE,OAAO,CAACC,MAAM,CAAC,CAAC,EAAE;YAChD,IAAAC,oCAAiB,EAACH,KAAK,CAACI,YAAY,EAAE;cACpCC,aAAa,EAAE,qBAAqB;cACpCC,aAAa,EAAEpB,UAAU,CAAC,CAAC,CAAC;cAC5BqB,UAAU,EAAGC,UAAU,IAAKA,UAAU,CAACC,OAAO,IAAI;YACpD,CAAC,CAAC;UACJ;QACF,CACF,CAAC;MACH;IACF;EACF;AACF;AAACC,OAAA,CAAAnG,iBAAA,GAAAA,iBAAA","ignoreList":[]}