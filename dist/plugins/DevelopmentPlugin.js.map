{"version":3,"file":"DevelopmentPlugin.js","names":["_nodePath","_interopRequireDefault","require","_pluginReactRefresh","_isRspackCompiler","e","__esModule","default","reactRefreshEntryPath","reactRefreshPath","refreshUtilsPath","ReactRefreshPlugin","deprecated_runtimePaths","DevelopmentPlugin","constructor","config","apply","compiler","devServer","reactNativePackageJson","majorVersion","minorVersion","patchVersion","version","split","webpack","DefinePlugin","__PLATFORM__","JSON","stringify","platform","__PUBLIC_PROTOCOL__","https","__PUBLIC_HOST__","host","__PUBLIC_PORT__","Number","port","__LISTENER_IP__","listenerIP","__REACT_NATIVE_MAJOR_VERSION__","__REACT_NATIVE_MINOR_VERSION__","__REACT_NATIVE_PATCH_VERSION__","options","output","filename","pathData","chunk","name","chunkFilename","hmr","HotModuleReplacementPlugin","resolveLoader","fallback","resolve","SourceMapDevToolPlugin","test","append","module","columns","noSources","namespace","devtoolNamespace","uniqueName","ProvidePlugin","$ReactRefreshRuntime$","__react_refresh_error_overlay__","__react_refresh_socket__","__react_refresh_library__","Template","toIdentifier","library","__react_refresh_utils__","refreshPath","path","dirname","alias","rules","unshift","include","exclude","use","devEntries","isRspackCompiler","hooks","initialize","tap","stage","entry","EntryPlugin","context","undefined","entryName","Error","entries","import","scriptManagerEntryIndex","findIndex","includes","slice","exports"],"sources":["../../src/plugins/DevelopmentPlugin.ts"],"sourcesContent":["import path from 'node:path';\nimport type { Compiler, RspackPluginInstance } from '@rspack/core';\nimport ReactRefreshPlugin from '@rspack/plugin-react-refresh';\nimport type { DevServerOptions } from '../types';\nimport { isRspackCompiler } from './utils/isRspackCompiler';\n\nconst [reactRefreshEntryPath, reactRefreshPath, refreshUtilsPath] =\n  ReactRefreshPlugin.deprecated_runtimePaths;\n\ntype PackageJSON = { version: string };\n/**\n * {@link DevelopmentPlugin} configuration options.\n */\nexport interface DevelopmentPluginConfig {\n  entryName?: string;\n  platform: string;\n  devServer?: DevServerOptions;\n  listenerIP?: string;\n}\n\n/**\n * Class for running development server that handles serving the built bundle, all assets as well as\n * providing Hot Module Replacement functionality.\n *\n * @category Webpack Plugin\n */\nexport class DevelopmentPlugin implements RspackPluginInstance {\n  /**\n   * Constructs new `DevelopmentPlugin`.\n   *\n   * @param config Plugin configuration options.\n   */\n  constructor(private config?: DevelopmentPluginConfig) {}\n\n  /**\n   * Apply the plugin.\n   *\n   * @param compiler Webpack compiler instance.\n   */\n  apply(compiler: Compiler) {\n    if (!this.config?.devServer) {\n      return;\n    }\n\n    const reactNativePackageJson: PackageJSON = require('react-native/package.json');\n    const [majorVersion, minorVersion, patchVersion] =\n      reactNativePackageJson.version.split('-')[0].split('.');\n\n    new compiler.webpack.DefinePlugin({\n      __PLATFORM__: JSON.stringify(this.config.platform),\n      __PUBLIC_PROTOCOL__: this.config.devServer.https ? '\"https\"' : '\"http\"',\n      __PUBLIC_HOST__: JSON.stringify(this.config.devServer.host),\n      __PUBLIC_PORT__: Number(this.config.devServer.port),\n      __LISTENER_IP__: JSON.stringify(this.config.listenerIP),\n      __REACT_NATIVE_MAJOR_VERSION__: Number(majorVersion),\n      __REACT_NATIVE_MINOR_VERSION__: Number(minorVersion),\n      __REACT_NATIVE_PATCH_VERSION__: Number(patchVersion),\n    }).apply(compiler);\n\n    // Enforce output filenames in development mode\n    compiler.options.output.filename = (pathData) =>\n      pathData.chunk?.name === 'main' ? 'index.bundle' : '[name].bundle';\n    compiler.options.output.chunkFilename = '[name].chunk.bundle';\n\n    if (this.config?.devServer.hmr) {\n      // setup HMR\n      new compiler.webpack.HotModuleReplacementPlugin().apply(compiler);\n\n      // add react-refresh-loader fallback for compatibility with Webpack\n      compiler.options.resolveLoader = {\n        ...compiler.options.resolveLoader,\n        fallback: {\n          ...compiler.options.resolveLoader?.fallback,\n          'builtin:react-refresh-loader': require.resolve(\n            '../loaders/reactRefreshCompatLoader'\n          ),\n        },\n      };\n\n      // setup HMR source maps\n      new compiler.webpack.SourceMapDevToolPlugin({\n        test: /\\.hot-update\\.js$/,\n        filename: '[file].map',\n        append: `//# sourceMappingURL=[url]?platform=${this.config.platform}`,\n        module: true,\n        columns: true,\n        noSources: false,\n        namespace:\n          compiler.options.output.devtoolNamespace ??\n          compiler.options.output.uniqueName,\n      }).apply(compiler);\n\n      // setup React Refresh manually instead of using the official plugin\n      // to avoid issues with placement of reactRefreshEntry\n      new compiler.webpack.ProvidePlugin({\n        $ReactRefreshRuntime$: reactRefreshPath,\n      }).apply(compiler);\n\n      new compiler.webpack.DefinePlugin({\n        __react_refresh_error_overlay__: false,\n        __react_refresh_socket__: false,\n        __react_refresh_library__: JSON.stringify(\n          compiler.webpack.Template.toIdentifier(\n            compiler.options.output.uniqueName ||\n              compiler.options.output.library\n          )\n        ),\n      }).apply(compiler);\n\n      new compiler.webpack.ProvidePlugin({\n        __react_refresh_utils__: refreshUtilsPath,\n      });\n\n      const refreshPath = path.dirname(require.resolve('react-refresh'));\n      compiler.options.resolve.alias = {\n        'react-refresh': refreshPath,\n        ...compiler.options.resolve.alias,\n      };\n\n      compiler.options.module.rules.unshift({\n        include: /\\.([cm]js|[jt]sx?|flow)$/i,\n        exclude: /node_modules/i,\n        use: 'builtin:react-refresh-loader',\n      });\n\n      const devEntries = [\n        reactRefreshEntryPath,\n        require.resolve('../modules/configurePublicPath'),\n        require.resolve('../modules/WebpackHMRClient'),\n      ];\n\n      // TODO (jbroma): refactor this to be more maintainable\n      // This is a very hacky way to reorder entrypoints, and needs to be done differently\n      // depending on the compiler type (rspack/webpack)\n      if (isRspackCompiler(compiler)) {\n        // Add entries after the rspack MF entry is added during `hook.afterPlugins` stage\n        compiler.hooks.initialize.tap(\n          { name: 'DevelopmentPlugin', stage: 200 },\n          () => {\n            for (const entry of devEntries) {\n              new compiler.webpack.EntryPlugin(compiler.context, entry, {\n                name: undefined,\n              }).apply(compiler);\n            }\n          }\n        );\n      } else {\n        if (!this.config.entryName) {\n          // Add dev entries as global entries\n          for (const entry of devEntries) {\n            new compiler.webpack.EntryPlugin(compiler.context, entry, {\n              name: undefined,\n            }).apply(compiler);\n          }\n        } else {\n          if (typeof compiler.options.entry === 'function') {\n            // TODO (jbroma): Support function entry points?\n            throw new Error(\n              'DevelopmentPlugin is not compatible with function entry points'\n            );\n          }\n\n          const entries =\n            compiler.options.entry[this.config.entryName].import ?? [];\n          const scriptManagerEntryIndex = entries.findIndex((entry) =>\n            entry.includes('InitializeScriptManager')\n          );\n\n          if (scriptManagerEntryIndex !== -1) {\n            // Insert devEntries after 'InitializeScriptManager'\n            compiler.options.entry[this.config.entryName].import = [\n              ...entries.slice(0, scriptManagerEntryIndex + 1),\n              ...devEntries,\n              ...entries.slice(scriptManagerEntryIndex + 1),\n            ];\n          } else {\n            // 'InitializeScriptManager' entry not found, insert devEntries before the normal entries\n            compiler.options.entry[this.config.entryName].import = [\n              ...devEntries,\n              ...entries,\n            ];\n          }\n        }\n      }\n    }\n  }\n}\n"],"mappings":"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","ignoreList":[]}