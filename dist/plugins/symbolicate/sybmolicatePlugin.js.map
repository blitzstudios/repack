{"version":3,"file":"sybmolicatePlugin.js","names":["path","fastifyPlugin","Symbolicator","symbolicatePlugin","instance","delegate","symbolicator","post","request","reply","stack","JSON","parse","body","platform","query","i","length","file","bundle","base","startsWith","log","debug","msg","badRequest","results","process","send","error","message","name","dependencies"],"sources":["../../../src/plugins/symbolicate/sybmolicatePlugin.ts"],"sourcesContent":["import path from 'path';\nimport type { FastifyInstance } from 'fastify';\nimport fastifyPlugin from 'fastify-plugin';\nimport type { Server } from '../../types';\nimport { Symbolicator } from './Symbolicator';\nimport type { ReactNativeStackFrame } from './types';\n\nasync function symbolicatePlugin(\n  instance: FastifyInstance,\n  {\n    delegate,\n  }: {\n    delegate: Server.Delegate;\n  }\n) {\n  const symbolicator = new Symbolicator(delegate.symbolicator);\n\n  instance.post('/symbolicate', async (request, reply) => {\n    // React Native sends stack as JSON but tests content-type to text/plain, so\n    // we cannot use JSON schema to validate the body.\n\n    try {\n      let { stack } = JSON.parse(request.body as string) as {\n        stack: ReactNativeStackFrame[];\n      };\n\n      const platform = (request.query as { platform?: string } | undefined)\n        ?.platform;\n\n      for (let i = 0; i < stack.length; i++) {\n        let file = stack[i].file as string;\n        let bundle = path.parse(file).base;\n\n        // When running in visual studio code, our bundle is copied to a local location:\n        // clients/app-mobile/.vscode/.react/index.bundle.\n        // In order to parse source maps we need to point to localhost instead.\n        if (file.startsWith('http://')) {\n          break;\n        }\n\n        if (bundle === '<anonymous>') {\n          break;\n        }\n\n        stack[i].file = `http://localhost:8081/${bundle}?platform=${platform}`;\n      }\n\n      if (!platform) {\n        request.log.debug({ msg: 'Received stack', stack });\n        reply.badRequest('Cannot infer platform from stack trace');\n      } else {\n        request.log.debug({ msg: 'Starting symbolication', platform, stack });\n        const results = await symbolicator.process(request.log, stack);\n        reply.send(results);\n      }\n    } catch (error) {\n      request.log.error({\n        msg: 'Failed to symbolicate',\n        error: (error as Error).message,\n      });\n      reply.badRequest('Failed to symbolicate');\n    }\n  });\n}\n\nexport default fastifyPlugin(symbolicatePlugin, {\n  name: 'symbolicate-plugin',\n  dependencies: ['fastify-sensible'],\n});\n"],"mappings":"AAAA,OAAOA,IAAP,MAAiB,MAAjB;AAEA,OAAOC,aAAP,MAA0B,gBAA1B;SAESC,Y;;AAGT,eAAeC,iBAAf,CACEC,QADF,EAEE;EACEC;AADF,CAFF,EAOE;EACA,MAAMC,YAAY,GAAG,IAAIJ,YAAJ,CAAiBG,QAAQ,CAACC,YAA1B,CAArB;EAEAF,QAAQ,CAACG,IAAT,CAAc,cAAd,EAA8B,OAAOC,OAAP,EAAgBC,KAAhB,KAA0B;IACtD;IACA;IAEA,IAAI;MAAA;;MACF,IAAI;QAAEC;MAAF,IAAYC,IAAI,CAACC,KAAL,CAAWJ,OAAO,CAACK,IAAnB,CAAhB;MAIA,MAAMC,QAAQ,qBAAIN,OAAO,CAACO,KAAZ,mDAAG,eACbD,QADJ;;MAGA,KAAK,IAAIE,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGN,KAAK,CAACO,MAA1B,EAAkCD,CAAC,EAAnC,EAAuC;QACrC,IAAIE,IAAI,GAAGR,KAAK,CAACM,CAAD,CAAL,CAASE,IAApB;QACA,IAAIC,MAAM,GAAGnB,IAAI,CAACY,KAAL,CAAWM,IAAX,EAAiBE,IAA9B,CAFqC,CAIrC;QACA;QACA;;QACA,IAAIF,IAAI,CAACG,UAAL,CAAgB,SAAhB,CAAJ,EAAgC;UAC9B;QACD;;QAED,IAAIF,MAAM,KAAK,aAAf,EAA8B;UAC5B;QACD;;QAEDT,KAAK,CAACM,CAAD,CAAL,CAASE,IAAT,GAAiB,yBAAwBC,MAAO,aAAYL,QAAS,EAArE;MACD;;MAED,IAAI,CAACA,QAAL,EAAe;QACbN,OAAO,CAACc,GAAR,CAAYC,KAAZ,CAAkB;UAAEC,GAAG,EAAE,gBAAP;UAAyBd;QAAzB,CAAlB;QACAD,KAAK,CAACgB,UAAN,CAAiB,wCAAjB;MACD,CAHD,MAGO;QACLjB,OAAO,CAACc,GAAR,CAAYC,KAAZ,CAAkB;UAAEC,GAAG,EAAE,wBAAP;UAAiCV,QAAjC;UAA2CJ;QAA3C,CAAlB;QACA,MAAMgB,OAAO,GAAG,MAAMpB,YAAY,CAACqB,OAAb,CAAqBnB,OAAO,CAACc,GAA7B,EAAkCZ,KAAlC,CAAtB;QACAD,KAAK,CAACmB,IAAN,CAAWF,OAAX;MACD;IACF,CAlCD,CAkCE,OAAOG,KAAP,EAAc;MACdrB,OAAO,CAACc,GAAR,CAAYO,KAAZ,CAAkB;QAChBL,GAAG,EAAE,uBADW;QAEhBK,KAAK,EAAGA,KAAD,CAAiBC;MAFR,CAAlB;MAIArB,KAAK,CAACgB,UAAN,CAAiB,uBAAjB;IACD;EACF,CA7CD;AA8CD;;AAED,eAAexB,aAAa,CAACE,iBAAD,EAAoB;EAC9C4B,IAAI,EAAE,oBADwC;EAE9CC,YAAY,EAAE,CAAC,kBAAD;AAFgC,CAApB,CAA5B"}