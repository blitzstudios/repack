{"version":3,"file":"RepackPlugin.js","names":["_DevelopmentPlugin","require","_LoggerPlugin","_NativeEntryPlugin","_OutputPlugin","_RepackTargetPlugin","RepackPlugin","constructor","config","sourceMaps","logger","getEntryName","compiler","entryName","options","entry","undefined","apply","webpack","DefinePlugin","__DEV__","JSON","stringify","mode","__E2E__","process","env","E2E","OutputPlugin","platform","enabled","devServer","context","output","extraChunks","NativeEntryPlugin","initializeCoreLocation","initializeCore","RepackTargetPlugin","hmr","DevelopmentPlugin","listenerIP","SourceMapDevToolPlugin","test","filename","append","module","columns","noSources","namespace","devtoolNamespace","uniqueName","LoggerPlugin","devServerEnabled","Boolean","console","exports"],"sources":["../../src/plugins/RepackPlugin.ts"],"sourcesContent":["import type { Compiler, RspackPluginInstance } from '@rspack/core';\nimport type { DevServerOptions } from '../types';\nimport { DevelopmentPlugin } from './DevelopmentPlugin';\nimport { LoggerPlugin, type LoggerPluginConfig } from './LoggerPlugin';\nimport { NativeEntryPlugin } from './NativeEntryPlugin';\nimport { OutputPlugin, type OutputPluginConfig } from './OutputPlugin';\nimport { RepackTargetPlugin } from './RepackTargetPlugin';\n\n/**\n * {@link RepackPlugin} configuration options.\n */\nexport interface RepackPluginConfig {\n  /** Context in which all resolution happens. Usually it's project root directory. */\n  context: string;\n\n  /** Compilation mode. */\n  mode: 'development' | 'production';\n\n  /** Target application platform. */\n  platform: string;\n\n  /**\n   * Development server configuration options.\n   * Used to configure `@callstack/repack-dev-server`.\n   *\n   * If `undefined`, then development server will not be used.\n   */\n  devServer?: DevServerOptions;\n\n  /**\n   * Whether source maps should be generated. Defaults to `true`.\n   *\n   * Setting this to `false`, disables any source map generation.\n   */\n  sourceMaps?: boolean;\n\n  /**\n   * Output options specifying where to save generated bundle, source map and assets.\n   *\n   * Refer to {@link OutputPluginConfig.output} for more details.\n   */\n  output: OutputPluginConfig['output'];\n\n  /** The entry chunk name, `main` by default. */\n  entryName?: string;\n\n  /**\n   * Absolute location to JS file with initialization logic for React Native.\n   * Useful if you want to built for out-of-tree platforms.\n   */\n  initializeCore?: string;\n\n  /**\n   * Options specifying how to deal with extra chunks generated in the compilation,\n   * usually by using dynamic `import(...)` function.\n   *\n   * Refer to {@link OutputPluginConfig.extraChunks} for more details.\n   */\n  extraChunks?: OutputPluginConfig['extraChunks'];\n\n  /**\n   * Options to configure {@link LoggerPlugin}'s `output`.\n   *\n   * Setting this to `false` disables {@link LoggerPlugin}.\n   */\n  logger?: LoggerPluginConfig['output'] | boolean;\n\n  listenerIP?: string;\n}\n\n/**\n * Webpack plugin, which abstracts configuration of other Re.Pack's plugin\n * to make Webpack config more readable.\n *\n * @example Usage in Webpack config (ESM):\n * ```ts\n * import * as Repack from '@callstack/repack';\n *\n * export default (env) => {\n *   const {\n *     mode = 'development',\n *     platform,\n *     devServer = undefined,\n *   } = env;\n *\n *   return {\n *     plugins: [\n *       new Repack.RepackPlugin({\n *         mode,\n *         platform,\n *         devServer,\n *       }),\n *     ],\n *   };\n * };\n * ```\n *\n * Internally, `RepackPlugin` configures the following plugins:\n * - `webpack.DefinePlugin` with `__DEV__` global\n * - {@link AssetsResolverPlugin}\n * - {@link OutputPlugin}\n * - {@link DevelopmentPlugin}\n * - {@link RepackTargetPlugin}\n * - `webpack.SourceMapDevToolPlugin`\n * - {@link LoggerPlugin}\n *\n * `RepackPlugin` provides a sensible defaults, but can be customized to some extent.\n * If you need more control, it's recommended to remove `RepackPlugin` and use other plugins\n * directly, eg:\n * ```ts\n * import * as Repack from '@callstack/repack';\n *\n * new Repack.plugins.AssetsResolverPlugin();\n * ```\n *\n * @category Webpack Plugin\n */\nexport class RepackPlugin implements RspackPluginInstance {\n  /**\n   * Constructs new `RepackPlugin`.\n   *\n   * @param config Plugin configuration options.\n   */\n  constructor(private config: RepackPluginConfig) {\n    this.config.sourceMaps = this.config.sourceMaps ?? true;\n    this.config.logger = this.config.logger ?? true;\n  }\n\n  private getEntryName(compiler: Compiler) {\n    if (this.config.entryName) {\n      return this.config.entryName;\n    }\n\n    if (\n      typeof compiler.options.entry === 'object' &&\n      'main' in compiler.options.entry\n    ) {\n      return 'main';\n    }\n\n    return undefined;\n  }\n\n  /**\n   * Apply the plugin.\n   *\n   * @param compiler Webpack compiler instance.\n   */\n  apply(compiler: Compiler) {\n    const entryName = this.getEntryName(compiler);\n\n    new compiler.webpack.DefinePlugin({\n      __DEV__: JSON.stringify(this.config.mode === 'development'),\n      __E2E__: JSON.stringify(process.env.E2E),\n    }).apply(compiler);\n\n    new OutputPlugin({\n      platform: this.config.platform,\n      enabled: !this.config.devServer && !!entryName,\n      context: this.config.context,\n      output: this.config.output,\n      entryName: this.config.entryName,\n      extraChunks: this.config.extraChunks,\n    }).apply(compiler);\n\n    if (entryName) {\n      new NativeEntryPlugin({\n        entryName,\n        initializeCoreLocation: this.config.initializeCore,\n      }).apply(compiler);\n    }\n\n    new RepackTargetPlugin({\n      hmr: this.config.devServer?.hmr,\n    }).apply(compiler);\n\n    new DevelopmentPlugin({\n      devServer: this.config.devServer,\n      listenerIP: this.config?.listenerIP,\n      entryName,\n      platform: this.config.platform,\n    }).apply(compiler);\n\n    if (this.config.sourceMaps) {\n      // TODO Fix sourcemap directory structure\n      // Right now its very messy and not every node module is inside of the node module\n      // like React Devtools backend etc or some symilinked module appear with relative path\n      // We should normalize this through a custom handler and provide an output similar to Metro\n      new compiler.webpack.SourceMapDevToolPlugin({\n        test: /\\.(js)?bundle$/,\n        filename: '[file].map',\n        append: `//# sourceMappingURL=[url]?platform=${this.config.platform}`,\n        module: true,\n        columns: true,\n        noSources: false,\n        namespace:\n          compiler.options.output.devtoolNamespace ??\n          compiler.options.output.uniqueName,\n      }).apply(compiler);\n    }\n\n    if (this.config.logger) {\n      new LoggerPlugin({\n        platform: this.config.platform,\n        devServerEnabled: Boolean(this.config.devServer),\n        output: {\n          console: true,\n          ...(typeof this.config.logger === 'object' ? this.config.logger : {}),\n        },\n      }).apply(compiler);\n    }\n  }\n}\n"],"mappings":"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","ignoreList":[]}