{"version":3,"file":"ModuleFederationPluginV1.js","names":["_utils","require","_isRspackCompiler","ModuleFederationPluginV1","constructor","pluginConfig","reactNativeDeepImports","config","deepImports","getModuleFederationPlugin","compiler","isRspackCompiler","webpack","container","ModuleFederationPlugin","replaceRemotes","remote","startsWith","Federated","createRemote","Array","isArray","map","remoteItem","replaced","key","value","external","getDefaultSharedDependencies","react","SHARED_REACT","SHARED_REACT_NATIVE","adaptSharedDependencies","shared","sharedDependencyConfig","eager","version","singleton","requiredVersion","findSharedDependency","name","dependencies","find","item","Boolean","sharedReactNative","reactNativeEager","undefined","reactNativeVersion","adjustedSharedDependencies","push","Object","assign","apply","filenameConfig","filename","exposes","libraryConfig","type","library","remotesConfig","remotes","sharedConfig","exports"],"sources":["../../src/plugins/ModuleFederationPluginV1.ts"],"sourcesContent":["import type { Compiler, RspackPluginInstance, container } from '@rspack/core';\nimport { Federated } from '../utils';\nimport { isRspackCompiler } from './utils/isRspackCompiler';\n\ntype MFPluginV1 = typeof container.ModuleFederationPluginV1;\ntype MFPluginV1Options = ConstructorParameters<MFPluginV1>[0];\n\ntype ExtractObject<T> = T extends {}\n  ? T extends Array<any>\n    ? never\n    : T\n  : never;\n\ntype RemotesObject = ExtractObject<MFPluginV1Options['remotes']>;\n\ntype SharedDependencies = Exclude<MFPluginV1Options['shared'], undefined>;\n\ntype SharedObject = ExtractObject<SharedDependencies>;\n\ntype SharedConfig = SharedObject extends { [key: string]: infer U }\n  ? Exclude<U, string>\n  : never;\n\n/**\n * {@link ModuleFederationPlugin} configuration options.\n *\n * The fields and types are exactly the same as in `webpack.container.ModuleFederationPlugin`.\n *\n * You can check documentation for all supported options here: https://webpack.js.org/plugins/module-federation-plugin/\n */\nexport interface ModuleFederationPluginV1Config extends MFPluginV1Options {\n  /** Enable or disable adding React Native deep imports to shared dependencies */\n  reactNativeDeepImports?: boolean;\n}\n\n/**\n * Webpack plugin to configure Module Federation with platform differences\n * handled under the hood.\n *\n * Usually, you should use `Repack.plugin.ModuleFederationPlugin`\n * instead of `webpack.container.ModuleFederationPlugin`.\n *\n * `Repack.plugin.ModuleFederationPlugin` creates:\n * - default for `filename` option when `exposes` is defined\n * - default for `library` option when `exposes` is defined\n * - default for `shared` option with `react` and `react-native` dependencies\n * - converts `remotes` into `ScriptManager`-powered `promise new Promise` loaders\n *\n * You can overwrite all defaults by passing respective options.\n *\n * `remotes` will always be converted to ScriptManager`-powered `promise new Promise` loaders\n * using {@link Federated.createRemote}.\n *\n * @example Host example.\n * ```js\n * import * as Repack from '@callstack/repack';\n *\n * new Repack.plugins.ModuleFederationPlugin({\n *   name: 'host,\n * });\n * ```\n *\n * @example Host example with additional `shared` dependencies.\n * ```js\n * import * as Repack from '@callstack/repack';\n *\n * new Repack.plugins.ModuleFederationPlugin({\n *   name: 'host,\n *   shared: {\n *     react: Repack.Federated.SHARED_REACT,\n *     'react-native': Repack.Federated.SHARED_REACT,\n *     'react-native-reanimated': {\n *       singleton: true,\n *     },\n *   },\n * });\n * ```\n *\n * @example Container examples.\n * ```js\n * import * as Repack from '@callstack/repack';\n *\n * new Repack.plugins.ModuleFederationPlugin({\n *   name: 'app1',\n *   remotes: {\n *     module1: 'module1@https://example.com/module1.container.bundle',\n *   },\n * });\n *\n * new Repack.plugins.ModuleFederationPlugin({\n *   name: 'app2',\n *   remotes: {\n *     module1: 'module1@https://example.com/module1.container.bundle',\n *     module2: 'module1@dynamic',\n *   },\n * });\n * ```\n *\n * @category Webpack Plugin\n */\nexport class ModuleFederationPluginV1 implements RspackPluginInstance {\n  private config: MFPluginV1Options;\n  private deepImports: boolean;\n\n  constructor(pluginConfig: ModuleFederationPluginV1Config) {\n    const { reactNativeDeepImports, ...config } = pluginConfig;\n    this.config = config;\n    this.deepImports = reactNativeDeepImports ?? true;\n  }\n\n  /**\n   * This method provides compatibility between webpack and Rspack for the ModuleFederation plugin.\n   * In Rspack, Module Federation 1.5 is implemented under the name that's used in webpack for the original version.\n   * This method adjusts for this naming difference to ensure we use the correct plugin version.\n   *\n   * @param compiler - The compiler instance (either webpack or Rspack)\n   * @returns The appropriate ModuleFederationPlugin class\n   */\n  private getModuleFederationPlugin(compiler: Compiler): MFPluginV1 {\n    if (isRspackCompiler(compiler)) {\n      return compiler.webpack.container.ModuleFederationPluginV1;\n    }\n    // @ts-expect-error webpack has MF1 under ModuleFederationPlugin\n    return compiler.webpack.container.ModuleFederationPlugin;\n  }\n\n  private replaceRemotes<T extends string | string[] | RemotesObject>(\n    remote: T\n  ): T {\n    if (typeof remote === 'string') {\n      return remote.startsWith('promise new Promise')\n        ? remote\n        : (Federated.createRemote(remote) as T);\n    }\n\n    if (Array.isArray(remote)) {\n      return remote.map((remoteItem) => this.replaceRemotes(remoteItem)) as T;\n    }\n\n    const replaced = {} as RemotesObject;\n    for (const key in remote as RemotesObject) {\n      const value = remote[key];\n      if (typeof value === 'string' || Array.isArray(value)) {\n        replaced[key] = this.replaceRemotes(value);\n      } else {\n        replaced[key] = {\n          ...value,\n          external: this.replaceRemotes(value.external),\n        };\n      }\n    }\n\n    return replaced as T;\n  }\n\n  private getDefaultSharedDependencies(): SharedObject {\n    return {\n      react: Federated.SHARED_REACT,\n      'react-native': Federated.SHARED_REACT_NATIVE,\n    };\n  }\n\n  /**\n   * As including 'react-native' as a shared dependency is not enough to support\n   * deep imports from 'react-native' (e.g. 'react-native/Libraries/Utilities/PixelRatio'),\n   * we need to add deep imports using an undocumented feature of ModuleFederationPlugin.\n   *\n   * When a dependency has a trailing slash, deep imports of that dependency will be correctly\n   * resolved by reaching out to the shared scope. This also ensures single instances of things\n   * like 'assetsRegistry'. Additionally, we mark every package from '@react-native' group as shared\n   * as well, as these are used by React Native too.\n   *\n   * Reference: https://stackoverflow.com/questions/65636979/wp5-module-federation-sharing-deep-imports\n   * Reference: https://github.com/webpack/webpack/blob/main/lib/sharing/resolveMatchedConfigs.js#L77-L79\n   *\n   * @param shared shared dependencies configuration from ModuleFederationPlugin\n   * @returns adjusted shared dependencies configuration\n   *\n   * @internal\n   */\n  private adaptSharedDependencies(\n    shared: SharedDependencies\n  ): SharedDependencies {\n    const sharedDependencyConfig = (\n      eager?: boolean,\n      version?: string | false\n    ) => ({\n      singleton: true,\n      eager: eager ?? true,\n      version: version || '*',\n      requiredVersion: version || '*',\n    });\n\n    const findSharedDependency = (\n      name: string,\n      dependencies: SharedDependencies\n    ): SharedConfig | string | undefined => {\n      if (Array.isArray(dependencies)) {\n        return dependencies.find((item) =>\n          typeof item === 'string' ? item === name : Boolean(item[name])\n        );\n      }\n      return dependencies[name];\n    };\n\n    const sharedReactNative = findSharedDependency('react-native', shared);\n    const reactNativeEager =\n      typeof sharedReactNative === 'object'\n        ? sharedReactNative.eager\n        : undefined;\n    const reactNativeVersion =\n      typeof sharedReactNative === 'object'\n        ? sharedReactNative.requiredVersion || sharedReactNative.version\n        : undefined;\n\n    if (!this.deepImports || !sharedReactNative) {\n      return shared;\n    }\n\n    if (Array.isArray(shared)) {\n      const adjustedSharedDependencies = [...shared];\n      if (!findSharedDependency('react-native/', shared)) {\n        adjustedSharedDependencies.push({\n          'react-native/': sharedDependencyConfig(\n            reactNativeEager,\n            reactNativeVersion\n          ),\n        });\n      }\n      if (!findSharedDependency('@react-native/', shared)) {\n        adjustedSharedDependencies.push({\n          '@react-native/': sharedDependencyConfig(\n            reactNativeEager,\n            reactNativeVersion\n          ),\n        });\n      }\n      return adjustedSharedDependencies;\n    }\n    const adjustedSharedDependencies = { ...shared };\n    if (!findSharedDependency('react-native/', shared)) {\n      Object.assign(adjustedSharedDependencies, {\n        'react-native/': sharedDependencyConfig(reactNativeEager),\n      });\n    }\n    if (!findSharedDependency('@react-native/', shared)) {\n      Object.assign(adjustedSharedDependencies, {\n        '@react-native/': sharedDependencyConfig(reactNativeEager),\n      });\n    }\n    return adjustedSharedDependencies;\n  }\n\n  /**\n   * Apply the plugin.\n   *\n   * @param compiler Webpack compiler instance.\n   */\n  apply(compiler: Compiler) {\n    const ModuleFederationPlugin = this.getModuleFederationPlugin(compiler);\n\n    const filenameConfig =\n      this.config.filename ??\n      (this.config.exposes\n        ? `${this.config.name}.container.bundle`\n        : undefined);\n\n    const libraryConfig = this.config.exposes\n      ? {\n          name: this.config.name,\n          type: 'self',\n          ...this.config.library,\n        }\n      : undefined;\n\n    const remotesConfig = Array.isArray(this.config.remotes)\n      ? this.config.remotes.map((remote) => this.replaceRemotes(remote))\n      : this.replaceRemotes(this.config.remotes ?? {});\n\n    const sharedConfig = this.adaptSharedDependencies(\n      this.config.shared ?? this.getDefaultSharedDependencies()\n    );\n\n    new ModuleFederationPlugin({\n      ...this.config,\n      filename: filenameConfig,\n      library: libraryConfig,\n      remotes: remotesConfig,\n      shared: sharedConfig,\n    }).apply(compiler);\n  }\n}\n"],"mappings":"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","ignoreList":[]}