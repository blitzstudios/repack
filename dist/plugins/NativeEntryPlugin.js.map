{"version":3,"file":"NativeEntryPlugin.js","names":["_nodePath","_interopRequireDefault","require","_isRspackCompiler","_moveElementBefore","e","__esModule","default","NativeEntryPlugin","constructor","config","getReactNativePath","candidate","reactNativePath","candidates","filter","Boolean","resolve","path","extname","dirname","apply","compiler","options","alias","undefined","getReactNativePolyfills","join","initializeCorePath","initializeCoreLocation","initializeScriptManagerPath","includeModulesPath","nativeEntries","hooks","entryOption","tap","name","before","_","entry","Error","Object","keys","forEach","entryName","entryChunkName","runtime","nativeEntry","webpack","EntryPlugin","context","isRspackCompiler","make","stage","compilation","entries","values","moveElementBefore","dependencies","elementToMove","beforeElement","getElement","dependency","request","exports"],"sources":["../../src/plugins/NativeEntryPlugin.ts"],"sourcesContent":["import path from 'node:path';\nimport type {\n  Compiler,\n  ResolveAlias,\n  RspackPluginInstance,\n} from '@rspack/core';\nimport { isRspackCompiler } from './utils/isRspackCompiler.js';\nimport { moveElementBefore } from './utils/moveElementBefore.js';\n\nexport interface NativeEntryPluginConfig {\n  /**\n   * Absolute location to JS file with initialization logic for React Native.\n   * Useful if you want to built for out-of-tree platforms.\n   */\n  initializeCoreLocation?: string;\n}\n\nexport class NativeEntryPlugin implements RspackPluginInstance {\n  constructor(private config: NativeEntryPluginConfig) {}\n\n  private getReactNativePath(\n    candidate: Exclude<ResolveAlias, false>[string] | undefined\n  ) {\n    let reactNativePath: string | undefined;\n    if (typeof candidate === 'string') {\n      reactNativePath = candidate;\n    }\n    if (typeof candidate === 'object') {\n      const candidates = candidate.filter(Boolean) as string[];\n      reactNativePath = candidates[0];\n    }\n    if (!reactNativePath) {\n      reactNativePath = require.resolve('react-native');\n    }\n\n    return path.extname(reactNativePath)\n      ? path.dirname(reactNativePath)\n      : reactNativePath;\n  }\n\n  apply(compiler: Compiler) {\n    const reactNativePath = this.getReactNativePath(\n      compiler.options.resolve.alias\n        ? compiler.options.resolve.alias?.['react-native']\n        : undefined\n    );\n\n    const getReactNativePolyfills: () => string[] = require(\n      path.join(reactNativePath, 'rn-get-polyfills.js')\n    );\n\n    const initializeCorePath =\n      this.config?.initializeCoreLocation ??\n      path.join(reactNativePath, 'Libraries/Core/InitializeCore.js');\n\n    const initializeScriptManagerPath = require.resolve(\n      '../modules/InitializeScriptManager.js'\n    );\n\n    const includeModulesPath = require.resolve('../modules/IncludeModules.js');\n\n    const nativeEntries = [\n      ...getReactNativePolyfills(),\n      initializeCorePath,\n      initializeScriptManagerPath,\n      includeModulesPath,\n    ];\n\n    compiler.hooks.entryOption.tap(\n      { name: 'RepackNativeEntryPlugin', before: 'RepackDevelopmentPlugin' },\n      (_, entry) => {\n        if (typeof entry === 'function') {\n          throw new Error(\n            '[RepackNativeEntryPlugin] Dynamic entry (function) is not supported.'\n          );\n        }\n\n        Object.keys(entry).forEach((entryName) => {\n          // runtime property defines the chunk name, otherwise it defaults to the entry key\n          const entryChunkName = entry[entryName].runtime || entryName;\n\n          // add native entries to all declared entry points\n          for (const nativeEntry of nativeEntries) {\n            new compiler.webpack.EntryPlugin(compiler.context, nativeEntry, {\n              name: entryChunkName, // prepends the entry to the chunk of specified name\n            }).apply(compiler);\n          }\n        });\n      }\n    );\n\n    if (!isRspackCompiler(compiler)) {\n      // In Webpack, Module Federation Container entry gets injected during the compilation's make phase,\n      // similar to how dynamic entries work. This means the federation entry is added after our native entries.\n      // We need to reorder dependencies to ensure federation entry is placed before native entries.\n      compiler.hooks.make.tap(\n        { name: 'RepackNativeEntryPlugin', stage: 1000 },\n        (compilation) => {\n          for (const entry of compilation.entries.values()) {\n            moveElementBefore(entry.dependencies, {\n              elementToMove: /\\.federation\\/entry/,\n              beforeElement: nativeEntries[0],\n              getElement: (dependency) => dependency.request ?? '',\n            });\n          }\n        }\n      );\n    }\n  }\n}\n"],"mappings":"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","ignoreList":[]}