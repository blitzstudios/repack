{"version":3,"file":"transformBundleToHermesBytecode.js","names":["_nodeFs","_interopRequireDefault","require","_execa","e","__esModule","default","transformBundleToHermesBytecode","hermesCLIPath","useSourceMaps","bundlePath","hermesBundlePath","hermesSourceMapPath","execa","filter","Boolean","fs","promises","unlink","rename","sourceMap","error","message","toString","Error","exports"],"sources":["../../../../src/plugins/ChunksToHermesBytecodePlugin/utils/transformBundleToHermesBytecode.ts"],"sourcesContent":["import fs from 'node:fs';\nimport execa from 'execa';\n\ninterface TransformBundleToHermesBytecodeOptions {\n  /** Path to the Hermes compiler binary. */\n  hermesCLIPath: string;\n\n  /** Whether to generate source maps. */\n  useSourceMaps: boolean;\n\n  /** Path to the bundle to be transformed. */\n  bundlePath: string;\n}\n\n/**\n * Transforms a bundle to Hermes bytecode.\n *\n * Logic based on implementations for each platform.\n * - iOS: [react-native-xcode.sh](https://github.com/facebook/react-native/blob/f38fc9ba8681622f7cfdb586753e50c596946929/packages/react-native/scripts/react-native-xcode.sh#L166-L187)\n * - Android: [BundleHermesCTask.kt](https://github.com/facebook/react-native/blob/f38fc9ba8681622f7cfdb586753e50c596946929/packages/react-native-gradle-plugin/src/main/kotlin/com/facebook/react/tasks/BundleHermesCTask.kt#L93-L111) (with defaults in [ReactExtension.kt](https://github.com/facebook/react-native/blob/f38fc9ba8681622f7cfdb586753e50c596946929/packages/react-native-gradle-plugin/src/main/kotlin/com/facebook/react/ReactExtension.kt#L116-L117))\n */\nexport const transformBundleToHermesBytecode = async ({\n  hermesCLIPath,\n  useSourceMaps,\n  bundlePath,\n}: TransformBundleToHermesBytecodeOptions) => {\n  const hermesBundlePath = bundlePath + '.hbc';\n  const hermesSourceMapPath = bundlePath + '.hbc.map';\n\n  try {\n    // Transform bundle to bytecode\n    await execa(\n      hermesCLIPath,\n      [\n        '-w', // Silence warnings else buffer overflows\n        '-O', // Enable optimizations\n        '-emit-binary',\n        '-out',\n        hermesBundlePath,\n        useSourceMaps ? '-output-source-map' : '',\n        bundlePath,\n      ].filter(Boolean)\n    );\n\n    await fs.promises.unlink(bundlePath);\n    await fs.promises.rename(hermesBundlePath, bundlePath);\n\n    return { sourceMap: hermesSourceMapPath };\n  } catch (error) {\n    const message = (error as Error).toString();\n    throw new Error(\n      `ChunksToHermesBytecodePlugin: Failed to transform bundle ${bundlePath}. Reason:\\n${message})`\n    );\n  }\n};\n"],"mappings":";;;;;;AAAA,IAAAA,OAAA,GAAAC,sBAAA,CAAAC,OAAA;AACA,IAAAC,MAAA,GAAAF,sBAAA,CAAAC,OAAA;AAA0B,SAAAD,uBAAAG,CAAA,WAAAA,CAAA,IAAAA,CAAA,CAAAC,UAAA,GAAAD,CAAA,KAAAE,OAAA,EAAAF,CAAA;AAa1B;AACA;AACA;AACA;AACA;AACA;AACA;AACO,MAAMG,+BAA+B,GAAG,MAAAA,CAAO;EACpDC,aAAa;EACbC,aAAa;EACbC;AACsC,CAAC,KAAK;EAC5C,MAAMC,gBAAgB,GAAGD,UAAU,GAAG,MAAM;EAC5C,MAAME,mBAAmB,GAAGF,UAAU,GAAG,UAAU;EAEnD,IAAI;IACF;IACA,MAAM,IAAAG,cAAK,EACTL,aAAa,EACb,CACE,IAAI;IAAE;IACN,IAAI;IAAE;IACN,cAAc,EACd,MAAM,EACNG,gBAAgB,EAChBF,aAAa,GAAG,oBAAoB,GAAG,EAAE,EACzCC,UAAU,CACX,CAACI,MAAM,CAACC,OAAO,CAClB,CAAC;IAED,MAAMC,eAAE,CAACC,QAAQ,CAACC,MAAM,CAACR,UAAU,CAAC;IACpC,MAAMM,eAAE,CAACC,QAAQ,CAACE,MAAM,CAACR,gBAAgB,EAAED,UAAU,CAAC;IAEtD,OAAO;MAAEU,SAAS,EAAER;IAAoB,CAAC;EAC3C,CAAC,CAAC,OAAOS,KAAK,EAAE;IACd,MAAMC,OAAO,GAAID,KAAK,CAAWE,QAAQ,CAAC,CAAC;IAC3C,MAAM,IAAIC,KAAK,CACb,4DAA4Dd,UAAU,cAAcY,OAAO,GAC7F,CAAC;EACH;AACF,CAAC;AAACG,OAAA,CAAAlB,+BAAA,GAAAA,+BAAA","ignoreList":[]}