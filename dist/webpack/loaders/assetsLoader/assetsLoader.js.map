{"version":3,"file":"assetsLoader.js","names":["raw","testXml","testMP4","testImages","testFonts","repackAssetsLoader","cacheable","callback","async","logger","getLogger","rootContext","debug","resourcePath","options","getOptions","pathSeparatorRegexp","RegExp","path","sep","resourceAbsoluteDirname","dirname","resourceDirname","relative","replace","resourceExtensionType","extname","suffixPattern","platform","resourceFilename","basename","resourceNormalizedFilename","length","toLowerCase","assetsDirname","files","getFilesInDirectory","fs","scales","AssetResolver","collectScales","scalableAssetExtensions","name","type","scaleKeys","Object","keys","sort","a","b","getScaleNumber","scaleKey","filenameWithScale","join","addDependency","assets","Promise","all","map","content","readFile","destination","devServerEnabled","test","indexOf","Error","filename","scale","asset","inline","inlineAssets","emitFile","extractAssets","publicPath","error"],"sources":["../../../../src/webpack/loaders/assetsLoader/assetsLoader.ts"],"sourcesContent":["import path from 'path';\nimport type { LoaderContext } from 'loader-utils';\nimport { AssetResolver } from '../../plugins/AssetsResolverPlugin/AssetResolver';\nimport { getOptions } from './options';\nimport { inlineAssets } from './inlineAssets';\nimport { getFilesInDirectory, getScaleNumber, readFile } from './utils';\nimport type { Asset } from './types';\nimport { extractAssets } from './extractAssets';\n\nexport const raw = true;\n\nconst testXml = /\\.(xml)$/;\nconst testMP4 = /\\.(mp4)$/;\nconst testImages = /\\.(png|jpg|gif|webp)$/;\nconst testFonts = /\\.(ttf|otf|ttc)$/;\n\nexport default async function repackAssetsLoader(this: LoaderContext) {\n  this.cacheable();\n\n  const callback = this.async();\n  const logger = this.getLogger('repackAssetsLoader');\n  const rootContext = this.rootContext;\n\n  logger.debug(`Processing asset ${this.resourcePath}`);\n\n  try {\n    const options = getOptions(this);\n    const pathSeparatorRegexp = new RegExp(`\\\\${path.sep}`, 'g');\n    const resourcePath = this.resourcePath;\n    const resourceAbsoluteDirname = path.dirname(resourcePath);\n    // Relative path to rootContext without any ../ due to https://github.com/callstack/haul/issues/474\n    // Assets from from outside of rootContext, should still be placed inside bundle output directory.\n    // Example:\n    //   resourcePath    = <abs>/monorepo/node_modules/my-module/image.png\n    //   dirname         = <abs>/monorepo/node_modules/my-module\n    //   rootContext     = <abs>/monorepo/packages/my-app/\n    //   resourceDirname = ../../node_modules/my-module (original)\n    // So when we calculate destination for the asset for iOS (assetsDirname + resourceDirname + filename),\n    // it will end up outside of `assets` directory, so we have to make sure it's:\n    //   resourceDirname = node_modules/my-module (tweaked)\n    const resourceDirname = path\n      .relative(rootContext, resourceAbsoluteDirname)\n      .replace(new RegExp(`^[\\\\.\\\\${path.sep}]+`), '');\n    const resourceExtensionType = path.extname(resourcePath).replace(/^\\./, '');\n    const suffixPattern = `(@\\\\d+(\\\\.\\\\d+)?x)?(\\\\.(${options.platform}|native))?\\\\.${resourceExtensionType}$`;\n    const resourceFilename = path\n      .basename(resourcePath)\n      .replace(new RegExp(suffixPattern), '');\n    // Name with embedded resourceDirname eg `node_modules_reactnative_libraries_newappscreen_components_logo.png`\n    const resourceNormalizedFilename = `${(resourceDirname.length === 0\n      ? resourceFilename\n      : `${resourceDirname.replace(\n          pathSeparatorRegexp,\n          '_'\n        )}_${resourceFilename}`\n    )\n      .toLowerCase()\n      .replace(/[^a-z0-9_]/g, '')}.${resourceExtensionType}`;\n    const assetsDirname = 'assets';\n\n    const files = await getFilesInDirectory(resourceAbsoluteDirname, this.fs);\n    const scales = AssetResolver.collectScales(\n      options.scalableAssetExtensions,\n      files,\n      {\n        name: resourceFilename,\n        type: resourceExtensionType,\n        platform: options.platform,\n      }\n    );\n\n    const scaleKeys = Object.keys(scales).sort(\n      (a, b) => getScaleNumber(a) - getScaleNumber(b)\n    );\n\n    for (const scaleKey of scaleKeys) {\n      const filenameWithScale = path.join(\n        resourceAbsoluteDirname,\n        scales[scaleKey].name\n      );\n      this.addDependency(filenameWithScale);\n    }\n\n    const assets = await Promise.all<Asset>(\n      scaleKeys.map(async (scaleKey) => {\n        const filenameWithScale = path.join(\n          resourceAbsoluteDirname,\n          scales[scaleKey].name\n        );\n\n        const content = await readFile(filenameWithScale, this.fs);\n\n        let destination;\n\n        if (!options.devServerEnabled && options.platform === 'android') {\n          // found font family\n          if (\n            testXml.test(resourceNormalizedFilename) &&\n            content?.indexOf('font-family') !== -1\n          ) {\n            destination = 'font';\n          } else if (testFonts.test(resourceNormalizedFilename)) {\n            // font extensions\n            destination = 'font';\n          } else if (testMP4.test(resourceNormalizedFilename)) {\n            // video files extensions\n            destination = 'raw';\n          } else if (\n            testImages.test(resourceNormalizedFilename) ||\n            testXml.test(resourceNormalizedFilename)\n          ) {\n            // images extensions\n            switch (scaleKey) {\n              case '@0.75x':\n                destination = 'drawable-ldpi';\n                break;\n              case '@1x':\n                destination = 'drawable-mdpi';\n                break;\n              case '@1.5x':\n                destination = 'drawable-hdpi';\n                break;\n              case '@2x':\n                destination = 'drawable-xhdpi';\n                break;\n              case '@3x':\n                destination = 'drawable-xxhdpi';\n                break;\n              case '@4x':\n                destination = 'drawable-xxxhdpi';\n                break;\n              default:\n                throw new Error(\n                  `Unknown scale ${scaleKey} for ${filenameWithScale}`\n                );\n            }\n          } else {\n            // everything else is going to RAW\n            destination = 'raw';\n          }\n\n          destination = path.join(destination, resourceNormalizedFilename);\n        } else {\n          const name = `${resourceFilename}${\n            scaleKey === '@1x' ? '' : scaleKey\n          }.${resourceExtensionType}`;\n          destination = path.join(assetsDirname, resourceDirname, name);\n        }\n\n        return {\n          filename: destination,\n          content,\n          scaleKey,\n          scale: getScaleNumber(scaleKey),\n        };\n      })\n    );\n\n    logger.debug(`Resolved request ${this.resourcePath}`, {\n      platform: options.platform,\n      rootContext,\n      resourceNormalizedFilename,\n      resourceFilename,\n      resourceDirname,\n      resourceAbsoluteDirname,\n      resourceExtensionType,\n      scales,\n      assets: assets.map((asset) => ({\n        ...asset,\n        content: `size=${asset.content?.length} type=${typeof asset.content}`,\n      })),\n    });\n\n    if (options.inline) {\n      logger.debug(`Inlining assets for request ${resourcePath}`);\n      callback?.(\n        null,\n        inlineAssets({ assets, resourcePath, resourceFilename, suffixPattern })\n      );\n    } else {\n      for (const asset of assets) {\n        const { filename, content } = asset;\n        logger.debug(`Emitting asset ${filename} for request ${resourcePath}`);\n\n        // Assets are emitted relatively to `output.path`.\n        this.emitFile(filename, content ?? '');\n      }\n\n      callback?.(\n        null,\n        await extractAssets(\n          {\n            resourcePath,\n            resourceDirname,\n            resourceFilename,\n            resourceExtensionType,\n            assets,\n            suffixPattern,\n            assetsDirname,\n            pathSeparatorRegexp,\n            publicPath: options.publicPath,\n            devServerEnabled: options.devServerEnabled,\n          },\n          logger\n        )\n      );\n    }\n  } catch (error) {\n    callback?.(error as Error);\n  }\n}\n"],"mappings":"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"}