{"version":3,"file":"Compiler.js","names":["_worker_threads","require","_path","_interopRequireDefault","_fs","_events","_mimeTypes","_env","_utils","obj","__esModule","default","Compiler","EventEmitter","workers","assetsCache","statsCache","resolvers","progressSenders","isCompilationInProgress","constructor","cliOptions","reporter","isVerbose","spawnWorker","platform","workerData","arguments","start","process","env","WORKER_ENV_KEY","VERBOSE_ENV_KEY","undefined","worker","Worker","path","join","__dirname","stdout","stderr","SHARE_ENV","onStdChunk","chunk","fallbackType","data","toString","trim","log","JSON","parse","timestamp","Date","now","type","issuer","message","on","callPendingResolvers","error","forEach","resolver","value","event","stats","assets","reduce","acc","filename","info","asset","Buffer","from","adaptFilenameToPlatform","emit","sendProgress","total","completed","code","Error","addProgressSender","callback","push","removeProgressSender","filter","item","getAsset","fileFromCache","Promise","reject","resolve","concat","getSource","test","fs","promises","readFile","config","root","getSourceMap","sourceMapFilename","related","sourceMap","getMimeType","endsWith","mimeTypes","lookup","exports"],"sources":["../../src/webpack/Compiler.ts"],"sourcesContent":["import { Worker, SHARE_ENV } from 'worker_threads';\nimport path from 'path';\nimport fs from 'fs';\nimport EventEmitter from 'events';\nimport webpack from 'webpack';\nimport mimeTypes from 'mime-types';\nimport { SendProgress } from '@callstack/repack-dev-server';\nimport type { CliOptions, StartArguments } from '../types';\nimport type { LogType, Reporter } from '../logging';\nimport { VERBOSE_ENV_KEY, WORKER_ENV_KEY } from '../env';\nimport { adaptFilenameToPlatform } from './utils';\n\nexport interface Asset {\n  data: string | Buffer;\n  info: Record<string, any>;\n}\n\ntype Platform = string;\n\nexport class Compiler extends EventEmitter {\n  workers: Record<Platform, Worker> = {};\n  assetsCache: Record<Platform, Record<string, Asset>> = {};\n  statsCache: Record<Platform, webpack.StatsCompilation> = {};\n  resolvers: Record<Platform, Array<(error?: Error) => void>> = {};\n  progressSenders: Record<Platform, SendProgress[]> = {};\n  isCompilationInProgress: Record<Platform, boolean> = {};\n\n  constructor(\n    private cliOptions: CliOptions,\n    private reporter: Reporter,\n    private isVerbose?: boolean\n  ) {\n    super();\n  }\n\n  private spawnWorker(platform: string) {\n    this.isCompilationInProgress[platform] = true;\n\n    const workerData = {\n      ...this.cliOptions,\n      arguments: {\n        start: {\n          ...(this.cliOptions.arguments as { start: StartArguments }).start,\n          platform,\n        },\n      },\n    };\n\n    process.env[WORKER_ENV_KEY] = '1';\n    process.env[VERBOSE_ENV_KEY] = this.isVerbose ? '1' : undefined;\n\n    const worker = new Worker(path.join(__dirname, './webpackWorker.js'), {\n      stdout: true,\n      stderr: true,\n      env: SHARE_ENV,\n      workerData,\n    });\n\n    const onStdChunk = (chunk: string | Buffer, fallbackType: LogType) => {\n      const data = chunk.toString().trim();\n      if (data) {\n        try {\n          const log = JSON.parse(data);\n          this.reporter.process(log);\n        } catch {\n          this.reporter.process({\n            timestamp: Date.now(),\n            type: fallbackType,\n            issuer: 'WebpackCompilerWorker',\n            message: [data],\n          });\n        }\n      }\n    };\n\n    worker.stdout.on('data', (chunk) => {\n      onStdChunk(chunk, 'info');\n    });\n\n    worker.stderr.on('data', (chunk) => {\n      onStdChunk(chunk, 'info');\n    });\n\n    const callPendingResolvers = (error?: Error) => {\n      this.resolvers[platform].forEach((resolver) => resolver(error));\n      this.resolvers[platform] = [];\n    };\n\n    worker.on(\n      'message',\n      (\n        value:\n          | { event: 'watchRun' | 'invalid' }\n          | {\n              event: 'progress';\n              total: number;\n              completed: number;\n              message: string;\n            }\n          | { event: 'error'; error: Error }\n          | {\n              event: 'done';\n              assets: Array<{\n                filename: string;\n                data: Uint8Array;\n                info: Record<string, any>;\n              }>;\n              stats: webpack.StatsCompilation;\n            }\n      ) => {\n        if (value.event === 'done') {\n          this.isCompilationInProgress[platform] = false;\n          this.statsCache[platform] = value.stats;\n          this.assetsCache[platform] = value.assets.reduce(\n            (acc, { filename, data, info }) => {\n              const asset = {\n                data: Buffer.from(data),\n                info,\n              };\n              return {\n                ...acc,\n                [adaptFilenameToPlatform(filename)]: asset,\n              };\n            },\n            {}\n          );\n          callPendingResolvers();\n          this.emit(value.event, { platform, stats: value.stats });\n        } else if (value.event === 'error') {\n          this.emit(value.event, value.error);\n        } else if (value.event === 'progress') {\n          this.progressSenders[platform].forEach((sendProgress) =>\n            sendProgress({\n              total: value.total,\n              completed: value.completed,\n            })\n          );\n          this.emit(value.event, {\n            total: value.total,\n            completed: value.completed,\n            message: value.message,\n          });\n        } else {\n          this.isCompilationInProgress[platform] = true;\n          this.emit(value.event, { platform });\n        }\n      }\n    );\n\n    worker.on('error', (error) => {\n      callPendingResolvers(error);\n    });\n\n    worker.on('exit', (code) => {\n      callPendingResolvers(new Error(`Worker stopped with exit code ${code}`));\n    });\n\n    return worker;\n  }\n\n  private addProgressSender(platform: string, callback?: SendProgress) {\n    if (!callback) return;\n    this.progressSenders[platform] = this.progressSenders[platform] ?? [];\n    this.progressSenders[platform].push(callback);\n  }\n\n  private removeProgressSender(platform: string, callback?: SendProgress) {\n    if (!callback) return;\n    this.progressSenders[platform] = this.progressSenders[platform].filter(\n      (item) => item !== callback\n    );\n  }\n\n  async getAsset(\n    filename: string,\n    platform: string,\n    sendProgress?: SendProgress\n  ): Promise<Asset> {\n    // Return file from assetsCache if exists\n    const fileFromCache = this.assetsCache[platform]?.[filename];\n    if (fileFromCache) return fileFromCache;\n\n    this.addProgressSender(platform, sendProgress);\n\n    // Spawn new worker if not already running\n    if (!this.workers[platform]) {\n      this.workers[platform] = this.spawnWorker(platform);\n    } else if (!this.isCompilationInProgress[platform]) {\n      this.removeProgressSender(platform, sendProgress);\n      return Promise.reject(\n        new Error(\n          `File ${filename} for ${platform} not found in compilation assets`\n        )\n      );\n    }\n\n    return await new Promise<Asset>((resolve, reject) => {\n      // Add new resolver to be executed when compilation is finished\n      this.resolvers[platform] = (this.resolvers[platform] ?? []).concat(\n        (error?: Error) => {\n          this.removeProgressSender(platform, sendProgress);\n\n          if (error) {\n            reject(error);\n          } else {\n            const fileFromCache = this.assetsCache[platform]?.[filename];\n            if (fileFromCache) {\n              resolve(fileFromCache);\n            } else {\n              reject(\n                new Error(\n                  `File ${filename} for ${platform} not found in compilation assets`\n                )\n              );\n            }\n          }\n        }\n      );\n    });\n  }\n\n  async getSource(\n    filename: string,\n    platform?: string\n  ): Promise<string | Buffer> {\n    if (/\\.bundle/.test(filename) && platform) {\n      return (await this.getAsset(filename, platform)).data;\n    }\n\n    return fs.promises.readFile(\n      path.join(this.cliOptions.config.root, filename),\n      'utf8'\n    );\n  }\n\n  async getSourceMap(\n    filename: string,\n    platform: string\n  ): Promise<string | Buffer> {\n    const { info } = await this.getAsset(filename, platform);\n    const sourceMapFilename = info.related?.sourceMap as string | undefined;\n\n    if (sourceMapFilename) {\n      return (await this.getAsset(sourceMapFilename, platform)).data;\n    }\n\n    return Promise.reject(\n      new Error(`Source map for ${filename} for ${platform} is missing`)\n    );\n  }\n\n  getMimeType(filename: string) {\n    if (filename.endsWith('.bundle')) {\n      return 'text/javascript';\n    }\n\n    return mimeTypes.lookup(filename) || 'text/plain';\n  }\n}\n"],"mappings":";;;;;;AAAA,IAAAA,eAAA,GAAAC,OAAA;AACA,IAAAC,KAAA,GAAAC,sBAAA,CAAAF,OAAA;AACA,IAAAG,GAAA,GAAAD,sBAAA,CAAAF,OAAA;AACA,IAAAI,OAAA,GAAAF,sBAAA,CAAAF,OAAA;AAEA,IAAAK,UAAA,GAAAH,sBAAA,CAAAF,OAAA;AAIA,IAAAM,IAAA,GAAAN,OAAA;AACA,IAAAO,MAAA,GAAAP,OAAA;AAAkD,SAAAE,uBAAAM,GAAA,WAAAA,GAAA,IAAAA,GAAA,CAAAC,UAAA,GAAAD,GAAA,KAAAE,OAAA,EAAAF,GAAA;AAS3C,MAAMG,QAAQ,SAASC,eAAY,CAAC;EACzCC,OAAO,GAA6B,CAAC,CAAC;EACtCC,WAAW,GAA4C,CAAC,CAAC;EACzDC,UAAU,GAA+C,CAAC,CAAC;EAC3DC,SAAS,GAAqD,CAAC,CAAC;EAChEC,eAAe,GAAqC,CAAC,CAAC;EACtDC,uBAAuB,GAA8B,CAAC,CAAC;EAEvDC,WAAWA,CACDC,UAAsB,EACtBC,QAAkB,EAClBC,SAAmB,EAC3B;IACA,KAAK,CAAC,CAAC;IAAC,KAJAF,UAAsB,GAAtBA,UAAsB;IAAA,KACtBC,QAAkB,GAAlBA,QAAkB;IAAA,KAClBC,SAAmB,GAAnBA,SAAmB;EAG7B;EAEQC,WAAWA,CAACC,QAAgB,EAAE;IACpC,IAAI,CAACN,uBAAuB,CAACM,QAAQ,CAAC,GAAG,IAAI;IAE7C,MAAMC,UAAU,GAAG;MACjB,GAAG,IAAI,CAACL,UAAU;MAClBM,SAAS,EAAE;QACTC,KAAK,EAAE;UACL,GAAI,IAAI,CAACP,UAAU,CAACM,SAAS,CAA+BC,KAAK;UACjEH;QACF;MACF;IACF,CAAC;IAEDI,OAAO,CAACC,GAAG,CAACC,mBAAc,CAAC,GAAG,GAAG;IACjCF,OAAO,CAACC,GAAG,CAACE,oBAAe,CAAC,GAAG,IAAI,CAACT,SAAS,GAAG,GAAG,GAAGU,SAAS;IAE/D,MAAMC,MAAM,GAAG,IAAIC,sBAAM,CAACC,aAAI,CAACC,IAAI,CAACC,SAAS,EAAE,oBAAoB,CAAC,EAAE;MACpEC,MAAM,EAAE,IAAI;MACZC,MAAM,EAAE,IAAI;MACZV,GAAG,EAAEW,yBAAS;MACdf;IACF,CAAC,CAAC;IAEF,MAAMgB,UAAU,GAAGA,CAACC,KAAsB,EAAEC,YAAqB,KAAK;MACpE,MAAMC,IAAI,GAAGF,KAAK,CAACG,QAAQ,CAAC,CAAC,CAACC,IAAI,CAAC,CAAC;MACpC,IAAIF,IAAI,EAAE;QACR,IAAI;UACF,MAAMG,GAAG,GAAGC,IAAI,CAACC,KAAK,CAACL,IAAI,CAAC;UAC5B,IAAI,CAACvB,QAAQ,CAACO,OAAO,CAACmB,GAAG,CAAC;QAC5B,CAAC,CAAC,MAAM;UACN,IAAI,CAAC1B,QAAQ,CAACO,OAAO,CAAC;YACpBsB,SAAS,EAAEC,IAAI,CAACC,GAAG,CAAC,CAAC;YACrBC,IAAI,EAAEV,YAAY;YAClBW,MAAM,EAAE,uBAAuB;YAC/BC,OAAO,EAAE,CAACX,IAAI;UAChB,CAAC,CAAC;QACJ;MACF;IACF,CAAC;IAEDX,MAAM,CAACK,MAAM,CAACkB,EAAE,CAAC,MAAM,EAAGd,KAAK,IAAK;MAClCD,UAAU,CAACC,KAAK,EAAE,MAAM,CAAC;IAC3B,CAAC,CAAC;IAEFT,MAAM,CAACM,MAAM,CAACiB,EAAE,CAAC,MAAM,EAAGd,KAAK,IAAK;MAClCD,UAAU,CAACC,KAAK,EAAE,MAAM,CAAC;IAC3B,CAAC,CAAC;IAEF,MAAMe,oBAAoB,GAAIC,KAAa,IAAK;MAC9C,IAAI,CAAC1C,SAAS,CAACQ,QAAQ,CAAC,CAACmC,OAAO,CAAEC,QAAQ,IAAKA,QAAQ,CAACF,KAAK,CAAC,CAAC;MAC/D,IAAI,CAAC1C,SAAS,CAACQ,QAAQ,CAAC,GAAG,EAAE;IAC/B,CAAC;IAEDS,MAAM,CAACuB,EAAE,CACP,SAAS,EAEPK,KAiBK,IACF;MACH,IAAIA,KAAK,CAACC,KAAK,KAAK,MAAM,EAAE;QAC1B,IAAI,CAAC5C,uBAAuB,CAACM,QAAQ,CAAC,GAAG,KAAK;QAC9C,IAAI,CAACT,UAAU,CAACS,QAAQ,CAAC,GAAGqC,KAAK,CAACE,KAAK;QACvC,IAAI,CAACjD,WAAW,CAACU,QAAQ,CAAC,GAAGqC,KAAK,CAACG,MAAM,CAACC,MAAM,CAC9C,CAACC,GAAG,EAAE;UAAEC,QAAQ;UAAEvB,IAAI;UAAEwB;QAAK,CAAC,KAAK;UACjC,MAAMC,KAAK,GAAG;YACZzB,IAAI,EAAE0B,MAAM,CAACC,IAAI,CAAC3B,IAAI,CAAC;YACvBwB;UACF,CAAC;UACD,OAAO;YACL,GAAGF,GAAG;YACN,CAAC,IAAAM,8BAAuB,EAACL,QAAQ,CAAC,GAAGE;UACvC,CAAC;QACH,CAAC,EACD,CAAC,CACH,CAAC;QACDZ,oBAAoB,CAAC,CAAC;QACtB,IAAI,CAACgB,IAAI,CAACZ,KAAK,CAACC,KAAK,EAAE;UAAEtC,QAAQ;UAAEuC,KAAK,EAAEF,KAAK,CAACE;QAAM,CAAC,CAAC;MAC1D,CAAC,MAAM,IAAIF,KAAK,CAACC,KAAK,KAAK,OAAO,EAAE;QAClC,IAAI,CAACW,IAAI,CAACZ,KAAK,CAACC,KAAK,EAAED,KAAK,CAACH,KAAK,CAAC;MACrC,CAAC,MAAM,IAAIG,KAAK,CAACC,KAAK,KAAK,UAAU,EAAE;QACrC,IAAI,CAAC7C,eAAe,CAACO,QAAQ,CAAC,CAACmC,OAAO,CAAEe,YAAY,IAClDA,YAAY,CAAC;UACXC,KAAK,EAAEd,KAAK,CAACc,KAAK;UAClBC,SAAS,EAAEf,KAAK,CAACe;QACnB,CAAC,CACH,CAAC;QACD,IAAI,CAACH,IAAI,CAACZ,KAAK,CAACC,KAAK,EAAE;UACrBa,KAAK,EAAEd,KAAK,CAACc,KAAK;UAClBC,SAAS,EAAEf,KAAK,CAACe,SAAS;UAC1BrB,OAAO,EAAEM,KAAK,CAACN;QACjB,CAAC,CAAC;MACJ,CAAC,MAAM;QACL,IAAI,CAACrC,uBAAuB,CAACM,QAAQ,CAAC,GAAG,IAAI;QAC7C,IAAI,CAACiD,IAAI,CAACZ,KAAK,CAACC,KAAK,EAAE;UAAEtC;QAAS,CAAC,CAAC;MACtC;IACF,CACF,CAAC;IAEDS,MAAM,CAACuB,EAAE,CAAC,OAAO,EAAGE,KAAK,IAAK;MAC5BD,oBAAoB,CAACC,KAAK,CAAC;IAC7B,CAAC,CAAC;IAEFzB,MAAM,CAACuB,EAAE,CAAC,MAAM,EAAGqB,IAAI,IAAK;MAC1BpB,oBAAoB,CAAC,IAAIqB,KAAK,CAAE,iCAAgCD,IAAK,EAAC,CAAC,CAAC;IAC1E,CAAC,CAAC;IAEF,OAAO5C,MAAM;EACf;EAEQ8C,iBAAiBA,CAACvD,QAAgB,EAAEwD,QAAuB,EAAE;IACnE,IAAI,CAACA,QAAQ,EAAE;IACf,IAAI,CAAC/D,eAAe,CAACO,QAAQ,CAAC,GAAG,IAAI,CAACP,eAAe,CAACO,QAAQ,CAAC,IAAI,EAAE;IACrE,IAAI,CAACP,eAAe,CAACO,QAAQ,CAAC,CAACyD,IAAI,CAACD,QAAQ,CAAC;EAC/C;EAEQE,oBAAoBA,CAAC1D,QAAgB,EAAEwD,QAAuB,EAAE;IACtE,IAAI,CAACA,QAAQ,EAAE;IACf,IAAI,CAAC/D,eAAe,CAACO,QAAQ,CAAC,GAAG,IAAI,CAACP,eAAe,CAACO,QAAQ,CAAC,CAAC2D,MAAM,CACnEC,IAAI,IAAKA,IAAI,KAAKJ,QACrB,CAAC;EACH;EAEA,MAAMK,QAAQA,CACZlB,QAAgB,EAChB3C,QAAgB,EAChBkD,YAA2B,EACX;IAChB;IACA,MAAMY,aAAa,GAAG,IAAI,CAACxE,WAAW,CAACU,QAAQ,CAAC,GAAG2C,QAAQ,CAAC;IAC5D,IAAImB,aAAa,EAAE,OAAOA,aAAa;IAEvC,IAAI,CAACP,iBAAiB,CAACvD,QAAQ,EAAEkD,YAAY,CAAC;;IAE9C;IACA,IAAI,CAAC,IAAI,CAAC7D,OAAO,CAACW,QAAQ,CAAC,EAAE;MAC3B,IAAI,CAACX,OAAO,CAACW,QAAQ,CAAC,GAAG,IAAI,CAACD,WAAW,CAACC,QAAQ,CAAC;IACrD,CAAC,MAAM,IAAI,CAAC,IAAI,CAACN,uBAAuB,CAACM,QAAQ,CAAC,EAAE;MAClD,IAAI,CAAC0D,oBAAoB,CAAC1D,QAAQ,EAAEkD,YAAY,CAAC;MACjD,OAAOa,OAAO,CAACC,MAAM,CACnB,IAAIV,KAAK,CACN,QAAOX,QAAS,QAAO3C,QAAS,kCACnC,CACF,CAAC;IACH;IAEA,OAAO,MAAM,IAAI+D,OAAO,CAAQ,CAACE,OAAO,EAAED,MAAM,KAAK;MACnD;MACA,IAAI,CAACxE,SAAS,CAACQ,QAAQ,CAAC,GAAG,CAAC,IAAI,CAACR,SAAS,CAACQ,QAAQ,CAAC,IAAI,EAAE,EAAEkE,MAAM,CAC/DhC,KAAa,IAAK;QACjB,IAAI,CAACwB,oBAAoB,CAAC1D,QAAQ,EAAEkD,YAAY,CAAC;QAEjD,IAAIhB,KAAK,EAAE;UACT8B,MAAM,CAAC9B,KAAK,CAAC;QACf,CAAC,MAAM;UACL,MAAM4B,aAAa,GAAG,IAAI,CAACxE,WAAW,CAACU,QAAQ,CAAC,GAAG2C,QAAQ,CAAC;UAC5D,IAAImB,aAAa,EAAE;YACjBG,OAAO,CAACH,aAAa,CAAC;UACxB,CAAC,MAAM;YACLE,MAAM,CACJ,IAAIV,KAAK,CACN,QAAOX,QAAS,QAAO3C,QAAS,kCACnC,CACF,CAAC;UACH;QACF;MACF,CACF,CAAC;IACH,CAAC,CAAC;EACJ;EAEA,MAAMmE,SAASA,CACbxB,QAAgB,EAChB3C,QAAiB,EACS;IAC1B,IAAI,UAAU,CAACoE,IAAI,CAACzB,QAAQ,CAAC,IAAI3C,QAAQ,EAAE;MACzC,OAAO,CAAC,MAAM,IAAI,CAAC6D,QAAQ,CAAClB,QAAQ,EAAE3C,QAAQ,CAAC,EAAEoB,IAAI;IACvD;IAEA,OAAOiD,WAAE,CAACC,QAAQ,CAACC,QAAQ,CACzB5D,aAAI,CAACC,IAAI,CAAC,IAAI,CAAChB,UAAU,CAAC4E,MAAM,CAACC,IAAI,EAAE9B,QAAQ,CAAC,EAChD,MACF,CAAC;EACH;EAEA,MAAM+B,YAAYA,CAChB/B,QAAgB,EAChB3C,QAAgB,EACU;IAC1B,MAAM;MAAE4C;IAAK,CAAC,GAAG,MAAM,IAAI,CAACiB,QAAQ,CAAClB,QAAQ,EAAE3C,QAAQ,CAAC;IACxD,MAAM2E,iBAAiB,GAAG/B,IAAI,CAACgC,OAAO,EAAEC,SAA+B;IAEvE,IAAIF,iBAAiB,EAAE;MACrB,OAAO,CAAC,MAAM,IAAI,CAACd,QAAQ,CAACc,iBAAiB,EAAE3E,QAAQ,CAAC,EAAEoB,IAAI;IAChE;IAEA,OAAO2C,OAAO,CAACC,MAAM,CACnB,IAAIV,KAAK,CAAE,kBAAiBX,QAAS,QAAO3C,QAAS,aAAY,CACnE,CAAC;EACH;EAEA8E,WAAWA,CAACnC,QAAgB,EAAE;IAC5B,IAAIA,QAAQ,CAACoC,QAAQ,CAAC,SAAS,CAAC,EAAE;MAChC,OAAO,iBAAiB;IAC1B;IAEA,OAAOC,kBAAS,CAACC,MAAM,CAACtC,QAAQ,CAAC,IAAI,YAAY;EACnD;AACF;AAACuC,OAAA,CAAA/F,QAAA,GAAAA,QAAA","ignoreList":[]}