{"version":3,"file":"ModuleFederationPlugin.js","names":["ModuleFederationPlugin","constructor","config","replaceRemotes","remote","startsWith","Federated","createRemote","Array","isArray","map","remoteItem","replaced","key","value","external","apply","compiler","remotes","container","filename","exposes","name","undefined","library","type","shared","react","SHARED_REACT","SHARED_REACT_NATIVE"],"sources":["../../../src/webpack/plugins/ModuleFederationPlugin.ts"],"sourcesContent":["import { Compiler, container } from 'webpack';\nimport type { WebpackPlugin } from '../../types';\nimport { Federated } from '../federated';\n\ntype ModuleFederationPluginOptions =\n  typeof container.ModuleFederationPlugin extends {\n    new (options: infer O): InstanceType<\n      typeof container.ModuleFederationPlugin\n    >;\n  }\n    ? O\n    : never;\n\ntype ExtractRemotesObject<T> = T extends {}\n  ? T extends Array<any>\n    ? never\n    : T\n  : never;\n\ntype RemotesObject = ExtractRemotesObject<\n  ModuleFederationPluginOptions['remotes']\n>;\n\n/**\n * {@link ModuleFederationPlugin} configuration options.\n *\n * The fields and types are exactly the same as in `webpack.container.ModuleFederationPlugin`.\n *\n * You can check documentation for all supported options here: https://webpack.js.org/plugins/module-federation-plugin/\n */\nexport interface ModuleFederationPluginConfig\n  extends ModuleFederationPluginOptions {}\n\n/**\n * Webpack plugin to configure Module Federation with platform differences\n * handled under the hood.\n *\n * Usually, you should use `Repack.plugin.ModuleFederationPlugin`\n * instead of `webpack.container.ModuleFederationPlugin`.\n *\n * `Repack.plugin.ModuleFederationPlugin` creates:\n * - default for `filename` option when `exposes` is defined\n * - default for `library` option when `exposes` is defined\n * - default for `shared` option with `react` and `react-native` dependencies\n * - converts `remotes` into `ScriptManager`-powered `promise new Promise` loaders\n *\n * You can overwrite all defaults by passing respective options.\n *\n * `remotes` will always be converted to ScriptManager`-powered `promise new Promise` loaders\n * using {@link Federated.createRemote}.\n *\n * @example Host example.\n * ```js\n * import * as Repack from '@callstack/repack';\n *\n * new Repack.plugins.ModuleFederationPlugin({\n *   name: 'host,\n * });\n * ```\n *\n * @example Host example with additional `shared` dependencies.\n * ```js\n * import * as Repack from '@callstack/repack';\n *\n * new Repack.plugins.ModuleFederationPlugin({\n *   name: 'host,\n *   shared: {\n *     react: Repack.Federated.SHARED_REACT,\n *     'react-native': Repack.Federated.SHARED_REACT,\n *     'react-native-reanimated': {\n *       singleton: true,\n *     },\n *   },\n * });\n * ```\n *\n * @example Container examples.\n * ```js\n * import * as Repack from '@callstack/repack';\n *\n * new Repack.plugins.ModuleFederationPlugin({\n *   name: 'app1',\n *   remotes: {\n *     module1: 'module1@https://example.com/module1.container.bundle',\n *   },\n * });\n *\n * new Repack.plugins.ModuleFederationPlugin({\n *   name: 'app2',\n *   remotes: {\n *     module1: 'module1@https://example.com/module1.container.bundle',\n *     module2: 'module1@dynamic',\n *   },\n * });\n * ```\n *\n * @category Webpack Plugin\n */\nexport class ModuleFederationPlugin implements WebpackPlugin {\n  constructor(private config: ModuleFederationPluginConfig) {}\n\n  private replaceRemotes<T extends string | string[] | RemotesObject>(\n    remote: T\n  ): T {\n    if (typeof remote === 'string') {\n      return remote.startsWith('promise new Promise')\n        ? remote\n        : (Federated.createRemote(remote) as T);\n    }\n\n    if (Array.isArray(remote)) {\n      return remote.map((remoteItem) => this.replaceRemotes(remoteItem)) as T;\n    }\n\n    const replaced = {} as RemotesObject;\n    for (const key in remote as RemotesObject) {\n      const value = remote[key];\n      if (typeof value === 'string' || Array.isArray(value)) {\n        replaced[key] = this.replaceRemotes(value);\n      } else {\n        replaced[key] = {\n          ...value,\n          external: this.replaceRemotes(value.external),\n        };\n      }\n    }\n\n    return replaced as T;\n  }\n\n  /**\n   * Apply the plugin.\n   *\n   * @param compiler Webpack compiler instance.\n   */\n  apply(compiler: Compiler) {\n    const remotes = Array.isArray(this.config.remotes)\n      ? this.config.remotes.map((remote) => this.replaceRemotes(remote))\n      : this.replaceRemotes(this.config.remotes ?? {});\n\n    new container.ModuleFederationPlugin({\n      ...this.config,\n      filename:\n        this.config.filename ?? this.config.exposes\n          ? `${this.config.name}.container.bundle`\n          : undefined,\n      library: this.config.exposes\n        ? {\n            name: this.config.name,\n            type: 'self',\n            ...this.config.library,\n          }\n        : undefined,\n      shared: this.config.shared ?? {\n        react: Federated.SHARED_REACT,\n        'react-native': Federated.SHARED_REACT_NATIVE,\n      },\n      remotes,\n    }).apply(compiler);\n  }\n}\n"],"mappings":";;;;;;;AAAA;;AAEA;;AA+BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACO,MAAMA,sBAAN,CAAsD;EAC3DC,WAAW,CAASC,MAAT,EAA+C;IAAA,KAAtCA,MAAsC,GAAtCA,MAAsC;EAAE;;EAEpDC,cAAc,CACpBC,MADoB,EAEjB;IACH,IAAI,OAAOA,MAAP,KAAkB,QAAtB,EAAgC;MAC9B,OAAOA,MAAM,CAACC,UAAP,CAAkB,qBAAlB,IACHD,MADG,GAEFE,oBAAA,CAAUC,YAAV,CAAuBH,MAAvB,CAFL;IAGD;;IAED,IAAII,KAAK,CAACC,OAAN,CAAcL,MAAd,CAAJ,EAA2B;MACzB,OAAOA,MAAM,CAACM,GAAP,CAAYC,UAAD,IAAgB,KAAKR,cAAL,CAAoBQ,UAApB,CAA3B,CAAP;IACD;;IAED,MAAMC,QAAQ,GAAG,EAAjB;;IACA,KAAK,MAAMC,GAAX,IAAkBT,MAAlB,EAA2C;MACzC,MAAMU,KAAK,GAAGV,MAAM,CAACS,GAAD,CAApB;;MACA,IAAI,OAAOC,KAAP,KAAiB,QAAjB,IAA6BN,KAAK,CAACC,OAAN,CAAcK,KAAd,CAAjC,EAAuD;QACrDF,QAAQ,CAACC,GAAD,CAAR,GAAgB,KAAKV,cAAL,CAAoBW,KAApB,CAAhB;MACD,CAFD,MAEO;QACLF,QAAQ,CAACC,GAAD,CAAR,GAAgB,EACd,GAAGC,KADW;UAEdC,QAAQ,EAAE,KAAKZ,cAAL,CAAoBW,KAAK,CAACC,QAA1B;QAFI,CAAhB;MAID;IACF;;IAED,OAAOH,QAAP;EACD;EAED;AACF;AACA;AACA;AACA;;;EACEI,KAAK,CAACC,QAAD,EAAqB;IACxB,MAAMC,OAAO,GAAGV,KAAK,CAACC,OAAN,CAAc,KAAKP,MAAL,CAAYgB,OAA1B,IACZ,KAAKhB,MAAL,CAAYgB,OAAZ,CAAoBR,GAApB,CAAyBN,MAAD,IAAY,KAAKD,cAAL,CAAoBC,MAApB,CAApC,CADY,GAEZ,KAAKD,cAAL,CAAoB,KAAKD,MAAL,CAAYgB,OAAZ,IAAuB,EAA3C,CAFJ;IAIA,IAAIC,kBAAA,CAAUnB,sBAAd,CAAqC,EACnC,GAAG,KAAKE,MAD2B;MAEnCkB,QAAQ,EACN,KAAKlB,MAAL,CAAYkB,QAAZ,IAAwB,KAAKlB,MAAL,CAAYmB,OAApC,GACK,GAAE,KAAKnB,MAAL,CAAYoB,IAAK,mBADxB,GAEIC,SAL6B;MAMnCC,OAAO,EAAE,KAAKtB,MAAL,CAAYmB,OAAZ,GACL;QACEC,IAAI,EAAE,KAAKpB,MAAL,CAAYoB,IADpB;QAEEG,IAAI,EAAE,MAFR;QAGE,GAAG,KAAKvB,MAAL,CAAYsB;MAHjB,CADK,GAMLD,SAZ+B;MAanCG,MAAM,EAAE,KAAKxB,MAAL,CAAYwB,MAAZ,IAAsB;QAC5BC,KAAK,EAAErB,oBAAA,CAAUsB,YADW;QAE5B,gBAAgBtB,oBAAA,CAAUuB;MAFE,CAbK;MAiBnCX;IAjBmC,CAArC,EAkBGF,KAlBH,CAkBSC,QAlBT;EAmBD;;AA7D0D"}