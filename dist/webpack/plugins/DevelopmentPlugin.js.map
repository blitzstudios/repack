{"version":3,"file":"DevelopmentPlugin.js","names":["_webpack","_interopRequireDefault","require","_reactRefreshWebpackPlugin","obj","__esModule","default","DevelopmentPlugin","constructor","config","apply","compiler","logger","getInfrastructureLogger","devServer","webpack","DefinePlugin","__PUBLIC_PORT__","JSON","stringify","port","__PLATFORM__","platform","__LISTENER_IP__","listenerIP","hmr","HotModuleReplacementPlugin","ReactRefreshPlugin","overlay","getAdjustedEntry","entry","refreshEntryPath","key","import","entryImports","hmrClientIndex","findIndex","value","test","splice","reactRefreshEntryPath","resolve","options","getEntry","hooks","make","tapAsync","compilation","callback","globalEntryDeps","globalEntry","dependencies","refreshEntryIndex","request","experiments","lazyCompilation","entries","initialize","tap","error","ProvidePlugin","EventSource","exports"],"sources":["../../../src/webpack/plugins/DevelopmentPlugin.ts"],"sourcesContent":["import webpack from 'webpack';\nimport ReactRefreshPlugin from '@pmmmwh/react-refresh-webpack-plugin';\nimport type { DevServerOptions, WebpackPlugin } from '../../types';\n\ntype ExtractEntryStaticNormalized<E> = E extends () => Promise<infer U>\n  ? U\n  : E extends { [key: string]: any }\n    ? E\n    : never;\n\ntype EntryStaticNormalized =\n  ExtractEntryStaticNormalized<webpack.EntryNormalized>;\n\ntype ModuleDependency = webpack.dependencies.ModuleDependency;\n/**\n * {@link DevelopmentPlugin} configuration options.\n */\nexport interface DevelopmentPluginConfig {\n  platform: string;\n  devServer?: DevServerOptions;\n  listenerIP?: string;\n}\n\n/**\n * Class for running development server that handles serving the built bundle, all assets as well as\n * providing Hot Module Replacement functionality.\n *\n * @category Webpack Plugin\n */\nexport class DevelopmentPlugin implements WebpackPlugin {\n  /**\n   * Constructs new `DevelopmentPlugin`.\n   *\n   * @param config Plugin configuration options.\n   */\n  constructor(private config?: DevelopmentPluginConfig) {}\n\n  /**\n   * Apply the plugin.\n   *\n   * @param compiler Webpack compiler instance.\n   */\n  apply(compiler: webpack.Compiler) {\n    const logger = compiler.getInfrastructureLogger('DevelopmentPlugin');\n\n    if (!this.config?.devServer) {\n      return;\n    }\n\n    new webpack.DefinePlugin({\n      __PUBLIC_PORT__: JSON.stringify(this.config.devServer.port),\n      __PLATFORM__: JSON.stringify(this.config.platform),\n      __LISTENER_IP__: JSON.stringify(this.config.listenerIP),\n    }).apply(compiler);\n\n    if (this.config?.devServer.hmr) {\n      new webpack.HotModuleReplacementPlugin().apply(compiler);\n      new ReactRefreshPlugin({\n        overlay: false,\n      }).apply(compiler);\n\n      // To avoid the problem from https://github.com/facebook/react/issues/20377\n      // we need to move React Refresh entry that `ReactRefreshPlugin` injects to evaluate right\n      // before the `WebpackHMRClient` and after `InitializeCore` which sets up React DevTools.\n      // Thanks to that the initialization order is correct:\n      // 0. Polyfills\n      // 1. `InitilizeCore` -> React DevTools\n      // 2. Rect Refresh Entry\n      // 3. `WebpackHMRClient`\n      // NOTE: This needs to be done before compilation begins\n      const getAdjustedEntry = (\n        entry: EntryStaticNormalized,\n        refreshEntryPath: string\n      ) => {\n        for (const key in entry) {\n          const { import: entryImports = [] } = entry[key];\n          const hmrClientIndex = entryImports.findIndex((value) =>\n            /WebpackHMRClient\\.js/.test(value)\n          );\n          if (hmrClientIndex >= 0) {\n            entryImports.splice(hmrClientIndex, 0, refreshEntryPath);\n            entry[key].import = entryImports;\n          }\n        }\n        return entry;\n      };\n\n      // To modify the entry before compilation\n      // we need to obtain the path to ReactRefreshEntry.js manually\n      const reactRefreshEntryPath = require.resolve(\n        '@pmmmwh/react-refresh-webpack-plugin/client/ReactRefreshEntry.js'\n      );\n\n      if (typeof compiler.options.entry !== 'function') {\n        compiler.options.entry = getAdjustedEntry(\n          compiler.options.entry,\n          reactRefreshEntryPath\n        );\n      } else {\n        const getEntry = compiler.options.entry;\n        compiler.options.entry = async () => {\n          const entry = await getEntry();\n          return getAdjustedEntry(entry, reactRefreshEntryPath);\n        };\n      }\n\n      compiler.hooks.make.tapAsync(\n        'RemoveOriginalReactRefreshEntry',\n        (compilation, callback) => {\n          const globalEntryDeps = compilation.globalEntry\n            .dependencies as ModuleDependency[];\n          const refreshEntryIndex = globalEntryDeps.findIndex((value) =>\n            /ReactRefreshEntry\\.js/.test(value.request)\n          );\n          if (refreshEntryIndex >= 0) {\n            globalEntryDeps.splice(refreshEntryIndex, 1);\n          }\n          callback(null);\n        }\n      );\n    }\n\n    if (compiler.options.experiments?.lazyCompilation) {\n      if (compiler.options.experiments.lazyCompilation.entries !== false) {\n        compiler.hooks.initialize.tap('DevelopmentPlugin', () => {\n          logger.error(\n            'You have enabled lazyCompilation for entrypoints which is not supported. ' +\n              'Lazy compilation is supported only for dynamic imports. ' +\n              'You can fix this by adding { entries: false } to experiments.lazyCompilation configuration object inside webpack.config.'\n          );\n        });\n      }\n\n      try {\n        require.resolve('react-native-event-source');\n      } catch (error) {\n        compiler.hooks.initialize.tap('DevelopmentPlugin', () => {\n          logger.error(\n            \"You have enabled lazyCompilation but 'react-native-event-source' was not found in your devDependencies. \" +\n              'Please install it via your package manager and try again.'\n          );\n        });\n      }\n\n      new webpack.ProvidePlugin({\n        EventSource: ['react-native-event-source', 'default'],\n      }).apply(compiler);\n    }\n  }\n}\n"],"mappings":"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","ignoreList":[]}