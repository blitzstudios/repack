{"version":3,"file":"DevelopmentPlugin.js","names":["DevelopmentPlugin","constructor","config","apply","compiler","devServer","webpack","DefinePlugin","__PUBLIC_PORT__","JSON","stringify","port","__PLATFORM__","platform","hmr","HotModuleReplacementPlugin","ReactRefreshPlugin","overlay","getAdjustedEntry","entry","key","import","entryImports","refreshEntryIndex","findIndex","value","test","refreshEntry","splice","hmrClientIndex","options","getEntry"],"sources":["../../../src/webpack/plugins/DevelopmentPlugin.ts"],"sourcesContent":["import webpack from 'webpack';\nimport ReactRefreshPlugin from '@pmmmwh/react-refresh-webpack-plugin';\nimport type { DevServerOptions, WebpackPlugin } from '../../types';\n\ntype ExtractEntryStaticNormalized<E> = E extends () => Promise<infer U>\n  ? U\n  : E extends { [key: string]: any }\n  ? E\n  : never;\n\ntype EntryStaticNormalized =\n  ExtractEntryStaticNormalized<webpack.EntryNormalized>;\n\n/**\n * {@link DevelopmentPlugin} configuration options.\n */\nexport interface DevelopmentPluginConfig {\n  platform: string;\n  devServer?: DevServerOptions;\n}\n\n/**\n * Class for running development server that handles serving the built bundle, all assets as well as\n * providing Hot Module Replacement functionality.\n *\n * @category Webpack Plugin\n */\nexport class DevelopmentPlugin implements WebpackPlugin {\n  /**\n   * Constructs new `DevelopmentPlugin`.\n   *\n   * @param config Plugin configuration options.\n   */\n  constructor(private config?: DevelopmentPluginConfig) {}\n\n  /**\n   * Apply the plugin.\n   *\n   * @param compiler Webpack compiler instance.\n   */\n  apply(compiler: webpack.Compiler) {\n    if (!this.config?.devServer) {\n      return;\n    }\n\n    new webpack.DefinePlugin({\n      __PUBLIC_PORT__: JSON.stringify(this.config.devServer.port),\n      __PLATFORM__: JSON.stringify(this.config.platform),\n    }).apply(compiler);\n\n    if (this.config?.devServer.hmr) {\n      new webpack.HotModuleReplacementPlugin().apply(compiler);\n      new ReactRefreshPlugin({\n        overlay: false,\n      }).apply(compiler);\n\n      // To avoid the problem from https://github.com/facebook/react/issues/20377\n      // we need to move React Refresh entry that `ReactRefreshPlugin` injects to evaluate right\n      // before the `WebpackHMRClient` and after `InitializeCore` which sets up React DevTools.\n      // Thanks to that the initialization order is correct:\n      // 0. Polyfills\n      // 1. `InitilizeCore` -> React DevTools\n      // 2. Rect Refresh Entry\n      // 3. `WebpackHMRClient`\n      const getAdjustedEntry = (entry: EntryStaticNormalized) => {\n        for (const key in entry) {\n          const { import: entryImports = [] } = entry[key];\n          const refreshEntryIndex = entryImports.findIndex((value) =>\n            /ReactRefreshEntry\\.js/.test(value)\n          );\n          if (refreshEntryIndex >= 0) {\n            const refreshEntry = entryImports[refreshEntryIndex];\n            entryImports.splice(refreshEntryIndex, 1);\n\n            const hmrClientIndex = entryImports.findIndex((value) =>\n              /WebpackHMRClient\\.js/.test(value)\n            );\n            entryImports.splice(hmrClientIndex, 0, refreshEntry);\n          }\n          entry[key].import = entryImports;\n        }\n\n        return entry;\n      };\n\n      if (typeof compiler.options.entry !== 'function') {\n        compiler.options.entry = getAdjustedEntry(compiler.options.entry);\n      } else {\n        const getEntry = compiler.options.entry;\n        compiler.options.entry = async () => {\n          const entry = await getEntry();\n          return getAdjustedEntry(entry);\n        };\n      }\n    }\n  }\n}\n"],"mappings":";;;;;;;AAAA;;AACA;;;;AAoBA;AACA;AACA;AACA;AACA;AACA;AACO,MAAMA,iBAAN,CAAiD;EACtD;AACF;AACA;AACA;AACA;EACEC,WAAW,CAASC,MAAT,EAA2C;IAAA,KAAlCA,MAAkC,GAAlCA,MAAkC;EAAE;EAExD;AACF;AACA;AACA;AACA;;;EACEC,KAAK,CAACC,QAAD,EAA6B;IAAA;;IAChC,IAAI,kBAAC,KAAKF,MAAN,yCAAC,aAAaG,SAAd,CAAJ,EAA6B;MAC3B;IACD;;IAED,IAAIC,gBAAA,CAAQC,YAAZ,CAAyB;MACvBC,eAAe,EAAEC,IAAI,CAACC,SAAL,CAAe,KAAKR,MAAL,CAAYG,SAAZ,CAAsBM,IAArC,CADM;MAEvBC,YAAY,EAAEH,IAAI,CAACC,SAAL,CAAe,KAAKR,MAAL,CAAYW,QAA3B;IAFS,CAAzB,EAGGV,KAHH,CAGSC,QAHT;;IAKA,qBAAI,KAAKF,MAAT,0CAAI,cAAaG,SAAb,CAAuBS,GAA3B,EAAgC;MAC9B,IAAIR,gBAAA,CAAQS,0BAAZ,GAAyCZ,KAAzC,CAA+CC,QAA/C;MACA,IAAIY,kCAAJ,CAAuB;QACrBC,OAAO,EAAE;MADY,CAAvB,EAEGd,KAFH,CAESC,QAFT,EAF8B,CAM9B;MACA;MACA;MACA;MACA;MACA;MACA;MACA;;MACA,MAAMc,gBAAgB,GAAIC,KAAD,IAAkC;QACzD,KAAK,MAAMC,GAAX,IAAkBD,KAAlB,EAAyB;UACvB,MAAM;YAAEE,MAAM,EAAEC,YAAY,GAAG;UAAzB,IAAgCH,KAAK,CAACC,GAAD,CAA3C;UACA,MAAMG,iBAAiB,GAAGD,YAAY,CAACE,SAAb,CAAwBC,KAAD,IAC/C,wBAAwBC,IAAxB,CAA6BD,KAA7B,CADwB,CAA1B;;UAGA,IAAIF,iBAAiB,IAAI,CAAzB,EAA4B;YAC1B,MAAMI,YAAY,GAAGL,YAAY,CAACC,iBAAD,CAAjC;YACAD,YAAY,CAACM,MAAb,CAAoBL,iBAApB,EAAuC,CAAvC;YAEA,MAAMM,cAAc,GAAGP,YAAY,CAACE,SAAb,CAAwBC,KAAD,IAC5C,uBAAuBC,IAAvB,CAA4BD,KAA5B,CADqB,CAAvB;YAGAH,YAAY,CAACM,MAAb,CAAoBC,cAApB,EAAoC,CAApC,EAAuCF,YAAvC;UACD;;UACDR,KAAK,CAACC,GAAD,CAAL,CAAWC,MAAX,GAAoBC,YAApB;QACD;;QAED,OAAOH,KAAP;MACD,CAnBD;;MAqBA,IAAI,OAAOf,QAAQ,CAAC0B,OAAT,CAAiBX,KAAxB,KAAkC,UAAtC,EAAkD;QAChDf,QAAQ,CAAC0B,OAAT,CAAiBX,KAAjB,GAAyBD,gBAAgB,CAACd,QAAQ,CAAC0B,OAAT,CAAiBX,KAAlB,CAAzC;MACD,CAFD,MAEO;QACL,MAAMY,QAAQ,GAAG3B,QAAQ,CAAC0B,OAAT,CAAiBX,KAAlC;;QACAf,QAAQ,CAAC0B,OAAT,CAAiBX,KAAjB,GAAyB,YAAY;UACnC,MAAMA,KAAK,GAAG,MAAMY,QAAQ,EAA5B;UACA,OAAOb,gBAAgB,CAACC,KAAD,CAAvB;QACD,CAHD;MAID;IACF;EACF;;AApEqD"}